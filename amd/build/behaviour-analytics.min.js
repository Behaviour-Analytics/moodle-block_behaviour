/*! moodle-block_behaviour v0.7.1 17-01-2021 */
!function(a){"function"==typeof define&&define.amd?define([],a):window.behaviourAnalytics=a()}(function(){return function(a){function b(a){tb=a.logs,ub=a.users,vb=a.mods,wb=a.panelwidth,xb=a.legendwidth,yb=a.name,zb=a.iframeurl,Wc=a.version36,Xc=a.showstudentnames,Ab=a.positioning,Bb=a.positioning,Cb=a.nodecoords,Db=a.links,Fb=a.courseid,Gb=a.userid,Eb=a.scale,Hb=a.graphs,Ib=a.alllinks,Jb=a.scales,Kb=a.changes,Lb=a.names,Mb=a.allmods,Nb=a.setnames,Ob=Gb,Pb=a.lastchange,Qb=a.comments,Tb=a.strings,ob=a.coordsscript,pb=a.clustersscript,qb=a.commentsscript,rb=a.manualscript,sb=a.deletescript,Ub=a.sesskey,fd=a.gotallnodes,oc=a.replaying,md=a.debugcentroids,nd=a.centroids,jd=a.isresearcher,id=Gb,Vb=window.dataDrivenDocs,Xb=window.noUiSlider;var b=window.mersenneTwister;Yb=new b(259),Cc=0,Bc=c(),Zc=Date.now()+3e3,ed=1e3,Wb=Vb.transition().duration(ed).ease(Vb.easeLinear),wc=120,Yc=1,hc=1e-4,ec=1,bd=J,Jc=!1,Kc=220,Mc=.15,Lc=Vb.curveCatmullRomClosed,ld=!0,zc={},dd={},Dc={originalLinks:"lightgrey",grouping:"black",assign:"blue",quiz:"red",forum:"orange",resource:"green",lti:"yellow",url:"purple",book:"magenta",page:"cyan",lesson:"brown",data:"coral",chat:"maroon",choice:"grey",feedback:"lime",glossary:"navy",survey:"tan",wiki:"teal",workshop:"silver",scorm:"tomato",imscp:"lightpink",folder:"peru"},Ec=["blue","red","orange","green","yellow","brown","purple","magenta","cyan"],mc=Ab?0:36,wb=Ab?0:wb,$b=window.innerWidth-wc-xb-150,_b=window.innerHeight-mc-90,cd=Math.min($b,_b)<500?6:8,Rb={},ub.forEach(function(a){Rb[a.id]=a.realId}),d(),e(),oc?_(a.replaydata,a.manualdata):Ab?h():j()}function c(){return["aqua","blue","blueviolet","brown","cadetblue","chartreuse","chocolate","coral","cornflowerblue","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgrey","darkgreen","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgrey","dodgerblue","firebrick","forestgreen","fuchsia","gold","goldenrod","grey","green","greenyellow","hotpink","indianred","indigo","khaki","lawngreen","lightblue","lightcoral","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategrey","lightsteelblue","lime","limegreen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","navy","olive","olivedrab","orange","orangered","orchid","palegreen","paleturquoise","palevioletred","peru","plum","powderblue","purple","rebeccapurple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","sienna","silver","skyblue","slateblue","slategrey","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","yellow","yellowgreen"]}function d(){vb.forEach(function(a){for(;!Dc[a.entype];){var b=Bc[Math.floor(Yb.random()*Bc.length)],c=!0;for(var d in Dc)Dc[d]==b&&(c=!1);Dc[a.entype]=c?b:void 0}})}function e(){ic={nodes:[],links:[],edges:{},maxSession:0},f(),g()}function f(){var a,b,c,d=ic,e={};vb.forEach(function(f){a=!0,b=void 0,c=void 0,Cb[f.id]?(a=1==Cb[f.id].visible&&1==Cb["g"+f.sect].visible,1!=Cb[f.id].visible||a||(Cb[f.id].visible=0),b=Cb[f.id].xcoord,c=Cb[f.id].ycoord):Cb["g"+f.sect]&&(a=1==Cb["g"+f.sect].visible&&Gb==Ob),d.nodes[d.nodes.length]={id:f.id,name:f.name,group:f.sect,type:f.type,entype:f.entype,colour:Dc[f.entype],visible:a,xcoord:b,ycoord:c},e[f.sect]||(Cb["g"+f.sect]&&(a=1==Cb["g"+f.sect].visible,b=Cb["g"+f.sect].xcoord,c=Cb["g"+f.sect].ycoord),e[f.sect]={id:"g"+f.sect,name:Tb.section+" "+f.sect,group:f.sect,type:"grouping",colour:Dc.grouping,visible:a,xcoord:b,ycoord:c},d.nodes[d.nodes.length]=e[f.sect]),d.links[d.links.length]={source:"g"+f.sect,target:f.id,weight:ec,colour:Dc.originalLinks}}),b=c=void 0,Cb.root&&(b=Cb.root.xcoord,c=Cb.root.ycoord);var f={id:"root",name:yb,group:-1,type:"grouping",colour:Dc.grouping,visible:!0,xcoord:b,ycoord:c};if(Object.keys(e).length>1)for(var g in e)d.links[d.links.length]={source:"root",target:e[g].id,weight:ec,colour:Dc.originalLinks};else d.nodes=d.nodes.filter(function(a){return"g0"!=a.id}),d.links.forEach(function(a){"g0"==a.source&&(a.source="root")});if(d.nodes[d.nodes.length]=f,Object.keys(Db).length>0){var h,i,j;for(var k in Db)j=k.split("_"),h=j[0],i=j[1],d.links[d.links.length]={source:h,target:i,weight:5*Db[k],colour:Dc.originalLinks};if(!Bb)for(var l in d.nodes)isNaN(d.nodes[l].id)&&(d.nodes[l].visible=!1)}}function g(){var a,b=ic,c=0,d=0;kd={};for(var e=0;e<tb.length;e++)a={source:tb[e].moduleId,target:tb[e].moduleId,weight:ec,user:tb[e].userId,colour:""},b.edges[tb[e].userId]||(b.edges[tb[e].userId]=[],kd[tb[e].userId]=[],b.maxSession=b.maxSession<c?c:b.maxSession,c=0,d=0),Cb[tb[e].moduleId]&&1==Cb[tb[e].moduleId].visible&&(kd[tb[e].userId][d++]=tb[e].moduleId),e+1<tb.length&&tb[e].userId==tb[e+1].userId?(a.target=tb[e+1].moduleId,b.edges[tb[e].userId][c++]=a):0==b.edges[tb[e].userId].length&&(b.edges[tb[e].userId][c++]=a);b.maxSession=b.maxSession<c?c:b.maxSession,ub.forEach(function(a){b.edges[a.id]||(b.edges[a.id]=[])})}function h(){Fc=!1,fc=.01,gc=.01,$c=K,_c=L,ad=M,fd&&Object.keys(Cb).length>0&&(ec=0),Hb&&Jb&&y(),k(.6),D(),i(),setTimeout(function(){ac.force("charge",null).force("x",null).force("y",null)},500)}function i(){var a=document.getElementById("student-menu"),b=document.createElement("input");b.id="weight-slider",b.type="range",b.min="-0.2",b.max="2",b.step="0.2",b.value="0.6",b.style.width="130px",b.addEventListener("change",function(){dc.strength(this.value),document.getElementById("weights-output").innerHTML="&nbsp;= "+this.value}),a.appendChild(b);var c=document.createTextNode(Tb.linksweight);a.appendChild(c),c=document.createElement("label"),c.id="weights-output",c.innerHTML="&nbsp;= "+b.value,a.appendChild(c)}function j(){Fc=!0,Ab=!0,fc=0,$c=null,_c=null,ad=null,fd&&0!=Object.keys(Cb).length?(N(),k(0),P()):(k(.6),setTimeout(function(){N(),P()},500)),dc=null}function k(a){Zb=Vb.select("#graph").append("svg").attr("width",$b).attr("height",_b),dc=Vb.forceLink(ic.links).id(function(a){return a.id}).strength(a),ac=Vb.forceSimulation(ic.nodes).force("link",dc).force("charge",Vb.forceManyBody().strength(-80)).force("collide",Vb.forceCollide().radius(12)).force("center",Vb.forceCenter($b/2,_b/2)).force("x",Vb.forceX()).force("y",Vb.forceY()),l(ic.nodes,bd,$c,_c,ad),m(ic.links),Zb.on("click",function(){Vb.selectAll("#rctext").remove(),Vb.selectAll("#rcrect").remove(),(Fc||Ab)&&bc.on("mouseover",n).on("mouseout",q),oc&&bc.on("mouseover",null).on("mouseout",null)}),fd&&Ab&&Object.keys(Cb).length>0?ac.on("tick",s):ac.on("tick",t);for(var b=0;b<80;b++)ac.tick();Ab&&setTimeout(function(){ac.stop(),ac.on("tick",t),u(),0!=Object.keys(Cb).length&&fd||(v(),ic.edges={},g(),fd=!0,ec=Fc?1:0)},500),Fc&&!fd&&setTimeout(function(){ic.nodes=[],ic.links=[],f()},600)}function l(a,b,c,d,e){bc=Zb.selectAll(".node").data(a).enter().append("circle").attr("class","node").attr("r",cd).on("mouseover",n).on("mouseout",q).on("contextmenu",b).call(Vb.drag().on("start",c).on("drag",d).on("end",e))}function m(a){cc=Zb.selectAll(".link").data(a).enter().append("line").attr("class","link").style("stroke",function(a){return a.colour}).style("stroke-width",function(a){return 2*a.weight+"px"})}function n(a,b){if(!(Sc||(bc.on("mouseover",null),b||(Vb.selectAll(".text").remove(),Vb.selectAll("rect").remove()),Date.now()-Zc<150))){var c=[0],d=!1,e=!1,f=!1,g=150,h=304,i=154,j=a.type+": "+a.name;Tc&&(h=0,i=0);var k=Zb.append("text").attr("class","text").attr("id","t-"+a.id).attr("y",a.y+32).attr("dy",".40em").style("pointer-events","none").text(j).call(o,g,a.x-(g+6)/2+8,c),l=16*c[0]+16;l+a.y>=_b-i&&(k.attr("y",_b-l-(_b-a.y)).text(j).call(o,g,a.x-(g+6)/2+8,c),d=!0),a.x<=h/2?(k.text(j).call(o,g,a.x+8,c),f=!0):a.x>=$b-h/2&&(k.text(j).call(o,g,a.x-(g+6)+8,c),e=!0);var m;m=f?a.x:e?a.x-(g+6):a.x-(g+6)/2;var n=Zb.append("rect").attr("id","r-"+a.id).attr("x",m).attr("y",d?_b-l-16-(_b-a.y):a.y+16).attr("width",g+16).attr("height",l).style("stroke","black").style("fill","yellow");k.raise(),isNaN(a.id)||(Tc&&(h=400,i=300),p(a,l,g,h,i,d,f,e,parseInt(n.attr("x")),parseInt(n.attr("y"))))}}function o(a,b,c,d){var e=0;a.each(function(){var a,d=Vb.select(this),f=d.text().split(/\s+/).reverse(),g=[],h=d.attr("y"),i=parseFloat(d.attr("dy")),j=d.text(null).append("tspan").attr("x",c).attr("y",h).attr("dy",i+"em");for(a=f.pop();a;)g.push(a),j.text(g.join(" ")),j.node().getComputedTextLength()>b&&(g.pop(),j.text(g.join(" ")),g=[a],j=d.append("tspan").attr("x",c).attr("y",h).attr("dy",1.1*++e+i+"em").text(a)),a=f.pop()}),d[0]=++e}function p(a,b,c,d,e,f,g,h,i,j){var k=document.createElement("iframe");k.id="preview",k.style.position="absolute",k.style.width=d+"px",k.style.height=e+"px";var l=document.getElementsByTagName("svg")[0].getBoundingClientRect(),m=document.body.getBoundingClientRect();m.x>0&&(m.x=0),k.style.left=Uc?window.innerWidth-10-d+"px":Tc?"10px":g?i+l.x+"px":h?i+l.x+c-d+18+"px":i+l.x-d/2+c/2+"px";var n=Wc?0:50;if(k.style.top=Tc?l.y-m.y+_b/2+"px":f?n+j+l.y-m.y-e+"px":n+j+l.y+b-m.y+"px","lti"!=a.entype&&"unknown"!=a.type){var o=document.createElement("div");o.id="bgrnd",o.style.position="absolute",o.style.width=parseInt(k.style.width)+24+"px",o.style.height=parseInt(k.style.height)+24+"px",o.style.left=parseInt(k.style.left)-12+"px",o.style.top=parseInt(k.style.top)-12+"px",o.addEventListener("mouseout",function(a){var b=this.getBoundingClientRect();a.x>b.x&&a.x<b.x+b.width&&a.y>b.y&&a.y<b.y+b.height||(Vc=!1,setTimeout(r,750))}),o.addEventListener("mouseover",function(){Vc=!0}),k.src=zb+"/mod/"+a.entype+"/view.php?id="+a.id,document.body.appendChild(o),document.body.appendChild(k)}}function q(a){Sc||"lightgrey"==a.colour||(bc.on("mouseout",null),cc.on("mouseout",null),setTimeout(r,750))}function r(){if(!Vc&&(Vb.selectAll(".text").remove(),Vb.selectAll("rect").remove(),Vb.selectAll("#preview").remove(),Vb.selectAll("#bgrnd").remove(),bc.on("mouseover",n).on("mouseout",q),Tc)){cc.on("mouseover",Ma).on("mouseout",q);for(var a=0;a<Pc.length;a++)Vb.select("#cluster1-"+a).on("mouseover",Ka.bind(this,a,!1)),Vb.select("#cluster2-"+a).on("mouseover",Ka.bind(this,a,!1))}}function s(){var a=$b/2,b=_b/2,c=Eb;void 0===dd.originalx?(dd.originalx=a,dd.originaly=b):(a=dd.originalx,b=dd.originaly);for(var d,e,f=0;f<ic.nodes.length;f++)d=ic.nodes[f].xcoord*c+a,e=ic.nodes[f].ycoord*c+b,(d<0||d>$b||e<0||e>_b)&&(c*=.9,--f);Eb=c,dd.distance=c,cc.attr("x1",function(d){var e=ic.nodes.filter(function(a){var b="string"==typeof d.source?d.source:d.source.id;return a.id==b})[0];return Vb.select(this).attr("y1",e.ycoord*c+b),e.xcoord*c+a}).attr("x2",function(d){var e=ic.nodes.filter(function(a){var b="string"==typeof d.target?d.target:d.target.id;return a.id==b})[0];return Vb.select(this).attr("y2",e.ycoord*c+b),e.xcoord*c+a}).style("display",function(a){return a.source.visible&&a.target.visible?"block":"none"}),bc.attr("cx",function(b){return b.x=b.xcoord*c+a,b.x}).attr("cy",function(a){return a.y=a.ycoord*c+b,a.y}).style("display",function(a){return a.visible?"block":"none"}).style("fill",function(a){return a.colour}).raise()}function t(){var a=cd;cc.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}).style("stroke-width",function(a){return 2*a.weight+"px"}).style("display",function(a){return a.source.visible&&a.target.visible?"block":"none"}),bc.attr("cx",function(b){return b.x=Math.max(a,Math.min($b-a,b.x)),b.x}).attr("cy",function(b){return b.y=Math.max(a,Math.min(_b-a,b.y)),b.y}).style("fill",function(a){return a.colour}).style("display",function(a){return a.visible?"block":"none"}).raise(),Vb.selectAll("rect").raise(),Vb.selectAll("text").raise()}function u(){if(Lb){Vb.select("#time").remove(),0==Pb&&(Pb=Date.now());var a=new Date;a.setTime(Pb);var b=a.getMinutes();b<10&&(b="0"+b),Zb.append("text").attr("id","time").attr("y",_b-16).attr("dy",".40em").attr("x",6).style("pointer-events","none").text(Lb[Ob]+" "+a.getHours()+":"+b+" "+a.toDateString())}}function v(){var a=w();if(Hb&&Jb){var b={};for(var c in a)"scale"!=c&&"module"!=c&&(b[c]=a[c]);Hb[Gb]=b,Jb[Gb]=a.scale}a.time=Date.now(),Pb=a.time,Kb&&(Kb[Gb]=a.time),x(ob,a)}function w(){var a,b,c,d,e={},f=0,g=$b/2,h=_b/2;return ic.nodes.forEach(function(e){a=e.x-g,b=e.y-h,(c=Math.sqrt(a*a+b*b))>f&&(f=c,d=e)}),e.scale=f,e.module=d.id,Eb=f,ic.nodes.forEach(function(a){e[a.id]={xcoord:""+(a.x-g)/f,ycoord:""+(a.y-h)/f,visible:a.visible?1:0},a.xcoord||(a.xcoord=(a.x-g)/f,a.ycoord=(a.y-h)/f)}),Cb=e,e}function x(a,b){var c=new XMLHttpRequest;c.open("POST",a),c.setRequestHeader("Content-type","application/x-www-form-urlencoded"),c.onreadystatechange=function(){4==this.readyState&&this.status},c.send("cid="+Fb+"&data="+JSON.stringify(b)+"&sesskey="+Ub)}function y(){var a=document.getElementById("student-menu"),b=document.createElement("button");b.innerHTML=Tb.copy,b.addEventListener("click",z),a.appendChild(b);var c=b.getBoundingClientRect().height,d=document.createElement("button");d.innerHTML=Tb.print,d.addEventListener("click",A),a.appendChild(d),Ac=document.createElement("select"),Ac.size=3,Ac.id="teacher-select",Ac.style.minWidth="40px";var e=_b-c-20;Ac.style.height=e+"px",Ac.addEventListener("change",B);for(var f in Jb){var g=document.createElement("option");g.value=f,g.text=f,Gb==f&&(g.selected=!0),Ac.appendChild(g)}a.appendChild(Ac)}function z(){var a=new Image,b=new XMLSerializer,c=b.serializeToString(Zb.node());a.src="data:image/svg+xml;base64,"+window.btoa(c),document.body.appendChild(a);var d=document.createRange();d.setStartBefore(a),d.setEndAfter(a),d.selectNode(a),window.getSelection().addRange(d),document.execCommand("Copy"),document.body.removeChild(a)}function A(){var a=new XMLSerializer,b=a.serializeToString(Zb.node()),c=window.open();c.document.write('<img src="data:image/svg+xml;base64,'+window.btoa(b)+'"/>'),c.print(),c.close()}function B(){for(var a,b=document.getElementById("teacher-select"),c=0;c<b.options.length;c++)if(b.options[c].selected){a=b.options[c].value;break}a==Gb?($c=K,_c=L,ad=M,bd=J):($c=null,_c=null,ad=null,bd=null),Cb=Hb[a],Db=Ib[a],Eb=Jb[a],Pb=Kb[a],vb=Mb[a],yb=Nb[a],Ob=a,Zb.remove(),zc={},d(),Vb.selectAll("#legendUL").remove(),D(),ec=1,e(),ec=0;var f=document.getElementById("weights-output").innerHTML;f=parseFloat(f.split(" ")[1]),k(f);for(var g in zc)Cb[g]&&(zc[g].checked=1==Cb[g].visible),Gb==a?(zc[g].removeEventListener("change",C),zc[g].addEventListener("change",H)):(zc[g].removeEventListener("change",H),zc[g].addEventListener("change",C))}function C(){this.checked=!this.checked}function D(){var a,b=500;yc=document.getElementById("legend"),yc.style="width: "+xb+"px; height: "+_b+"px; min-width: "+xb+"px; max-width: "+b+"px;";var c=function(a){var b=yc.offsetLeft+28;a.x>=b&&a.x<=b+6?yc.style.cursor="col-resize":yc.style.cursor="auto"},d=function(c){var d=a-c.x;a=c.x;var e=parseInt(yc.style.width)+d;e>b?e=b:e<xb&&(e=xb),yc.style.width=e+"px"};yc.addEventListener("mousemove",c),yc.addEventListener("mousedown",function(b){a=b.x,"col-resize"==yc.style.cursor&&yc.addEventListener("mousemove",d)}),document.addEventListener("mouseup",function(){yc.removeEventListener("mousemove",d)}),E(yc)}function E(a){var b=document.createElement("ul");b.id="legendUL";var c=document.createElement("span");c.className="no-select-text",c.innerHTML=yb;var d=document.createElement("li");d.appendChild(c);var e=document.createElement("ul");d.appendChild(e),b.appendChild(d);var f,g,h,i=-1;vb.sort(function(a,b){return a.sect-b.sect}),vb.forEach(function(a){i!=a.sect&&(g=document.createElement("ul"),g.className="nested",h=document.createElement("span"),h.className="caret",h.addEventListener("click",F),f=document.createElement("li"),f.appendChild(h),G("g"+a.sect,Tb.section+" "+a.sect,Dc.grouping,a.sect,"grouping",f),f.appendChild(g),e.appendChild(f),i=a.sect),f=document.createElement("li"),f.className="indented",G(a.id,a.name,Dc[a.entype],a.sect,a.type,f),g.appendChild(f)}),a.appendChild(b)}function F(){this.parentElement.querySelector(".nested").classList.toggle("active"),this.classList.toggle("caret-down")}function G(a,b,c,d,e,f){var g=document.createElement("input");g.type="checkbox",Cb[a]?g.checked=0!=Cb[a].visible:Cb["g"+d]?g.checked=1==Cb["g"+d].visible&&Gb==Ob:g.checked=!0,g.id=a,g.group=d,g.nodeT=e,g.addEventListener("change",H),zc[g.id]=g;var h=document.createElement("label");h.style.color=c,h.className="no-select-text";var i="grouping"==e?b:e+"_"+b;h.appendChild(document.createTextNode(i)),f.appendChild(g),f.appendChild(h)}function H(){var a=this.id,b=this.checked,c=this.nodeT,d=this.group;ic.nodes.forEach(function(e){e.id==a?(e.visible=b,zc[e.id].checked=b):"grouping"==c&&e.group==d?(e.visible=b,zc[e.id].checked=b):b&&"grouping"==e.type&&e.group==d&&(e.visible=b,zc[e.id].checked=b)}),I(),Q()}function I(){parseFloat(document.getElementById("weight-slider").value)<0&&(dc.strength(0),document.getElementById("weights-output").innerHTML="&nbsp;= 0",document.getElementById("weight-slider").value=0)}function J(a){if(Vb.selectAll(".text").remove(),Vb.selectAll("rect").remove(),Vb.selectAll("#preview").remove(),Vb.selectAll("#bgrnd").remove(),Vb.event.preventDefault(),"root"!=a.id){var b=a;bc.on("mouseover",null).on("mouseout",null);var c=Zb.append("rect"),d=Zb.append("text").attr("class","text").attr("id","rctext").attr("x",a.x+10).attr("y",a.y+12).attr("dy",".40em").style("pointer-events","none").text(Tb.hide);a.y+20>=_b&&d.attr("y",_b-(_b-a.y)-10).text(Tb.hide),c.attr("id","rcrect").attr("x",a.x).attr("y",a.y+20<=_b?a.y:_b-(_b-a.y)-20).attr("width",60).attr("height",24).style("stroke","black").style("fill","lightgrey"),c.on("mouseover",function(){Vb.event.target.style="fill: grey;"}),c.on("mouseout",function(){Vb.event.target.style="fill: lightgrey;"}),c.on("click",function(){Vb.selectAll("#rctext").remove(),Vb.selectAll("#rcrect").remove(),bc.on("mouseover",n).on("mouseout",q),b.visible=!1,zc[b.id].checked=!1,"grouping"==b.type&&ic.nodes.forEach(function(a){a.group==b.group&&(a.visible=!1,zc[a.id].checked=!1)}),I(),Q()})}}function K(a){Vb.event.active||ac.alphaTarget(gc).restart(),a.fx=a.x,a.fy=a.y}function L(a){Vb.selectAll("rect").remove(),Vb.selectAll(".text").remove(),Vb.selectAll("#preview").remove(),Vb.selectAll("#bgrnd").remove(),a.fx=Vb.event.x,a.fy=Vb.event.y}function M(a){Vb.event.active||(Ab?(ac.stop(),v(),u()):ac.alphaTarget(hc)),a.fx=null,a.fy=null,Zc=Date.now()}function N(){var a=document.getElementById("student-menu");nc=document.createElement("button"),nc.innerHTML=Tb.cluster,nc.addEventListener("click",$),a.appendChild(nc);var b=nc.getBoundingClientRect().height;jc=document.createElement("select"),jc.multiple=!0,jc.id="student-select";var c=_b-b-12;jc.style="height: "+c+"px;",jc.addEventListener("change",function(){for(var a=document.getElementById("student-select"),b="box-shadow: 0 0 0 0 white inset;",c=0;c<a.options.length;c++){var d="box-shadow: 0 0 10px 100px "+a.options[c].colour+" inset;";a.options[c].style=a.options[c].selected?d:b}tb.length>0&&R(!0)}),1==Xc?ub.sort(function(a,b){var c=a.firstname+" "+a.lastname,d=b.firstname+" "+b.lastname;return c>d?1:c<d?-1:0}):ub.sort(function(a,b){return a.id-b.id}),ub.forEach(function(a){O(a,jc)}),a.appendChild(jc)}function O(a,b){var c=document.createElement("option");c.value=a.id,c.text=1==Xc?a.firstname+" "+a.lastname:a.id,c.colour=Bc[Cc++],Cc>=Bc.length&&(Cc=0),ic.edges[a.id].forEach(function(a){a.colour=c.colour}),b.appendChild(c)}function P(){kc=document.getElementById("slider"),lc=[0,ic.maxSession];var a;a=ic.maxSession<500?10:ic.maxSession<1e3?20:ic.maxSession<5e3?100:ic.maxSession<1e4?200:500,Xb.create(kc,{start:[0,ic.maxSession],range:{min:[0],max:[ic.maxSession]},step:1,connect:!0,pips:{mode:"steps",stepped:!0,density:100,filter:function(b){return 0==b||b==ic.maxSession?1:b%a==0?2:0}}}),setTimeout(function(){kc.noUiSlider.on("update",function(a,b){lc[b]=parseInt(a[b]),jc.dispatchEvent(new Event("change"))})},1e3)}function Q(){cc.remove(),bc.remove(),Vb.selectAll(".hull").remove();var a=S(J);T(a),V(a),ac.alphaTarget(fc).restart(),Ab&&setTimeout(function(){ac.stop(),v(),u()},100)}function R(a){cc.remove(),bc.remove(),Vb.selectAll(".hull").remove(),Ab=!1;var b=S(null);T(b),a&&V(b),Ab=!0,ac.on("tick",s),ac.restart(),setTimeout(ac.stop,100)}function S(a){var b=[],c={};return ic.nodes.forEach(function(a){null===a.fx&&(a.fx=a.x,a.fy=a.y),a.visible?b[b.length]=a:c[a.id]=1}),ac.nodes(b),l(b,a,$c,_c,ad),c}function T(a){var b,c,d,e,f,g=[];for(f in ic.links)d=ic.links[f],"string"==typeof d.source?(b=d.source,c=d.target):(b=d.source.id,c=d.target.id),a[b]||a[c]||(g[g.length]=d);var h=Ab?[]:document.getElementById("student-select").options;for(f=0;f<h.length;f++)if(h[f].selected){var i,j,k={};for(j=lc[0];j<=lc[1]&&ic.edges[h[f].value].length>j;j++)e=ic.edges[h[f].value][j],"string"==typeof e.source?(i=e.source+"_"+e.target,b=e.source,c=e.target):(i=e.source.id+"_"+e.target.id,b=e.source.id,c=e.target.id),k[i]?k[i]++:k[i]=1,a[b]||a[c]||(g[g.length]=e);for(j=lc[0];j<=lc[1]&&ic.edges[h[f].value].length>j;j++)e=ic.edges[h[f].value][j],i="string"==typeof e.source?e.source+"_"+e.target:e.source.id+"_"+e.target.id,e.weight=k[i]}ac.force("link").links(g),m(g)}function U(a){return ic.nodes.find(function(b){return b.id==a})}function V(a){if(!Ab){Vb.selectAll(".hull").remove();for(var b=document.getElementById("student-select").options,c={},d=0;d<b.length;d++)if(b[d].selected){var e,f,g,h,i,j,k;c[b[d].value]={};for(var l=lc[0];l<=lc[1]&&ic.edges[b[d].value].length>l;l++){var m=ic.edges[b[d].value][l];if("string"==typeof m.source){j=m.source,k=m.target;var n=U(j);e=n.x,f=n.y,n=U(k),g=n.x,h=n.y}else j=m.source.id,k=m.target.id,e=m.source.x,f=m.source.y,g=m.target.x,h=m.target.y;a[j]||a[k]||(i=m.colour,c[b[d].value][j]={x:e,y:f,colour:i},c[b[d].value][k]={x:g,y:h,colour:i})}}for(var o in c)Y(c[o],o,!1,!1);Fc&&(ld?X(b):W(b))}}function W(a){if(Nc={},0!=Object.keys(kd).length)for(var b=0;b<a.length;b++)if(a[b].selected){var c=a[b].value;if(kd[c].length<=lc[0])continue;var d=lc[0],e=kd[c].length>lc[1]+1?lc[1]:kd[c].length,f=parseInt(d/2+e/2),g=kd[c][f],h=parseFloat(Cb[g].xcoord),i=parseFloat(Cb[g].ycoord);Nc[c]={x:h*Eb+dd.originalx,y:i*Eb+dd.originaly,colour:a[b].colour}}}function X(a){if(Nc={},0!=Object.keys(kd).length)for(var b=0;b<a.length;b++)if(a[b].selected){var c=a[b].value;if(kd[c].length<=lc[0])continue;for(var d,e=lc[0],f=kd[c].length>lc[1]+1?lc[1]:kd[c].length,g=0,h=0,i=0,j=e;j<f;j++)d=kd[c][j],g+=parseFloat(Cb[d].xcoord),h+=parseFloat(Cb[d].ycoord),i++;Nc[c]={x:g/i*Eb+dd.originalx,y:h/i*Eb+dd.originaly,colour:a[b].colour}}}function Y(a,b,c,d){if(0!=Object.keys(a).length){var e,f,g,h=[],i=20;g=Fc?"hull":c?"manual-hull":"cluster-hull";for(var j in a)h[h.length]=[a[j].x,a[j].y],e=a[j].colour;if(1==h.length)f=function(a){var b=[a[0][0],a[0][1]-i],c=[a[0][0],a[0][1]+i];return"M "+b+" A "+[i,i,"0,0,0",c].join(",")+" A "+[i,i,"0,0,0",b].join(",")};else{if(2!=h.length){var k=Vb.concaveHull().padding(15);Jc||k.distance(Kc);var l=h.length>4?k(h):[h];return f=Vb.line().curve(Lc),void Zb.selectAll("#hull-"+b).data(l).enter().append("path").attr("id","hull-"+b).attr("class",g).style("stroke",e).style("stroke-opacity",d?0:1).style("fill",e).style("fill-opacity",d?0:Mc).attr("d",f)}var m=function(a,b){return[b[0]-a[0],b[1]-a[1]]},n=function(a,b){return[b*a[0],b*a[1]]},o=function(a,b){return[a[0]+b[0],a[1]+b[1]]},p=function(a){var b=Math.sqrt(a[0]*a[0]+a[1]*a[1]);return n(a,1/b)},q=function(a,b){return n(p(a),b)},r=function(a,b){void 0!==b&&(a=m(a,b));var c=[-a[1],a[0]];return p(c)};f=function(a){var b=m(a[0],a[1]),c=q(b,i),d=o(a[0],n(c,-1)),e=o(a[1],c),f=1.2*i,g=q(r(b),f),h=n(g,-1),j=o(d,h),k=o(e,h),l=o(d,g);return"M "+d+" C "+[j,k,e].join(",")+" S "+[l,d].join(",")+" Z"}}Zb.append("path").attr("id","hull-"+b).attr("class",g).style("stroke",e).style("stroke-opacity",d?0:1).style("fill",e).style("fill-opacity",d?0:Mc).attr("d",f(h))}}function Z(){clearInterval(Ic),Ic=void 0,Oc=null,wa(),Vb.selectAll(".clustering-centroid").remove(),Vb.selectAll(".cluster-hull").remove(),Vb.selectAll(".centroid").remove(),Vb.selectAll(".server-centroid").remove(),uc.style.display="none",document.getElementById("anim-controls").style.display="none",document.getElementById("log-panel").style.display="none",document.getElementById("student-menu").style.width=nc.style.width,Fc=!0,Tc=!1,kc.style.display="block",jc.style.display="block",bc.style("display","block"),bc.style("opacity",1),cc.style("display","block"),cc.style("opacity",1),R(!0),bc.on("mouseover",n).on("mouseout",q),nc.innerHTML=Tb.cluster,nc.removeEventListener("click",Z),nc.addEventListener("click",$)}function $(){Fc=!1,kc.style.display="none",jc.style.display="none",Vb.selectAll(".hull").remove(),Vb.selectAll(".text").remove(),Vb.selectAll("rect").remove(),document.getElementById("student-menu").style.width=wc+"px",nc.innerHTML=Tb.graph,nc.removeEventListener("click",$),nc.addEventListener("click",Z),ac.stop(),bc.on("mouseover",null).on("mouseout",null).on("contextmenu",null).call(Vb.drag().on("start",null).on("drag",null).on("end",null)),dd.clusterId=Date.now(),Qb={},Hc=0,Gc=!1,vc=1,Ic=void 0;var a='<p id="cluster-text">'+Tb.numclusters+"</p>";setTimeout(function(){if(uc)document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("dragdrop").innerHTML="&nbsp",document.getElementById("cluster-text").innerHTML=a,document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("play-pause").disabled=!0,document.getElementById("play-step").disabled=!0,document.getElementById("anim-controls").style.display="block",document.getElementById("log-panel").style.display="block",uc.removeAttribute("disabled"),uc.noUiSlider.set(1),uc.style.display="block";else{var b=Ca();Ua(a,b),db()}eb()},ed/2)}function _(a,b){Ab=!0,Cb={0:0,1:1,2:2},_b=window.innerHeight-190,ta(),db(),aa(a,b)}function aa(a,b){var c=document.getElementById("student-menu");pc=document.createElement("select"),pc.size=3,pc.id="replay-select",pc.style="height: "+(_b-12)+"px;",pc.addEventListener("change",ba.bind(this,a,b));for(var d in a){var e=0;for(var f in a[d]){var g=0;e++;for(var h in a[d][f])if(!isNaN(h)&&a[d][f][h][1]){var i=document.createElement("option");i.value=d+"_"+f+"_"+h,i.text=d.split("-")[0]+"_"+e+"_"+ ++g,pc.appendChild(i)}}}c.appendChild(pc)}function ba(a,b){var c=qa(a,b),f=c.members;Zb&&(Zb.remove(),xa(),wa(),document.getElementById("replayer").innerHTML="&nbsp;",document.getElementById("replaydragdrop").innerHTML="&nbsp;"),jc&&document.body.removeChild(jc),Oc=null,d(),e(),lc=[0,ic.maxSession];for(var g=0;g<ic.nodes.length;g++)void 0===ic.nodes[g].xcoord&&(ic.nodes[g].visible=!1);ra(f),k(0),R(!1),bc.on("mouseover",null).on("mouseout",null),Rc=!0,setTimeout(function(){sa(Nc,!1),eb(),ac.on("tick",s);for(var a in Nc)Vb.select("#centroid-"+a).call(Vb.drag().on("start",ca.bind(this,a)).on("drag",da.bind(this,a)).on("end",ea.bind(this,a,b,c)))},500)}function ca(a){ia(a)&&(hd=Date.now(),Zb.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+a).attr("points",fb(Vb.event.x,Vb.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",Nc[a].colour).style("opacity",.5))}function da(a){Vb.select("#dragged-"+a).attr("points",fb(Vb.event.x,Vb.event.y))}function ea(a,b,c){if(Vb.selectAll(".dragged-centroid").remove(),ia(a)){if(Date.now()-hd<300)return void nb(Rb[a],a,!1);gd||ka();var d=ja();if(0==Object.keys(od[d]).length)for(var e=0;e<qc[d].length;e++)for(var f in qc[d][e].members){var g=Sb[qc[d][e].members[f].id];od[d][g]=e}var h=jb(Vb.event);for(var i in od)i<=d&&(od[i][a]=h);la(d,b,c),gd=!0,ga(d),fa(d)}}function fa(a){for(var b={clusterCoords:[],members:[]},c=0;c<pd.length;c++){var d=pd[c]?pd[c]:Pc[c];b.clusterCoords[c]=Sa(d),b.clusterCoords[c].num=c;for(var e in od[a])od[a][e]==c&&(b.members[b.members.length]={id:Rb[e],num:c})}b.iteration=a,b.clusterId=dd.clusterId,b.coordsid=Pb,x(rb,b)}function ga(a){if(!(a>=0)&&od[a]&&0!=Object.keys(od[a]).length){var b,c=ha(a),d=Tb.manualcluster+"<br>";for(b=0;b<pd.length;b++)if(pd[b]){var e=pd[b].x-$b/2,f=pd[b].y-_b/2,g=Math.sqrt(e*e+f*f),h=Pc[b].colour;d+=Tb.disttocluster+' <span style="color:'+h+'">'+h+"</span>: "+Math.round(g)+"<br>"+Tb.cluster+" "+h+" "+Tb.members+": [";for(var i in od[a])od[a][i]==b&&(d+=i+", ");-1!=d.indexOf(",",d.length-3)&&(d=d.slice(0,-2)),d+="]<br>",jd&&(d+=Tb.precision+": "+c[b].precision.toFixed(4)+"<br>",d+=Tb.recall+": "+c[b].recall.toFixed(4)+"<br>",d+=Tb.f1+": "+c[b].f1.toFixed(4)+"<br>",d+=Tb.fhalf+": "+c[b].fhalf.toFixed(4)+"<br>",d+=Tb.f2+": "+c[b].f2.toFixed(4)+"<br>")}var j=xc.innerHTML.split("<br><br>"),k=j[0].split("<br>");for(xc.innerHTML="",b=0;b<k.length&&!k[b].startsWith(Tb.manualcluster);b++)xc.innerHTML+=k[b]+"<br>";for(jd&&(b=c.length-1,d+=Tb.totalmeasures+"<br>",d+=Tb.precision+": "+c[b].precision.toFixed(4)+"<br>",d+=Tb.recall+": "+c[b].recall.toFixed(4)+"<br>",d+=Tb.f1+": "+c[b].f1.toFixed(4)+"<br>",d+=Tb.fhalf+": "+c[b].fhalf.toFixed(4)+"<br>",d+=Tb.f2+": "+c[b].f2.toFixed(4)+"<br>"),xc.innerHTML+=d+"<br>",b=1;b<j.length;b++)xc.innerHTML+=j[b]+"<br><br>"}}function ha(a){var b,c,d,e=0,f=0,g=0,h=[];for(d=0;d<Pc.length;d++){for(var i in Oc)Oc[i].ci==d&&od[a][i]==Oc[i].ci?e++:Oc[i].ci==d&&od[a][i]!=Oc[i].ci?f++:od[a][i]==d&&od[a][i]!=Oc[i].ci&&g++;b=e/(e+f),c=e/(e+g),h[d]={tp:e,fp:f,fn:g,precision:b,recall:c,f1:b+c==0?0:2*b*c/(b+c),fhalf:b+c==0?0:1.25*b*c/(.25*b+c),f2:b+c==0?0:5*b*c/(4*b+c)},e=0,f=0,g=0}for(d=0;d<h.length;d++)e+=h[d].tp,f+=h[d].fp,g+=h[d].fn;return b=e/(e+f),c=e/(e+g),h[h.length]={tp:e,fp:f,fn:g,precision:b,recall:c,f1:b+c==0?0:2*b*c/(b+c),fhalf:b+c==0?0:1.25*b*c/(.25*b+c),f2:b+c==0?0:5*b*c/(4*b+c)},h}function ia(a){if(document.getElementById("replayer").innerHTML!=Tb.convergence)return!1;if(id!=Gb)return!1;var b,c=Oc[a].ci,d=0;for(b in Oc)Oc[b].ci==c&&d++;var e=ja(),f=0;if(od[e]){c=od[e][a];for(b in od[e])od[e][b]==c&&f++}return!(1==d&&f<=1)&&1!=f}function ja(){var a=xc.innerHTML.split("<br>");return a[2]&&a[2].startsWith(Tb.iteration)?parseInt(a[2].split(" ")[1]):null}function ka(){for(var a in qc)if(!(a>=0)){od[a]={};for(var b=0;b<qc[a].length;b++)for(var c in qc[a][b].members){var d=Sb[qc[a][b].members[c].id];od[a][d]=b}}}function la(a,b,c){var d,e,f=[],g=[];for(d=0;d<qc[a].length;d++){f[d]={},g[d]=[];for(e in od[a])if(od[a][e]==d){var h=Oc[e].x,i=Oc[e].y;f[d][h+"_"+i]={x:h,y:i,colour:Pc[d].colour},g[d][g[d].length]=[h,i]}}var j=document.getElementsByClassName("manual-centroid").length,k=0==j;for(Vb.selectAll(".manual-hull").remove(),d=0;d<f.length;d++)Y(f[d],-1*(d+1),!0,k),pd[d]=Pa(g[d]);if(b)for(b[c.did]||(b[c.did]={}),b[c.did][c.gid]||(b[c.did][c.gid]={}),b[c.did][c.gid][c.cid]||(b[c.did][c.gid][c.cid]={}),b[c.did][c.gid][c.cid][a]||(b[c.did][c.gid][c.cid][a]=[]),d=0;d<pd.length;d++)if(pd[d]){var l=[];for(e in od[a])od[a][e]==d&&(l[l.length]={id:Rb[e],num:d});b[c.did][c.gid][c.cid][a][d]={centroidx:pd[d].x,centroidy:pd[d].y,members:l}}k?na():oa(),Zb.selectAll(".centroid").raise(),Zb.selectAll(".clustering-centroid").raise(),Zb.selectAll(".manual-centroid").raise()}function ma(){Vb.event.stopPropagation()}function na(){Vb.selectAll(".manual-centroid").remove();for(var a,b,c=14,d=0;d<pd.length;d++){if(!pd[d])return;a=pd[d].x,b=pd[d].y,Zb.append("line").attr("class","manual-centroid").attr("id","manual1-"+d).attr("x1",a-c).attr("y1",b-c).attr("x2",a+c).attr("y2",b+c).style("stroke",Pc[d].colour).style("stroke-width","5px").style("opacity",0).on("click",ma).on("click.centroidClick",nb.bind(this,-1*(d+1),d,!0)).on("mouseover",Ka.bind(this,d,!0)),Zb.append("line").attr("class","manual-centroid").attr("id","manual2-"+d).attr("x1",a+c).attr("y1",b-c).attr("x2",a-c).attr("y2",b+c).style("stroke",Pc[d].colour).style("stroke-width","5px").style("opacity",0).on("click",ma).on("click.centroidClick",nb.bind(this,-1*(d+1),d,!0)).on("mouseover",Ka.bind(this,d,!0))}Vb.selectAll(".manual-centroid").transition().duration(ed).style("opacity",.5),Vb.selectAll(".manual-hull").transition().duration(ed).style("stroke-opacity",1).style("fill-opacity",Mc)}function oa(){for(var a,b,c=14,d=0;d<pd.length;d++){if(!pd[d])return void Vb.selectAll(".manual-centroid").remove();a=pd[d].x,b=pd[d].y,Vb.select("#manual1-"+d).transition().duration(ed).attr("x1",a-c).attr("y1",b-c).attr("x2",a+c).attr("y2",b+c).style("display","block"),Vb.select("#manual2-"+d).transition().duration(ed).attr("x1",a+c).attr("y1",b-c).attr("x2",a-c).attr("y2",b+c).style("display","block")}}function pa(a){if(!a||a>0)return Zb.selectAll(".manual-centroid").remove(),void Zb.selectAll(".manual-hull").remove();gd&&la(a,null,null)}function qa(a,b){var c,d,e=document.getElementById("replay-select");for(d=0;d<e.options.length;d++)if(e.options[d].selected){c=e.options[d].value.split("_");break}var f=c[0],g=c[1],h=c[2];id=f.split("-")[0],dd.clusterId=h,Pb=a[f][g].last,Cb=a[f][g].nodes,Db=a[f][g].links,Eb=a[f][g].scale,vb=a[f][g].mods,qc=a[f][g][h],tb=a[f][g].logs,ub=a[f][g].users,Qb=a[f][g][h].comments,Sb={},Rb={},ub.forEach(function(a){Rb[a.id]=a.realId,Sb[a.realId]=a.id}),Hc=0,vc=1,sc=0,tc=0;for(var i in qc)isNaN(i)||(i>=0?sc++:tc--);pd=[],od={},gd=!1;var j,k,l=b[f][g][h];if(l)for(gd=!0,d=-1;d>=tc;d--){l[d]&&!l[d-1]&&(l[d-1]=l[d]),od[d]={};for(j in l[d])for(k in l[d][j].members){var m=l[d][j].members[k].id;od[d][Sb[m]]=j}}Pc=[],Nc={};var n={},o=0;for(j in qc[1]){if(d=Pc.length,Pc[d]={x:0,y:0},o<Ec.length)Pc[d].colour=Ec[o++];else{for(var p;!p;)p=Bc[Math.floor(Yb.random()*Bc.length)],p=Ec.includes(p)?void 0:p;Pc[d].colour=p}for(k in qc[1][j].members){var q=Sb[qc[1][j].members[k].id];Nc[q]={x:qc[1][j].members[k].x,y:qc[1][j].members[k].y},n[q]=!0}}return{members:n,did:f,gid:g,cid:h}}function ra(a){jc=document.createElement("select"),jc.multiple=!0,jc.id="student-select",jc.style.display="none",Cc=0,ub.forEach(function(a){O(a,jc)});for(var b,c=0;c<jc.options.length;c++)b=jc.options[c].value,a[b]?jc.options[c].selected=!0:jc.options[c].selected=!1,Nc[b]&&(Nc[b].colour=jc.options[c].colour);document.body.appendChild(jc)}function sa(a,b){for(var c in a)a[c].x*=dd.distance,a[c].x+=dd.originalx,a[c].y*=dd.distance,a[c].y+=dd.originaly,b&&(a[c].x-=dd.centre.x,a[c].x*=dd.scale,a[c].x+=$b/2,a[c].y-=dd.centre.y,a[c].y*=dd.scale,a[c].y+=_b/2)}function ta(){var a=document.getElementById("slider"),b=document.createElement("p");b.innerHTML="&nbsp",b.id="replayer",b.style.marginTop="-20px",a.appendChild(b);var c=document.createElement("p");c.innerHTML="&nbsp",c.id="replaydragdrop",c.style.marginTop="-12px",a.appendChild(c);var d=document.createElement("button");d.id="replay-stop",d.innerHTML="&#9606",d.addEventListener("click",va),a.appendChild(d);var e=document.createElement("button");e.id="replay-pause",e.innerHTML="&#9654",e.value="play",e.addEventListener("click",ya),a.appendChild(e);var f=document.createElement("button");f.id="replay-back",f.innerHTML="&#9614&#9664",f.addEventListener("click",Aa),a.appendChild(f);var g=document.createElement("button");g.id="replay-forward",g.style.marginRight="80px",g.innerHTML="&#9654&nbsp&nbsp&#9614",g.addEventListener("click",za.bind(this,!0)),a.appendChild(g);var h=document.createElement("button");h.id="delete-button",h.innerHTML=Tb.delbutton,h.addEventListener("click",ua),a.appendChild(h)}function ua(){if(confirm(Tb.delconfirm)){var a=document.getElementById("replay-select");if(a.selectedIndex>-1){var b=a.options[a.selectedIndex].value;b.length>0&&(x(sb,b.replace("-","_")),a.options[a.selectedIndex]=null,va())}}}function va(){Zb&&setTimeout(function(){Zb.remove(),wa(),document.getElementById("replayer").innerHTML="&nbsp;",document.getElementById("replaydragdrop").innerHTML="&nbsp;"},500),qc=void 0,Oc=null,xa();var a=document.getElementById("replay-select");a.selectedIndex>-1&&(a.options[a.selectedIndex].selected=!1)}function wa(){xc.readOnly=!1,xc.innerHTML="",setTimeout(function(){xc.readOnly=!0},300)}function xa(){var a=document.getElementById("replay-pause");a.innerHTML="&#9654",a.value="play",clearInterval(Ic),Ic=void 0}function ya(){if(qc){var a=document.getElementById("replay-pause");"play"==a.value?(a.innerHTML="&#9613&#9613",a.value="pause",za(!1),Ic=setInterval(za.bind(this,!1),1200)):xa()}}function za(a){if(qc){a&&xa(),Hc++;var b=Hc-1;return Hc>sc&&qc[-1]&&(b=sc-Hc+1,!qc[b-1])?(Hc--,void xa()):b>sc?(Hc--,void xa()):void(1==Hc?(vc=2,Gc=!0,Rc=!1,Ya()):2==Hc?(Za(),Ba(b-1,!1,!0)):Ba(b-1,!1,!1))}}function Aa(){if(qc&&rc&&!(Hc-1<0)){xa(),Hc--;var a=Hc-1;Hc>sc&&(a=sc-Hc+1),0==Hc?(vc=1,Xa(),Gc=!1,xc.innerHTML=xc.innerHTML.slice(xc.innerHTML.indexOf("<br><br>")+8),document.getElementById("replayer").innerHTML="&nbsp;",document.getElementById("replaydragdrop").innerHTML="&nbsp;"):1==Hc?(Oc=null,Ya(),xc.innerHTML=xc.innerHTML.slice(xc.innerHTML.indexOf("<br><br>")+8),document.getElementById("replayer").innerHTML="&nbsp;",document.getElementById("replaydragdrop").innerHTML="&nbsp;"):(Oc=null,Ba(a-1,!0,2==Hc))}}function Ba(a,b,c){var d,e=[],f={},g={};for(d=0;d<qc[a].length;d++,g={}){Zb.selectAll("#hull-"+d).remove(),Pc[d].x=qc[a][d].centroidx,Pc[d].y=qc[a][d].centroidy;for(var h in qc[a][d].members){var i=qc[a][d].members[h].x,j=qc[a][d].members[h].y,k=Sb[qc[a][d].members[h].id];Nc[k].x=i,Nc[k].y=j,g[i+"_"+j]={x:i,y:j,colour:Pc[d].colour},f[k]=d}e[d]=g}if(sa(Pc,!0),c)Ia();else{for(sa(Nc,!1),d=0;d<e.length;d++)sa(e[d],!0),Y(e[d],d,!1,!1);Ta(ed)}if($a(rc[2],rc[0],rc[1],ed),Zb.selectAll(".centroid").raise(),Zb.selectAll(".clustering-centroid").raise(),pa(a),b)xc.innerHTML=xc.innerHTML.slice(xc.innerHTML.indexOf("<br><br>")+8);else{for(var l in f)Oc[l].ci=f[l];Qa(a),ga(a)}if(a<0)if(document.getElementById("replayer").innerHTML=Tb.convergence,document.getElementById("replayer").style.color="green",jd){var m=document.getElementById("replay-select").options;for(d=0;d<m.length;d++)if(m[d].selected){var n=m[d].value.split("-")[0];n==Gb&&(document.getElementById("replaydragdrop").innerHTML=Tb.dragon);break}}else document.getElementById("replaydragdrop").innerHTML=Tb.dragon;else document.getElementById("replayer").innerHTML=Tb.iteration+" "+a,document.getElementById("replayer").style.color="black",document.getElementById("replaydragdrop").innerHTML=Tb.dragoff}function Ca(){var a=document.getElementById("anim-controls");a.appendChild(document.createTextNode(Tb.runkmeans));var b=document.createElement("p");b.innerHTML="&nbsp",b.id="clustering",a.appendChild(b);var c=document.createElement("p");c.innerHTML="&nbsp",c.id="dragdrop",c.style.marginTop="-12px",a.appendChild(c);var d=document.createElement("button");d.id="play-pause",d.style.marginLeft="5px",d.style.marginRight="5px",d.innerHTML="&#9654",d.addEventListener("click",Fa),d.disabled=!0;var e=document.createElement("button");e.id="play-step",e.style.marginLeft="5px",e.innerHTML="&#9654&nbsp&nbsp&#9614",e.addEventListener("click",Ea.bind(this,d)),e.disabled=!0,a.appendChild(e),a.appendChild(d);var f=document.createElement("button");return f.id="stop",f.style.marginTop="5px",f.style.marginLeft="5px",f.innerHTML=Tb.reset,f.addEventListener("click",Da),a.appendChild(f),a}function Da(){Gc=!1,Hc=0,clearInterval(Ic),Ic=void 0,dd.clusterId=Date.now(),uc.removeAttribute("disabled"),3==vc?(uc.noUiSlider.set(2),setTimeout(function(){uc.noUiSlider.set(1),vc=1},ed)):(uc.noUiSlider.set(1),vc=1),document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("dragdrop").innerHTML="&nbsp",document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("play-pause").disabled=!0,document.getElementById("play-step").disabled=!0,document.getElementById("num-clusters")&&(document.getElementById("num-clusters").readOnly=!1,document.getElementById("num-clusters").value=""),Vb.selectAll(".clustering-centroid").transition(Wb).style.display="none",Vb.selectAll(".cluster-hull").transition(Wb).style.display="none",setTimeout(function(){Vb.selectAll(".clustering-centroid").remove(),Vb.selectAll(".cluster-hull").remove(),wa()},ed);for(var a in Oc)Oc[a].ci=void 0}function Ea(a){3==vc&&(Ic?(clearInterval(Ic),Ic=void 0,a.innerHTML="&#9654",uc.removeAttribute("disabled")):Ga())}function Fa(){3==vc&&(Ic?(clearInterval(Ic),Ic=void 0,this.innerHTML="&#9654",uc.removeAttribute("disabled")):(Ic=setInterval(Ga,1e3),this.innerHTML="&#9613&#9613",uc.setAttribute("disabled",!0)))}function Ga(){if(0==Hc){Gc=!0;var a=document.getElementById("num-clusters"),b=parseInt(a.value);(isNaN(b)||b<2)&&(b=3);var c={};for(var d in Nc)c[Nc[d].x+"_"+Nc[d].y]=1;for(;b>Object.keys(c).length;)b--;a.value=b,a.readOnly=!0,Pc=[],Qc=null;var e,f;for(e=0,f=0;e<b;e++)if(f<Ec.length)Pc[e]=Ha(null,Ec[f++]);else{for(var g;!g;)g=Bc[Math.floor(Yb.random()*Bc.length)],g=Ec.includes(g)?void 0:g;Pc[e]=Ha(null,g)}Ia(),document.getElementById("clustering").innerHTML=Tb.randcentroids,document.getElementById("dragdrop").innerHTML=Tb.dragoff,document.getElementById("clustering").style.color="black";var h=Qa(Hc);dd.iteration=Hc,Ra(h)}else Na(Hc),Ta(ed);Hc++,document.getElementById("clustering").innerHTML==Tb.convergence&&(clearInterval(Ic),Ic=void 0,uc.removeAttribute("disabled"),document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("play-pause").disabled=!0,document.getElementById("play-step").disabled=!0)}function Ha(a,b){var c,d,e,f,g=100,h=$b-g,i=g,j=_b-g,k=g,l=0;if(a)for(;l<100;)c=Math.floor(Math.random()*(h-i)+i),d=Math.floor(Math.random()*(j-k)+k),e=c-a.x,f=d-a.y,l=Math.sqrt(e*e+f*f);else c=Math.floor(Math.random()*(h-i)+i),d=Math.floor(Math.random()*(j-k)+k);return{x:c,y:d,colour:b}}function Ia(){Vb.selectAll(".clustering-centroid").remove();var a,b,c,d=14;for(a=0;a<Pc.length;a++)b=Pc[a].x,c=Pc[a].y,Zb.append("line").attr("class","clustering-centroid").attr("id","cluster1-"+a).attr("x1",b-d).attr("y1",c-d).attr("x2",b+d).attr("y2",c+d).style("stroke",Pc[a].colour).style("stroke-width","5px").on("click",ma).on("click.centroidClick",nb.bind(this,-1*(a+1),a,!0)).on("mouseover",Ka.bind(this,a,!1)),Zb.append("line").attr("class","clustering-centroid").attr("id","cluster2-"+a).attr("x1",b+d).attr("y1",c-d).attr("x2",b-d).attr("y2",c+d).style("stroke",Pc[a].colour).style("stroke-width","5px").on("click",ma).on("click.centroidClick",nb.bind(this,-1*(a+1),a,!0)).on("mouseover",Ka.bind(this,a,!1))}function Ja(a,b,c){var d,e,f,g,h,i,j={};for(d in a)for(i=lc[0];i<ic.edges[d].length&&i<=lc[1];i++)e=ic.edges[d][i],"string"==typeof e.source?(f=parseInt(e.source),g=parseInt(e.target)):(f=e.source.id,g=e.target.id),b[f]||b[g]||(h=f+"_"+g,f>g&&(h=g+"_"+f),j[h]?j[h][d]?j[h][d]++:j[h][d]=1:(j[h]={},j[h][d]=1));var k,l,m=[];for(k in j)if(Object.keys(j[k]).length==c){var n=Number.MAX_SAFE_INTEGER;for(l in j[k])n>j[k][l]&&(n=j[k][l]);var o=k.split("_");m[m.length]={source:o[0],target:o[1],weight:n,colour:"black"}}for(i=0;i<ic.links.length;i++)m[m.length]=ic.links[i];return m}function Ka(a,b){cc.remove(),Rc=!0,Sc=!1,Tc=!0,Zb.on("click",La);var c,d={};if(b){var e=ja();for(c in od[e])od[e][c]==a&&(d[c]=c)}else for(c in Oc)Oc[c].ci==a&&(d[c]=c);var f,g=Object.keys(d).length,h={};for(f=0;f<ic.nodes.length;f++)ic.nodes[f].visible||(h[ic.nodes[f].id]=1);var i=Ja(d,h,g);bc.style("display","block").style("opacity",1).on("mouseover",n).on("mouseout",q),ac.force("link").links(i),m(i),cc.on("mouseover",Ma).on("mouseout",q),ac.restart(),setTimeout(function(){ac.stop(),cc.lower(),Vb.selectAll(".cluster-hull").lower()},10)}function La(){Rc=!1,Sc=!0,Tc=!1,cc.remove(),bc.style("display","none").on("mouseover",null).on("mouseout",null),Zb.on("click",null)}function Ma(a){"black"==a.colour&&(cc.on("mouseover",null),bc.on("mouseover",null).on("mouseout",null),Vb.selectAll(".clustering-centroid").on("mouseover",null),n(a.source),Uc=!0,n(a.target,!0),Uc=!1)}function Na(a){if(document.getElementById("clustering").innerHTML!=Tb.convergence){if(0==Object.keys(Oc).length)return void(document.getElementById("clustering").innerHTML=Tb.convergence);var b,c,d,e,f=Tb.iteration+": "+a;for(b in Oc)Oc[b].ci=jb(Oc[b]);var g=[];for(c=0;c<Pc.length;c++)g[c]=Oa(c);Qc=Pc,Pc=g;var h=!1;if(Qc){var i=0;for(c=0;c<Pc.length;c++)d=Qc[c].x-Pc[c].x,e=Qc[c].y-Pc[c].y,i+=Math.sqrt(d*d+e*e);i<=Yc&&(f=Tb.convergence,document.getElementById("clustering").style.color="green",h=!0)}document.getElementById("clustering").innerHTML=f,document.getElementById("dragdrop").innerHTML=a>0&&!h?Tb.dragon:Tb.dragoff;var j=Qa(a);dd.iteration=h?-1:a,Ra(j)}}function Oa(a){var b,c=[],d={};for(b in Oc)Oc[b].ci==a&&(c[c.length]=[Oc[b].x,Oc[b].y],d[Oc[b].x+"_"+Oc[b].y]={x:Oc[b].x,y:Oc[b].y,colour:Pc[a].colour});if(Zb.selectAll("#hull-"+a).remove(),Y(d,a,!1,!1),Zb.selectAll(".centroid").raise(),Zb.selectAll(".clustering-centroid").raise(),0==Object.keys(d).length)return Ha(Pc[a],Pc[a].colour);var e=Pa(c);return e.colour=Pc[a].colour,e}function Pa(a){if(0==a.length)return null;var b,c=0,d=0;for(b=0;b<a.length;b++)c+=a[b][0],d+=a[b][1];return{x:c/a.length,y:d/a.length}}function Qa(a){var b=Tb.numstudents+": "+Object.keys(Oc).length+"<br>"+Tb.numofclusters+": "+Pc.length+"<br>"+Tb.iteration+": "+a+"<br>";document.getElementById("clustering")&&document.getElementById("clustering").innerHTML==Tb.convergence&&(b+='<span style="color:green">'+Tb.convergence+"</span><br>");var c,d,e,f,g,h,i=[];for(c=0;c<Pc.length;c++){d=Pc[c].x-$b/2,e=Pc[c].y-_b/2,f=Math.sqrt(d*d+e*e),h=Pc[c].colour,b+=Tb.disttocluster+' <span style="color:'+h+'">'+h+"</span>: "+Math.round(f,2)+"<br>"+Tb.cluster+" "+h+" "+Tb.members+": [",i[c]=[];for(g in Oc)Oc[g].ci==c&&(b+=g+", ",i[c][i[c].length]=g);-1!=b.indexOf(",",b.length-3)&&(b=b.slice(0,-2)),b+="]<br>"}return b+="<br>",xc.innerHTML=b+xc.innerHTML,i}function Ra(a){var b,c,d,e={clusterCoords:[]};for(b=0;b<a.length;b++)for(e.clusterCoords[b]=Sa(Pc[b]),e.clusterCoords[b].num=b,c=0;c<a[b].length;c++)d=Sa(Oc[a[b][c]]),a[b][c]={id:Rb[a[b][c]],num:b,x:d.x,y:d.y};e.members=a,e.iteration=dd.iteration,e.clusterId=dd.clusterId,e.coordsid=Pb,e.usegeometric=ld?1:0,(0!=lc[0]||lc[1]!=ic.maxSession)&&e.iteration<0&&(e.iteration=Hc),x(pb,e)}function Sa(a){var b=(a.x-$b/2)/dd.scale+dd.centre.x,c=(a.y-_b/2)/dd.scale+dd.centre.y;return b=(b-dd.originalx)/dd.distance,c=(c-dd.originaly)/dd.distance,{x:b,y:c}}function Ta(a){var b,c,d,e=14;for(b=0;b<Pc.length;b++)c=Pc[b].x,d=Pc[b].y,Vb.select("#cluster1-"+b).transition().duration(a).attr("x1",c-e).attr("y1",d-e).attr("x2",c+e).attr("y2",d+e),Vb.select("#cluster2-"+b).transition().duration(a).attr("x1",c+e).attr("y1",d-e).attr("x2",c-e).attr("y2",d+e)}function Ua(a,b){uc=document.getElementById("cluster-slider"),Xb.create(uc,{start:[1],handles:1,range:{min:1,max:3},step:1,orientation:"vertical",direction:"rtl",pips:{mode:"steps",stepped:!0,density:100,filter:function(){return 1},format:{to:function(b){switch(b){case 1:return Tb.showcentroids;case 2:return Tb.removegraph;case 3:return a;default:return""}},from:function(){return""}}}}),uc.noUiSlider.on("update",Wa),uc.style="margin-top: 20px;";var c=nc.getBoundingClientRect().height,d=b.getBoundingClientRect().height;uc.style.height=_b-c-d-120+"px";var e=document.createElement("input");e.type="radio",e.name="centroid-type",e.value="geometric",e.style="margin-top: 40px",e.checked=!0,e.addEventListener("click",Va);var f=document.createElement("label");f.appendChild(e),f.appendChild(document.createTextNode(Tb.geometrics)),uc.appendChild(f),0==Object.keys(Db).length&&(e=document.createElement("input"),e.type="radio",e.name="centroid-type",e.value="decomposed",e.addEventListener("click",Va),f=document.createElement("label"),f.appendChild(e),f.appendChild(document.createTextNode(Tb.decomposed)),uc.appendChild(f))}function Va(){ld="geometric"==this.value,Zb.selectAll(".centroid").remove();var a,b=[],c=0;for(a in Nc)b[c++]={value:a,selected:!0,colour:Nc[a].colour};ld?X(b):W(b),$()}function Wa(a,b){var c,d;switch(parseInt(a[b])){case 1:if(3==vc){uc.noUiSlider.set(2);break}if(vc=1,Xa(),!Gc){c=document.getElementsByName("centroid-type");for(d in c)c[d].disabled=!1}break;case 2:vc=2,Ya(),c=document.getElementsByName("centroid-type");for(d in c)c[d].disabled=!0;document.getElementById("play-pause").disabled=!0,document.getElementById("play-step").disabled=!0,document.getElementById("dragdrop").innerHTML==Tb.dragon&&(document.getElementById("dragdrop").innerHTML="--");break;case 3:if(1==vc){uc.noUiSlider.set(2);break}if(vc=3,Za(),!Gc){var e='<input type="text" placeholder="'+Tb.numclusters+'" id="num-clusters" size="8" pattern="[0-9]{1,2}">';document.getElementById("cluster-text").innerHTML=e}document.getElementById("play-pause").disabled=!1,document.getElementById("play-step").disabled=!1,document.getElementById("clustering").innerHTML==Tb.convergence&&(document.getElementById("play-pause").disabled=!0,document.getElementById("play-step").disabled=!0),"--"==document.getElementById("dragdrop").innerHTML&&(document.getElementById("dragdrop").innerHTML=Tb.dragon)}}function Xa(){R(!1),bc.on("mouseover",null).on("mouseout",null),$a(1,0,0,ed),setTimeout(function(){Vb.selectAll(".centroid").raise()},100)}function Ya(){bc.transition(Wb).style("opacity",0),cc.transition(Wb).style("opacity",0),Vb.selectAll(".clustering-centroid").transition(Wb).style("opacity",0),Vb.selectAll(".cluster-hull").transition(Wb).style("opacity",0),setTimeout(function(){bc.style("display","none"),cc.style("display","none"),Vb.selectAll(".clustering-centroid").style("display","none"),Vb.selectAll(".cluster-hull").style("display","none")},ed),!Gc&&document.getElementById("cluster-text")&&(document.getElementById("cluster-text").innerHTML=Tb.numclusters);var a=_a();null!==a&&(dd.scale=a[2],rc=a,setTimeout(function(){$a(a[2],a[0],a[1],ed)},ed/2))}function Za(){Vb.selectAll(".clustering-centroid").transition(Wb).style("display","block").style("opacity",1),Vb.selectAll(".cluster-hull").transition(Wb).style("display","block").style("opacity",1),Vb.selectAll(".clustering-centroid").raise()}function $a(a,b,c,d){var e,f,g,h,i,j,k=14,l=$b/2,m=_b/2;if(!Oc){Oc={};for(j in Nc)Oc[j]={x:0,y:0}}dd.centre={x:b,y:c};for(j in Nc)e=Nc[j].x,f=Nc[j].y,g=(e-b)*a,h=(f-c)*a,1==a&&0==b&&0==c?(e=b+g,f=c+h):(e=l+g,f=m+h),Oc[j].x=e,Oc[j].y=f,i=e+","+(f-k)+" "+(e+k)+","+(f+k)+" "+(e-k)+","+(f+k),Vb.select("#centroid-"+j).transition().duration(d).attr("points",i);var n=function(a,b){return a*=dd.distance,a+=dd.originalx,b*=dd.distance,b+=dd.originaly,a-=dd.centre.x,a*=dd.scale,a+=$b/2,b-=dd.centre.y,b*=dd.scale,b+=_b/2,{x:a,y:b}};for(j in nd){var o=n(nd[j].x,nd[j].y);e=o.x,f=o.y,Vb.select("#server-centroid-"+j).transition().duration(d).attr("cx",e).attr("cy",f)}}function _a(){var a,b=[];if(oc)return ab();for(a in Nc)b[b.length]=[Nc[a].x,Nc[a].y];var c=bb(b);if(null===c)return null;var d,e,f,g,h=[c.x,c.y],i=0,j=0;for(a in Nc)d=Math.abs(Nc[a].x-h[0]),e=Math.abs(Nc[a].y-h[1]),d>i&&(i=d,f=a),e>j&&(j=e,g=a);if(void 0===g&&void 0===f)return h[2]=1,h;var k=Nc[f].x-h[0]+$b/2,l=Nc[f].y-h[1]+_b/2,m=cb(k,l,$b/2,_b/2);k=Nc[g].x-h[0]+$b/2,l=Nc[g].y-h[1]+_b/2;var n=cb(k,l,$b/2,_b/2);return h[2]=m<n?m:n,h[2]*=.9,h}function ab(){var a,b=[],c=0,d=0;for(a in qc)if(!(a>=0&&1!=a))for(var e in qc[a])for(var f in qc[a][e].members)c=qc[a][e].members[f].x,c=c*Eb+dd.originalx,d=qc[a][e].members[f].y,d=d*Eb+dd.originaly,b[b.length]=[c,d];var g=bb(b);if(null===g)return null;var h,i,j,k,l,m=[g.x,g.y],n=0,o=0;for(l=0;l<b.length;l++)h=Math.abs(b[l][0]-m[0]),i=Math.abs(b[l][1]-m[1]),h>n&&(n=h,j=l),i>o&&(o=i,k=l);if(void 0===k&&void 0===j)return m[2]=1,m;var p=b[j][0]-m[0]+$b/2,q=b[j][1]-m[1]+_b/2,r=cb(p,q,$b/2,_b/2);p=b[k][0]-m[0]+$b/2,q=b[k][1]-m[1]+_b/2;var s=cb(p,q,$b/2,_b/2);return m[2]=r<s?r:s,m[2]*=.9,m}function bb(a){if(0==a.length)return null;if(1==a.length)return{x:a[0][0],y:a[0][1]};var b,c,d,e=0,f=0,g=$b,h=_b;for(b=0;b<a.length;b++)c=a[b][0],d=a[b][1],c>e&&(e=c),c<g&&(g=c),d>f&&(f=d),d<h&&(h=d);return{x:(e+g)/2,y:(f+h)/2}}function cb(a,b,c,d){var e=a-c,f=b-d,g=e>0?$b:0,h=f>0?_b:0,i=(g-$b/2)/e,j=(h-_b/2)/f;return isFinite(i)&&isFinite(j)&&i<=j?i:isFinite(i)&&!isFinite(j)?i:isFinite(j)?j:1}function db(){var a=document.getElementById("log-panel");a.style.width=xb+"px";var b=document.createElement("button");b.innerHTML=Tb.copy,b.addEventListener("click",function(){window.getSelection().selectAllChildren(xc),document.execCommand("copy")}),Wc?b.style.marginLeft="10px":(b.style.position="absolute",b.style.right=xb-40+"px"),a.appendChild(b);var c=document.createElement("button");c.innerHTML=Tb.print,c.addEventListener("click",function(){var a=window.open();a.document.write("<html><head></head><body>"),a.document.write(xc.innerHTML),a.document.write("</body></html>"),a.print(),a.close()}),Wc?c.style.marginLeft="10px":(c.style.position="absolute",c.style.right=xb-100+"px"),a.appendChild(c),xc=document.createElement("div"),xc.readOnly=!0,xc.style.overflow="scroll",xc.style.width="200px",xc.style.height=_b+"px",xc.style.resize="none",xc.style.border="2px solid black",Wc||(xc.style.position="absolute",xc.style.right="6px",xc.style.top="60px"),a.appendChild(xc)}function eb(){var a;for(a in Nc)Zb.append("polygon").attr("class","centroid").attr("id","centroid-"+a).attr("points",fb(Nc[a].x,Nc[a].y)).style("stroke","black").style("stroke-width","3px").style("fill",Nc[a].colour).call(Vb.drag().on("start",gb.bind(this,a)).on("drag",hb.bind(this,a)).on("end",ib.bind(this,a))).on("mouseout",lb).on("mouseover",mb.bind(this,a)).on("click",ma).on("click.centroidClick",nb.bind(this,Rb[a],a,!1));if(md)for(a in nd){var b=nd[a].x*dd.distance+dd.originalx,c=nd[a].y*dd.distance+dd.originaly;Zb.append("circle").attr("class","server-centroid").attr("id","server-centroid-"+a).attr("r",5).attr("cx",b).attr("cy",c).style("fill","black")}}function fb(a,b){var c=14;return a+","+(b-c)+" "+(a+c)+","+(b+c)+" "+(a-c)+","+(b+c)}function gb(a){kb()&&(hd=Date.now(),Zb.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+a).attr("points",fb(Vb.event.x,Vb.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",Nc[a].colour).style("opacity",.5))}function hb(a){kb()&&Vb.select("#dragged-"+a).attr("points",fb(Vb.event.x,Vb.event.y))}function ib(a){if(Vb.selectAll(".dragged-centroid").remove(),kb()){if(Date.now()-hd<300)return void nb(Rb[a],a,!1);Oc[a].ci=jb(Vb.event);for(var b=[],c=0;c<Pc.length;c++)b[c]=Oa(c);Qc=Pc,Pc=b,Ta(ed);var d=Tb.iteration+": "+Hc;document.getElementById("clustering").innerHTML=d,document.getElementById("dragdrop").innerHTML=Tb.dragon;var e=Qa(Hc);dd.iteration=Hc++,Ra(e)}}function jb(a){for(var b,c,d,e=Number.MAX_SAFE_INTEGER,f=-1,g=0;g<Pc.length;g++)c=a.x-Pc[g].x,d=a.y-Pc[g].y,(b=Math.sqrt(c*c+d*d))<e&&(e=b,f=g);return f}function kb(){if(!Pc||!document.getElementById("clustering"))return!1;if(document.getElementById("clustering").innerHTML==Tb.convergence)return!1;for(var a in Oc)if(void 0===Oc[a].ci)return!1;return 3==vc}function lb(){Rc||(Vb.selectAll(".text").remove(),Vb.selectAll("rect").remove(),Gc&&(oc||3==vc)&&null!==ja()&&(bc.style("display","none").style("opacity",0),cc.remove()))}function mb(a){if(!Rc){Vb.selectAll(".text").remove(),Vb.selectAll("rect").remove();var b=Zb.append("rect"),c=[0],d=1==vc?Nc:Oc,e=a;ub.forEach(function(b){b.id==a&&(e=1==Xc?b.firstname+" "+b.lastname:b.id)});var f=1==Xc?70:30,g=Zb.append("text").attr("class","text").attr("id","t-"+a).attr("y",d[a].y+32).attr("dy",".40em").style("pointer-events","none").text(e).call(o,f,d[a].x-(f+6)/2+8,c),h=18*c[0]+16;if(h+d[a].y+10>=_b&&g.attr("y",_b-h-(_b-d[a].y)).text(e).call(o,f,d[a].x-(f+6)/2+8,c),b.attr("id","r-"+a).attr("x",d[a].x-(f+6)/2).attr("y",h+d[a].y+10<=_b?d[a].y+16:_b-h-16-(_b-d[a].y)).attr("width",f+16).attr("height",h).style("stroke","black").style("fill","yellow"),Gc&&(oc||3==vc)&&null!==ja()){cc.remove();var i,j={};for(i=0;i<ic.nodes.length;i++)ic.nodes[i].visible||(j[ic.nodes[i].id]=1);var k,l,n,p,q={};for(i=lc[0];i<ic.edges[a].length&&i<=lc[1];i++)k=ic.edges[a][i],"string"==typeof k.source?(l=parseInt(k.source),n=parseInt(k.target)):(l=k.source.id,n=k.target.id),j[l]||j[n]||(p=l+"_"+n,q[p]?q[p]++:q[p]=1);var r,s=[],t=ic.edges[a][0].colour;for(k in q)r=k.split("_"),s[s.length]={source:r[0],target:r[1],weight:q[k],colour:t};for(i=0;i<ic.links.length;i++)s[s.length]=ic.links[i];ac.force("link").links(s),m(s),bc.style("display","block").style("opacity",1),ac.restart(),setTimeout(function(){ac.stop(),bc.lower(),cc.lower()},1)}}}function nb(a,b,c){if(Gc&&!document.getElementById("textbox-"+a)&&null!==ja()&&(oc||!Gc||3==vc)){var d=document.createElement("textarea");d.id="textbox-"+a,d.style.resize="both",d.style.position="absolute",Qb[a]&&(d.value=Qb[a]),id!=Gb&&(d.readOnly=!0),document.body.appendChild(d);var e,f=d.getBoundingClientRect(),g=document.getElementsByTagName("svg")[0].getBoundingClientRect(),h=c?Pc[b].x:Oc[b].x;e=h+f.width/2>=$b?h+g.x-f.width:h-f.width/2<=0?h+g.x:h+g.x-f.width/2,d.style.left=e+"px";var i=c?Pc[b].y:Oc[b].y,j=i+190>=_b?i+140:i+290;c&&(j=i+165>=_b?i+165:i+265),d.style.top=j+"px";var k=document.createElement("button");k.innerHTML=id==Gb?Tb.save:Tb.close,k.id=a,k.style.position="absolute",k.style.left=e+"px",k.style.top=j+f.height+"px",document.body.appendChild(k),d.focus(),d.addEventListener("click",function(){this.parentNode.appendChild(this),k.parentNode.appendChild(k),this.focus()});var l=!1;d.addEventListener("mousedown",function(){l=!0}),d.addEventListener("mouseup",function(){l=!1}),d.addEventListener("mousemove",function(){l&&(f=this.getBoundingClientRect(),k.style.left=e+"px",k.style.top=j+f.height+"px")}),k.addEventListener("click",function(){if(id==Gb){var b={coordsid:Pb,clusterid:dd.clusterId,studentid:a,remark:d.value};""!=d.value&&d.value!=Qb[a]&&(Qb[a]=d.value,x(qb,b))}document.body.removeChild(d),document.body.removeChild(k)})}}var ob,pb,qb,rb,sb,tb,ub,vb,wb,xb,yb,zb,Ab,Bb,Cb,Db,Eb,Fb,Gb,Hb,Ib,Jb,Kb,Lb,Mb,Nb,Ob,Pb,Qb,Rb,Sb,Tb,Ub,Vb,Wb,Xb,Yb,Zb,$b,_b,ac,bc,cc,dc,ec,fc,gc,hc,ic,jc,kc,lc,mc,nc,oc,pc,qc,rc,sc,tc,uc,vc,wc,xc,yc,zc,Ac,Bc,Cc,Dc,Ec,Fc,Gc,Hc,Ic,Jc,Kc,Lc,Mc,Nc,Oc,Pc,Qc,Rc,Sc,Tc,Uc,Vc,Wc,Xc,Yc,Zc,$c,_c,ad,bd,cd,dd,ed,fd,gd,hd,id,jd,kd,ld,md,nd,od={},pd=[];b(a)}});