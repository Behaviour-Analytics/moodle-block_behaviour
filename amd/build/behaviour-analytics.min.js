!function(e){"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?module.exports=e():window.behaviourAnalytics=e()}(function(){return function(e){var t,n,r,o,i,l,a,s,c,u,m,v,g,p,f,h,x,b,k,E,w,I,L,T,M,C,A,B,H,S,N,O,F,_,j,q,R,D,z,U,P,W,X,G,J,Y,Z,K,Q,V,$,ee,te,ne,re,oe,ie,le,ae,se,ce,de,ue,me,ve,ye,ge,pe,fe,he,xe,be,ke,Ee,we,Ie,Le,Te,Me,Ce,Ae,Be,He,Se,Ne,Oe,Fe,_e,je,qe,Re,De,ze,Ue,Pe,We,Xe,Ge,Je,Ye,Ze,Ke,Qe,Ve={},$e=[];function et(){a.forEach(function(e){for(;!ye[e.entype];){var t=me[Math.floor(F.random()*me.length)],n=!0;for(var r in ye)ye[r]==t&&(n=!1);ye[e.entype]=n?t:void 0}})}function tt(){J={nodes:[],links:[],edges:{},maxSession:0},nt(),rt()}function nt(){var e,t,n,r=J,o={};a.forEach(function(i){e=!0,t=void 0,n=void 0,g[i.id]?(e=1==g[i.id].visible&&1==g["g"+i.sect].visible,1!=g[i.id].visible||e||(g[i.id].visible=0),t=g[i.id].xcoord,n=g[i.id].ycoord):g["g"+i.sect]&&(e=1==g["g"+i.sect].visible&&h==L),r.nodes[r.nodes.length]={id:i.id,name:i.name,group:i.sect,type:i.type,entype:i.entype,colour:ye[i.entype],visible:e,xcoord:t,ycoord:n},o[i.sect]||(g["g"+i.sect]&&(e=1==g["g"+i.sect].visible,t=g["g"+i.sect].xcoord,n=g["g"+i.sect].ycoord),o[i.sect]={id:"g"+i.sect,name:B.section+" "+i.sect,group:i.sect,type:"grouping",colour:ye.grouping,visible:e,xcoord:t,ycoord:n},r.nodes[r.nodes.length]=o[i.sect]),r.links[r.links.length]={source:"g"+i.sect,target:i.id,weight:P,colour:ye.originalLinks}}),t=n=void 0,g.root&&(t=g.root.xcoord,n=g.root.ycoord);var i={id:"root",name:u,group:-1,type:"grouping",colour:ye.grouping,visible:!0,xcoord:t,ycoord:n};if(Object.keys(o).length>1)for(var l in o)r.links[r.links.length]={source:"root",target:o[l].id,weight:P,colour:ye.originalLinks};else r.nodes=r.nodes.filter(function(e){return"g0"!=e.id}),r.links.forEach(function(e){"g0"==e.source&&(e.source="root")});r.nodes[r.nodes.length]=i}function rt(){var e,t=J,n=0,r=0;Ye={};for(var o=0;o<i.length;o++)e={source:i[o].moduleId,target:i[o].moduleId,weight:P,user:i[o].userId,colour:""},t.edges[i[o].userId]||(t.edges[i[o].userId]=[],Ye[i[o].userId]=[],t.maxSession=t.maxSession<n?n:t.maxSession,n=0,r=0),g[i[o].moduleId]&&1==g[i[o].moduleId].visible&&(Ye[i[o].userId][r++]=i[o].moduleId),o+1<i.length&&i[o].userId==i[o+1].userId?(e.target=i[o+1].moduleId,t.edges[i[o].userId][n++]=e):0==t.edges[i[o].userId].length&&(t.edges[i[o].userId][n++]=e);t.maxSession=t.maxSession<n?n:t.maxSession,l.forEach(function(e){t.edges[e.id]||(t.edges[e.id]=[])})}function ot(e=0){_=S.select("#graph").append("svg").attr("width",j).attr("height",q),U=S.forceLink(J.links).id(e=>e.id).strength(e),R=S.forceSimulation(J.nodes).force("link",U).force("charge",S.forceManyBody().strength(-80)).force("collide",S.forceCollide().radius(12)).force("center",S.forceCenter(j/2,q/2)).force("x",S.forceX()).force("y",S.forceY()),it(J.nodes,Re,_e,je,qe),lt(J.links),_.on("click",function(){S.selectAll("#rctext").remove(),S.selectAll("#rcrect").remove(),(pe||v)&&D.on("mouseover",at).on("mouseout",ct),$&&D.on("mouseover",null).on("mouseout",null)}),Pe&&v&&Object.keys(g).length>0?R.on("tick",ut):R.on("tick",mt);for(var t=0;t<80;t++)R.tick();v&&setTimeout(function(){R.stop(),R.on("tick",mt),vt(),0!=Object.keys(g).length&&Pe||(yt(),J.edges={},rt(),Pe=!0,P=pe?1:0)},500),pe&&!Pe&&setTimeout(function(){J.nodes=[],J.links=[],nt()},600)}function it(e,t,n,r,o){D=_.selectAll(".node").data(e).enter().append("circle").attr("class","node").attr("r",De).on("mouseover",at).on("mouseout",ct).on("contextmenu",t).call(S.drag().on("start",n).on("drag",r).on("end",o))}function lt(e){z=_.selectAll(".link").data(e).enter().append("line").attr("class","link").style("stroke",function(e){return e.colour}).style("stroke-width",function(e){return 2*e.weight+"px"})}function at(e,t=!1){if(!(Ae||(D.on("mouseover",null),t||(S.selectAll(".text").remove(),S.selectAll("rect").remove()),Date.now()-Fe<150))){var n=[0],r=!1,o=!1,i=!1,l=304,a=154,s=e.type+"_"+e.name;Be&&(l=0,a=0);var c=_.append("text").attr("class","text").attr("id","t-"+e.id).attr("y",e.y+32).attr("dy",".40em").style("pointer-events","none").text(s).call(st,150,e.x-78+8,n),d=16*n[0]+16;d+e.y>=q-a&&(c.attr("y",q-d-(q-e.y)).text(s).call(st,150,e.x-78+8,n),r=!0),e.x<=l/2?(c.text(s).call(st,150,e.x+8,n),i=!0):e.x>=j-l/2&&(c.text(s).call(st,150,e.x-156+8,n),o=!0);var u=_.append("rect").attr("id","r-"+e.id).attr("x",i?e.x:o?e.x-156:e.x-78).attr("y",r?q-d-16-(q-e.y):e.y+16).attr("width",166).attr("height",d).style("stroke","black").style("fill","yellow");c.raise(),isNaN(e.id)||(Be&&(l=400,a=300),function(e,t,n,r,o,i,l,a,s,c){var d=document.createElement("iframe");d.id="preview",d.style.position="absolute",d.style.width=r+"px",d.style.height=o+"px";var u=document.getElementsByTagName("svg")[0].getBoundingClientRect(),v=document.body.getBoundingClientRect();v.x>0&&v.x,d.style.left=He?window.innerWidth-10-r+"px":Be?"10px":l?s+u.x+"px":a?s+u.x+n-r+18+"px":s+u.x-r/2+n/2+"px";var y=Ne?0:50;if(d.style.top=Be?u.y-v.y+q/2+"px":i?y+c+u.y-v.y-o+"px":y+c+u.y+t-v.y+"px","lti"!=e.entype){var g=document.createElement("div");g.id="bgrnd",g.style.position="absolute",g.style.width=parseInt(d.style.width)+24+"px",g.style.height=parseInt(d.style.height)+24+"px",g.style.left=parseInt(d.style.left)-12+"px",g.style.top=parseInt(d.style.top)-12+"px",g.addEventListener("mouseout",function(e){var t=this.getBoundingClientRect();e.x>t.x&&e.x<t.x+t.width&&e.y>t.y&&e.y<t.y+t.height||(Se=!1,setTimeout(dt,750))}),g.addEventListener("mouseover",function(){Se=!0}),d.src=m+"/mod/"+e.entype+"/view.php?id="+e.id,document.body.appendChild(g),document.body.appendChild(d)}}(e,d,150,l,a,r,i,o,parseInt(u.attr("x")),parseInt(u.attr("y"))))}}function st(e,t,n,r){var o=0;e.each(function(){for(var e,r=S.select(this),i=r.text().split(/\s+/).reverse(),l=[],a=r.attr("y"),s=parseFloat(r.attr("dy")),c=r.text(null).append("tspan").attr("x",n).attr("y",a).attr("dy",s+"em");e=i.pop();)l.push(e),c.text(l.join(" ")),c.node().getComputedTextLength()>t&&(l.pop(),c.text(l.join(" ")),l=[e],c=r.append("tspan").attr("x",n).attr("y",a).attr("dy",1.1*++o+s+"em").text(e))}),r[0]=++o}function ct(e){Ae||"lightgrey"==e.colour||(D.on("mouseout",null),z.on("mouseout",null),setTimeout(dt,750))}function dt(){if(!Se&&(S.selectAll(".text").remove(),S.selectAll("rect").remove(),S.selectAll("#preview").remove(),S.selectAll("#bgrnd").remove(),D.on("mouseover",at).on("mouseout",ct),Be)){z.on("mouseover",un).on("mouseout",ct);for(var e=0;e<Te.length;e++)S.select("#cluster1-"+e).on("mouseover",cn.bind(this,e)),S.select("#cluster2-"+e).on("mouseover",cn.bind(this,e))}}function ut(){var e=j/2,t=q/2,n=p;void 0===ze.originalx?(ze.originalx=e,ze.originaly=t):(e=ze.originalx,t=ze.originaly);for(var r,o,i=0;i<J.nodes.length;i++)r=J.nodes[i].xcoord*n+e,o=J.nodes[i].ycoord*n+t,(r<0||r>j||o<0||o>q)&&(n*=.9,--i);p=n,ze.distance=n,z.attr("x1",function(r){var o=J.nodes.filter(function(e){var t="string"==typeof r.source?r.source:r.source.id;return e.id==t})[0];return S.select(this).attr("y1",o.ycoord*n+t),o.xcoord*n+e}).attr("x2",function(r){var o=J.nodes.filter(function(e){var t="string"==typeof r.target?r.target:r.target.id;return e.id==t})[0];return S.select(this).attr("y2",o.ycoord*n+t),o.xcoord*n+e}).style("display",function(e){return e.source.visible&&e.target.visible?"block":"none"}),D.attr("cx",function(t){return t.x=t.xcoord*n+e}).attr("cy",function(e){return e.y=e.ycoord*n+t}).style("display",function(e){return e.visible?"block":"none"}).style("fill",e=>e.colour).raise()}function mt(){var e=De;z.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}).style("stroke-width",function(e){return 2*e.weight+"px"}).style("display",function(e){return e.source.visible&&e.target.visible?"block":"none"}),D.attr("cx",function(t){return t.x=Math.max(e,Math.min(j-e,t.x))}).attr("cy",function(t){return t.y=Math.max(e,Math.min(q-e,t.y))}).style("fill",e=>e.colour).style("display",function(e){return e.visible?"block":"none"}).raise(),S.selectAll("rect").raise(),S.selectAll("text").raise()}function vt(){if(E){S.select("#time").remove(),0==T&&(T=Date.now());var e=new Date;e.setTime(T);var t=e.getMinutes();t<10&&(t="0"+t),_.append("text").attr("id","time").attr("y",q-16).attr("dy",".40em").attr("x",6).style("pointer-events","none").text(E[L]+" "+e.getHours()+":"+t+" "+e.toDateString())}}function yt(){var e=function(){var e,t,n,r,o={},i=0,l=j/2,a=q/2;return J.nodes.forEach(function(o){e=o.x-l,t=o.y-a,(n=Math.sqrt(e*e+t*t))>i&&(i=n,r=o)}),o.scale=i,o.module=r.id,p=i,J.nodes.forEach(function(e){o[e.id]={xcoord:""+(e.x-l)/i,ycoord:""+(e.y-a)/i,visible:e.visible?1:0},e.xcoord||(e.xcoord=(e.x-l)/i,e.ycoord=(e.y-a)/i)}),g=o,o}();if(x&&b){var n={};for(var r in e)"scale"!=r&&"module"!=r&&(n[r]=e[r]);x[h]=n,b[h]=e.scale}e.time=Date.now(),T=e.time,k&&(k[h]=e.time),gt(t,e)}function gt(e,t){var n=new XMLHttpRequest;n.open("POST",e),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){4==this.readyState&&200==this.status&&console.log(this.responseText)},n.send("cid="+f+"&data="+JSON.stringify(t)+"&sesskey="+H)}function pt(){var e=new Image,t=(new XMLSerializer).serializeToString(_.node());e.src="data:image/svg+xml;base64,"+window.btoa(t),document.body.appendChild(e);var n=document.createRange();n.setStartBefore(e),n.setEndAfter(e),n.selectNode(e),window.getSelection().addRange(n),document.execCommand("Copy"),document.body.removeChild(e)}function ft(){var e=(new XMLSerializer).serializeToString(_.node()),t=window.open();t.document.write('<img src="data:image/svg+xml;base64,'+window.btoa(e)+'"/>'),t.print(),t.close()}function ht(){for(var e,t=document.getElementById("teacher-select"),n=0;n<t.options.length;n++)if(t.options[n].selected){e=t.options[n].value;break}e==h?(_e=Tt,je=Mt,qe=Ct,Re=Lt):(_e=null,je=null,qe=null,Re=null),g=x[e],p=b[e],T=k[e],a=w[e],u=I[e],L=e,_.remove(),de={},et(),S.selectAll("#legendUL").remove(),bt(),P=1,tt(),P=0;var r=document.getElementById("weights-output").innerHTML;for(var o in ot(r=parseFloat(r.split(" ")[1])),de)g[o]&&(de[o].checked=1==g[o].visible),h==e?(de[o].removeEventListener("change",xt),de[o].addEventListener("change",wt)):(de[o].removeEventListener("change",wt),de[o].addEventListener("change",xt))}function xt(){this.checked=!this.checked}function bt(){var e;(ce=document.getElementById("legend")).style="width: "+c+"px; height: "+q+"px; min-width: "+c+"px; max-width: 500px;";var t=function(t){var n=e-t.x;e=t.x;var r=parseInt(ce.style.width)+n;r>500?r=500:r<c&&(r=c),ce.style.width=r+"px"};ce.addEventListener("mousemove",function(e){var t=ce.offsetLeft+28;e.x>=t&&e.x<=t+6?ce.style.cursor="col-resize":ce.style.cursor="auto"}),ce.addEventListener("mousedown",function(n){e=n.x,"col-resize"==ce.style.cursor&&ce.addEventListener("mousemove",t)}),document.addEventListener("mouseup",function(e){ce.removeEventListener("mousemove",t)}),function(e){var t=document.createElement("ul");t.id="legendUL";var n=document.createElement("span");n.className="no-select-text",n.innerHTML=u;var r=document.createElement("li");r.appendChild(n);var o=document.createElement("ul");r.appendChild(o),t.appendChild(r);var i,l,s,c=-1;a.forEach(function(e){c!=e.sect&&((l=document.createElement("ul")).className="nested",(s=document.createElement("span")).className="caret",s.addEventListener("click",kt),(i=document.createElement("li")).appendChild(s),Et("g"+e.sect,B.section+" "+e.sect,ye.grouping,e.sect,"grouping",i),i.appendChild(l),o.appendChild(i),c++),(i=document.createElement("li")).className="indented",Et(e.id,e.name,ye[e.entype],e.sect,e.type,i),l.appendChild(i)}),e.appendChild(t)}(ce)}function kt(){this.parentElement.querySelector(".nested").classList.toggle("active"),this.classList.toggle("caret-down")}function Et(e,t,n,r,o,i){var l=document.createElement("input");l.type="checkbox",g[e]?l.checked=0!=g[e].visible:g["g"+r]?l.checked=1==g["g"+r].visible&&h==L:l.checked=!0,l.id=e,l.group=r,l.nodeT=o,l.addEventListener("change",wt),de[l.id]=l;var a=document.createElement("label");a.style.color=n,a.className="no-select-text";var s="grouping"==o?t:o+"_"+t;a.appendChild(document.createTextNode(s)),i.appendChild(l),i.appendChild(a)}function wt(){var e=this.id,t=this.checked,n=this.nodeT,r=this.group;J.nodes.forEach(function(o){o.id==e?(o.visible=t,de[o.id].checked=t):"grouping"==n&&o.group==r?(o.visible=t,de[o.id].checked=t):t&&"grouping"==o.type&&o.group==r&&(o.visible=t,de[o.id].checked=t)}),It(),St()}function It(){parseFloat(document.getElementById("weight-slider").value)<0&&(U.strength(0),document.getElementById("weights-output").innerHTML="&nbsp;= 0",document.getElementById("weight-slider").value=0)}function Lt(e){if(S.selectAll(".text").remove(),S.selectAll("rect").remove(),S.selectAll("#preview").remove(),S.selectAll("#bgrnd").remove(),S.event.preventDefault(),"root"!=e.id){var t=e;D.on("mouseover",null).on("mouseout",null);var n=_.append("rect"),r=_.append("text").attr("class","text").attr("id","rctext").attr("x",e.x+10).attr("y",e.y+12).attr("dy",".40em").style("pointer-events","none").text(B.hide);e.y+20>=q&&r.attr("y",q-(q-e.y)-10).text(B.hide),n.attr("id","rcrect").attr("x",e.x).attr("y",e.y+20<=q?e.y:q-(q-e.y)-20).attr("width",60).attr("height",24).style("stroke","black").style("fill","lightgrey"),n.on("mouseover",function(){S.event.target.style="fill: grey;"}),n.on("mouseout",function(){S.event.target.style="fill: lightgrey;"}),n.on("click",function(){S.selectAll("#rctext").remove(),S.selectAll("#rcrect").remove(),D.on("mouseover",at).on("mouseout",ct),t.visible=!1,de[t.id].checked=!1,"grouping"==t.type&&J.nodes.forEach(function(e){e.group==t.group&&(e.visible=!1,de[e.id].checked=!1)}),It(),St()})}}function Tt(e){S.event.active||R.alphaTarget(X).restart(),e.fx=e.x,e.fy=e.y}function Mt(e){S.selectAll("rect").remove(),S.selectAll(".text").remove(),S.selectAll("#preview").remove(),S.selectAll("#bgrnd").remove(),e.fx=S.event.x,e.fy=S.event.y}function Ct(e){S.event.active||(v?(R.stop(),yt(),vt()):R.alphaTarget(G)),e.fx=null,e.fy=null,Fe=Date.now()}function At(){var e=document.getElementById("student-menu");(V=document.createElement("button")).innerHTML=B.cluster,V.addEventListener("click",zt),e.appendChild(V);var t=V.getBoundingClientRect().height;(Y=document.createElement("select")).multiple=!0,Y.id="student-select",menuHeight=q-t-12,Y.style="height: "+menuHeight+"px;",Y.addEventListener("change",function(e){for(var t=document.getElementById("student-select"),n=0;n<t.options.length;n++){var r="box-shadow: 0 0 10px 100px "+t.options[n].colour+" inset;";t.options[n].style=t.options[n].selected?r:"box-shadow: 0 0 0 0 white inset;"}i.length>0&&Nt()}),l.forEach(function(e){Bt(e,Y)}),e.appendChild(Y)}function Bt(e,t){var n=document.createElement("option");n.value=e.id,n.text=e.id,n.colour=me[ve++],ve>=me.length&&(ve=0),J.edges[e.id].forEach(function(e){e.colour=n.colour}),t.appendChild(n)}function Ht(){Z=document.getElementById("slider"),K=[0,J.maxSession];var e=J.maxSession<500?10:J.maxSession<1e3?20:J.maxSession<5e3?100:J.maxSession<1e4?200:500;O.create(Z,{start:[0,J.maxSession],range:{min:[0],max:[J.maxSession]},step:1,connect:!0,pips:{mode:"steps",stepped:!0,density:100,filter:function(t){return 0==t?1:t==J.maxSession?1:t%e==0?2:0}}}),setTimeout(function(){Z.noUiSlider.on("update",function(e,t){K[t]=parseInt(e[t]),Y.dispatchEvent(new Event("change"))})},1e3)}function St(){z.remove(),D.remove(),S.selectAll(".hull").remove();var e=Ot(Lt);Ft(e),_t(e),R.alphaTarget(W).restart(),v&&setTimeout(function(){R.stop(),yt(),vt()},100)}function Nt(e=!0){z.remove(),D.remove(),S.selectAll(".hull").remove(),v=!1;var t=Ot(null);Ft(t),e&&_t(t),v=!0,R.on("tick",ut),R.restart(),setTimeout(R.stop,100)}function Ot(e){var t=[],n={};return J.nodes.forEach(function(e){null===e.fx&&(e.fx=e.x,e.fy=e.y),e.visible?t[t.length]=e:n[e.id]=1}),R.nodes(t),it(t,e,_e,je,qe),n}function Ft(e){var t,n=[];for(var r in J.links)"string"==typeof(t=J.links[r]).source?(l=t.source,a=t.target):(l=t.source.id,a=t.target.id),e[l]||e[a]||(n[n.length]=t);var o=v?[]:document.getElementById("student-select").options;for(r=0;r<o.length;r++)if(o[r].selected){for(var i,l,a,s={},c=K[0];c<=K[1]&&J.edges[o[r].value].length>c;c++)"string"==typeof(d=J.edges[o[r].value][c]).source?(i=d.source+"_"+d.target,l=d.source,a=d.target):(i=d.source.id+"_"+d.target.id,l=d.source.id,a=d.target.id),s[i]?s[i]++:s[i]=1,e[l]||e[a]||(n[n.length]=d);for(c=K[0];c<=K[1]&&J.edges[o[r].value].length>c;c++){var d;i="string"==typeof(d=J.edges[o[r].value][c]).source?d.source+"_"+d.target:d.source.id+"_"+d.target.id,d.weight=s[i]}}R.force("link").links(n),lt(n)}function _t(e){if(!v){S.selectAll(".hull").remove();for(var t=document.getElementById("student-select").options,n={},r=0;r<t.length;r++)if(t[r].selected){var o,i,l,a,s;n[t[r].value]={};for(var c=K[0];c<=K[1]&&J.edges[t[r].value].length>c;c++){var d=J.edges[t[r].value][c];if("string"==typeof d.source){sid=d.source,tid=d.target;var u=J.nodes.find(function(e){return e.id==sid});o=u.x,i=u.y,l=(u=J.nodes.find(function(e){return e.id==tid})).x,a=u.y}else sid=d.source.id,tid=d.target.id,o=d.source.x,i=d.source.y,l=d.target.x,a=d.target.y;e[sid]||e[tid]||(s=d.colour,n[t[r].value][sid]={x:o,y:i,colour:s},n[t[r].value][tid]={x:l,y:a,colour:s})}}for(var m in n)Rt(n[m],m);pe&&(t=document.getElementById("student-select").options,Ze?qt(t):jt(t))}}function jt(e){Ie={};for(var t=0;t<e.length;t++)if(e[t].selected){var n=e[t].value;if(Ye[n].length<=K[0])continue;var r=K[0],o=Ye[n].length>K[1]+1?K[1]:Ye[n].length,i=parseInt(r/2+o/2),l=Ye[n][i],a=parseFloat(g[l].xcoord),s=parseFloat(g[l].ycoord);Ie[n]={x:a*p+ze.originalx,y:s*p+ze.originaly,colour:e[t].colour}}}function qt(e){Ie={};for(var t=0;t<e.length;t++)if(e[t].selected){var n=e[t].value;if(Ye[n].length<=K[0])continue;for(var r,o=K[0],i=Ye[n].length>K[1]+1?K[1]:Ye[n].length,l=0,a=0,s=0,c=o;c<i;c++)r=Ye[n][c],l+=parseFloat(g[r].xcoord),a+=parseFloat(g[r].ycoord),s++;Ie[n]={x:l/s*p+ze.originalx,y:a/s*p+ze.originaly,colour:e[t].colour}}}function Rt(e,t,n=!1,r=!1){if(0!=Object.keys(e).length){var o,i,l=[],a=20,s=pe?"hull":n?"manual-hull":"cluster-hull";for(var c in e)l[l.length]=[e[c].x,e[c].y],o=e[c].colour;if(1==l.length)i=function(e){var t=[e[0][0],e[0][1]-a],n=[e[0][0],e[0][1]+a];return"M "+t+" A "+[a,a,"0,0,0",n].join(",")+" A "+[a,a,"0,0,0",t].join(",")};else{if(2!=l.length){var d=S.concaveHull().padding(15);be||d.distance(ke);var u=l.length>4?d(l):[l];return i=S.line().curve(Ee),void _.selectAll("#hull-"+t).data(u).enter().append("path").attr("id","hull-"+t).attr("class",s).style("stroke",o).style("stroke-opacity",r?0:1).style("fill",o).style("fill-opacity",r?0:we).attr("d",i)}var m=function(e,t){return[t[0]-e[0],t[1]-e[1]]},v=function(e,t){return[t*e[0],t*e[1]]},y=function(e,t){return[e[0]+t[0],e[1]+t[1]]},g=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return v(e,1/t)},p=function(e,t){return v(g(e),t)};i=function(e){var t=m(e[0],e[1]),n=p(t,a),r=y(e[0],v(n,-1)),o=y(e[1],n),i=1.2*a,l=p(function(e,t){null!=t&&(e=m(e,t));var n=[-e[1],e[0]];return g(n)}(t),i),s=v(l,-1),c=y(r,s),d=y(o,s),u=y(r,l);return"M "+r+" C "+[c,d,o].join(",")+" S "+[u,r].join(",")+" Z"}}_.append("path").attr("id","hull-"+t).attr("class",s).style("stroke",o).style("stroke-opacity",r?0:1).style("fill",o).style("fill-opacity",r?0:we).attr("d",i(l))}}function Dt(){clearInterval(xe),xe=void 0,Qt(),S.selectAll(".clustering-centroid").remove(),S.selectAll(".cluster-hull").remove(),S.selectAll(".centroid").remove(),S.selectAll(".server-centroid").remove(),ie.style.display="none",document.getElementById("anim-controls").style.display="none",document.getElementById("log-panel").style.display="none",document.getElementById("student-menu").style.width=V.style.width,pe=!0,Be=!1,Z.style.display="block",Y.style.display="block",D.style("display","block"),D.style("opacity",1),z.style("display","block"),z.style("opacity",1),Nt(),D.on("mouseover",at).on("mouseout",ct),V.innerHTML=B.cluster,V.removeEventListener("click",Dt),V.addEventListener("click",zt)}function zt(){pe=!1,Z.style.display="none",Y.style.display="none",S.selectAll(".hull").remove(),S.selectAll(".text").remove(),S.selectAll("rect").remove(),document.getElementById("student-menu").style.width=ae+"px",V.innerHTML=B.graph,V.removeEventListener("click",zt),V.addEventListener("click",Dt),R.stop(),D.on("mouseover",null).on("mouseout",null).on("contextmenu",null).call(S.drag().on("start",null).on("drag",null).on("end",null)),ze.clusterId=Date.now(),M={},he=0,fe=!1,le=1,xe=void 0;var e='<p id="cluster-text">'+B.numclusters+"</p>";setTimeout(function(){if(ie)document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("cluster-text").innerHTML=e,document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("anim-controls").style.display="block",document.getElementById("log-panel").style.display="block",ie.noUiSlider.set(1),ie.style.display="block";else{var t=function(){var e=document.getElementById("anim-controls");e.appendChild(document.createTextNode(B.runkmeans));var t=document.createElement("p");t.innerHTML="&nbsp",t.id="clustering",e.appendChild(t);var n=document.createElement("button");n.id="stop",n.innerHTML="&#9606",n.addEventListener("click",rn),e.appendChild(n);var r=document.createElement("button");r.id="play-pause",r.innerHTML="&#9654",r.addEventListener("click",on);var o=document.createElement("button");return o.id="play-step",o.innerHTML="&#9654&#9614",o.addEventListener("click",function(e){3==le&&(xe?(clearInterval(xe),xe=void 0,e.innerHTML="&#9654"):ln())}.bind(this,r)),e.appendChild(o),e.appendChild(r),e}();!function(e,t){ie=document.getElementById("cluster-slider"),O.create(ie,{start:[1],handles:1,range:{min:1,max:3},step:1,orientation:"vertical",direction:"rtl",pips:{mode:"steps",stepped:!0,density:100,filter:function(){return 1},format:{to:function(t){switch(t){case 1:return B.showcentroids;case 2:return B.removegraph;case 3:return e;default:return""}},from:function(e){return""}}}}),ie.noUiSlider.on("update",hn),ie.style="margin-top: 20px;";var n=V.getBoundingClientRect().height,r=t.getBoundingClientRect().height;ie.style.height=q-n-r-120+"px";var o=document.createElement("input");o.type="checkbox",o.style="margin-top: 30px",o.addEventListener("click",function(){if(1!=le||fe)this.checked=!this.checked;else{Ze=this.checked,_.selectAll(".centroid").remove();var e=[],t=0;for(var n in Ie)e[t++]={value:n,selected:!0,colour:Ie[n].colour};Ze?qt(e):jt(e),zt()}}),ie.appendChild(o);var i=document.createElement("label");i.appendChild(document.createTextNode(B.geometrics)),ie.appendChild(i)}(e,t),Ln()}Tn()},Ue/2)}function Ut(e){Gt(e)&&(Xe=Date.now(),_.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+e).attr("points",Mn(S.event.x,S.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",Ie[e].colour).style("opacity",.5))}function Pt(e){S.select("#dragged-"+e).attr("points",Mn(S.event.x,S.event.y))}function Wt(e,t,n){if(S.selectAll(".dragged-centroid").remove(),Gt(e))if(Date.now()-Xe<300)Fn(C[e],e,!1);else{We||function(){for(var e in te)if(!(e>=0)){Ve[e]={};for(var t=0;t<te[e].length;t++)for(var n in te[e][t].members){var r=A[te[e][t].members[n].id];Ve[e][r]=t}}}();var r=Jt();if(0==Object.keys(Ve[r]).length)for(var i=0;i<te[r].length;i++)for(var l in te[r][i].members){var a=A[te[r][i].members[l].id];Ve[r][a]=i}var s=Hn(S.event);for(var c in Ve)c<=r&&(Ve[c][e]=s);Yt(r,t,n),We=!0,Xt(r),function(e){for(var t={clusterCoords:[],members:[]},n=0;n<$e.length;n++){var r=$e[n]?$e[n]:Te[n];for(var i in t.clusterCoords[n]=pn(r),t.clusterCoords[n].num=n,Ve[e])Ve[e][i]==n&&(t.members[t.members.length]={id:C[i],num:n})}t.iteration=e,t.clusterId=ze.clusterId,t.coordsid=T,gt(o,t)}(r)}}function Xt(e){if(!(e>=0)&&Ve[e]&&0!=Object.keys(Ve[e]).length){for(var t=function(e){for(var t=0,n=0,r=0,o=[],i=0;i<Te.length;i++){for(var l in Le)Le[l].ci==i&&Ve[e][l]==Le[l].ci?t++:Le[l].ci==i&&Ve[e][l]!=Le[l].ci?n++:Ve[e][l]==i&&Ve[e][l]!=Le[l].ci&&r++;var a=t/(t+n),s=t/(t+r);o[i]={tp:t,fp:n,fn:r,precision:a,recall:s,f1:a+s==0?0:2*a*s/(a+s),fhalf:a+s==0?0:1.25*a*s/(.25*a+s),f2:a+s==0?0:5*a*s/(4*a+s)},t=0,n=0,r=0}for(var i=0;i<o.length;i++)t+=o[i].tp,n+=o[i].fp,r+=o[i].fn;return a=t/(t+n),s=t/(t+r),o[o.length]={tp:t,fp:n,fn:r,precision:a,recall:s,f1:a+s==0?0:2*a*s/(a+s),fhalf:a+s==0?0:1.25*a*s/(.25*a+s),f2:a+s==0?0:5*a*s/(4*a+s)},o}(e),n=B.manualcluster+"\n",r=0;r<$e.length;r++)if($e[r]){for(var o in dx=$e[r].x-j/2,dy=$e[r].y-q/2,d=Math.sqrt(dx*dx+dy*dy),n+=B.disttocluster+" "+r+": "+Math.round(d)+"\n"+B.cluster+" "+r+" "+B.members+": [",Ve[e])Ve[e][o]==r&&(n+=o+", ");-1!=n.indexOf(",",n.length-3)&&(n=n.slice(0,-2)),n+="]\n",Je&&(n+=B.precision+": "+t[r].precision.toFixed(4)+"\n",n+=B.recall+": "+t[r].recall.toFixed(4)+"\n",n+=B.f1+": "+t[r].f1.toFixed(4)+"\n",n+=B.fhalf+": "+t[r].fhalf.toFixed(4)+"\n",n+=B.f2+": "+t[r].f2.toFixed(4)+"\n")}var i=se.value.split("\n\n"),l=i[0].split("\n");for(se.value="",r=0;r<l.length&&!l[r].startsWith(B.manualcluster);r++)se.value+=l[r]+"\n";for(Je&&(r=t.length-1,n+=B.totalmeasures+"\n",n+=B.precision+": "+t[r].precision.toFixed(4)+"\n",n+=B.recall+": "+t[r].recall.toFixed(4)+"\n",n+=B.f1+": "+t[r].f1.toFixed(4)+"\n",n+=B.fhalf+": "+t[r].fhalf.toFixed(4)+"\n",n+=B.f2+": "+t[r].f2.toFixed(4)+"\n"),se.value+=n+"\n",r=1;r<i.length;r++)se.value+=i[r]+"\n\n"}}function Gt(e){if(document.getElementById("replayer").innerHTML!=B.convergence)return!1;if(Ge!=h)return!1;var t=Le[e].ci,n=0;for(var r in Le)Le[r].ci==t&&n++;var o=Jt(),i=0;if(Ve[o])for(var r in t=Ve[o][e],Ve[o])Ve[o][r]==t&&i++;return!(1==n&&i<=1)&&1!=i}function Jt(){var e=se.value.split("\n");return e[2]&&e[2].startsWith(B.iteration)?parseInt(e[2].split(" ")[1]):null}function Yt(e,t,n){for(var r=[],o=[],i=0;i<te[e].length;i++)for(var l in r[i]={},o[i]=[],Ve[e])if(Ve[e][l]==i){var a=Le[l].x,s=Le[l].y;r[i][a+"_"+s]={x:a,y:s,colour:Te[i].colour},o[i][o[i].length]=[a,s]}var c=0==document.getElementsByClassName("manual-centroid").length;for(S.selectAll(".manual-hull").remove(),i=0;i<r.length;i++)Rt(r[i],-1*(i+1),!0,c),$e[i]=vn(o[i]);if(t)for(t[n.did]||(t[n.did]={}),t[n.did][n.gid]||(t[n.did][n.gid]={}),t[n.did][n.gid][n.cid]||(t[n.did][n.gid][n.cid]={}),t[n.did][n.gid][n.cid][e]||(t[n.did][n.gid][n.cid][e]=[]),i=0;i<$e.length;i++)if($e[i]){var d=[];for(var l in Ve[e])Ve[e][l]==i&&(d[d.length]={id:C[l],num:i});t[n.did][n.gid][n.cid][e][i]={centroidx:$e[i].x,centroidy:$e[i].y,members:d}}c?function(){S.selectAll(".manual-centroid").remove();for(var e,t,n=14,r=0;r<$e.length;r++){if(!$e[r])return;e=$e[r].x,t=$e[r].y,_.append("line").attr("class","manual-centroid").attr("id","manual1-"+r).attr("x1",e-n).attr("y1",t-n).attr("x2",e+n).attr("y2",t+n).style("stroke",Te[r].colour).style("stroke-width","5px").style("opacity",0).on("click",function(){S.event.stopPropagation()}).on("click.centroidClick",Fn.bind(this,-1*(r+1),r,!0)).on("mouseover",cn.bind(this,r,!0)),_.append("line").attr("class","manual-centroid").attr("id","manual2-"+r).attr("x1",e+n).attr("y1",t-n).attr("x2",e-n).attr("y2",t+n).style("stroke",Te[r].colour).style("stroke-width","5px").style("opacity",0).on("click",function(){S.event.stopPropagation()}).on("click.centroidClick",Fn.bind(this,-1*(r+1),r,!0)).on("mouseover",cn.bind(this,r,!0))}S.selectAll(".manual-centroid").transition().duration(Ue).style("opacity",.5),S.selectAll(".manual-hull").transition().duration(Ue).style("stroke-opacity",1).style("fill-opacity",we)}():function(){for(var e,t,n=14,r=0;r<$e.length;r++){if(!$e[r])return void S.selectAll(".manual-centroid").remove();e=$e[r].x,t=$e[r].y,S.select("#manual1-"+r).transition().duration(Ue).attr("x1",e-n).attr("y1",t-n).attr("x2",e+n).attr("y2",t+n).style("display","block"),S.select("#manual2-"+r).transition().duration(Ue).attr("x1",e+n).attr("y1",t-n).attr("x2",e-n).attr("y2",t+n).style("display","block")}}(),_.selectAll(".centroid").raise(),_.selectAll(".clustering-centroid").raise(),_.selectAll(".manual-centroid").raise()}function Zt(e,t=!1){for(var n in e)e[n].x*=ze.distance,e[n].x+=ze.originalx,e[n].y*=ze.distance,e[n].y+=ze.originaly,t&&(e[n].x-=ze.centre.x,e[n].x*=ze.scale,e[n].x+=j/2,e[n].y-=ze.centre.y,e[n].y*=ze.scale,e[n].y+=q/2)}function Kt(){_&&setTimeout(function(){_.remove(),Qt(),document.getElementById("replayer").innerHTML="&nbsp;"},500),te=void 0,Vt();for(var e=document.getElementById("replay-select"),t=0;t<e.options.length;t++)e.options[t].selected&&(e.options[t].selected=!1)}function Qt(){se.readOnly=!1,se.value="",setTimeout(function(){se.readOnly=!0},300)}function Vt(){var e=document.getElementById("replay-pause");e.innerHTML="&#9654",e.value="play",clearInterval(xe)}function $t(){if(te){var e=document.getElementById("replay-pause");"play"==e.value?(e.innerHTML="&#9613&#9613",e.value="pause",en(!1),xe=setInterval(en.bind(this,!1),1200)):Vt()}}function en(e=!0){if(te){e&&Vt();var t=++he-1;return he>re&&te[-1]&&!te[(t=re-he+1)-1]?(he--,void Vt()):t>re?(he--,void Vt()):void(1==he?(le=2,fe=!0,Ce=!1,bn()):2==he?(kn(),nn(t-1,!1,!0)):nn(t-1,!1))}}function tn(){if(te&&ne&&!(he-1<0)){Vt();var e=--he-1;he>re&&(e=re-he+1),0==he?(le=1,xn(),fe=!1,se.value=se.value.slice(se.value.indexOf("\n\n")+2),document.getElementById("replayer").innerHTML="&nbsp;"):1==he?(bn(),se.value=se.value.slice(se.value.indexOf("\n\n")+2),document.getElementById("replayer").innerHTML="&nbsp;"):nn(e-1,!0,2==he)}}function nn(e,t,n=!1){for(var r=[],o={},i=0,l={};i<te[e].length;i++,l={}){for(var a in _.selectAll("#hull-"+i).remove(),Te[i].x=te[e][i].centroidx,Te[i].y=te[e][i].centroidy,te[e][i].members){var s=te[e][i].members[a].x,c=te[e][i].members[a].y,d=A[te[e][i].members[a].id];Ie[d].x=s,Ie[d].y=c,l[s+"_"+c]={x:s,y:c,colour:Te[i].colour},o[d]=i}r[i]=l}if(Zt(Te,!0),n)sn();else{for(Zt(Ie),i=0;i<r.length;i++)Zt(r[i],!0),Rt(r[i],i);fn(Ue)}if(En(ne[2],ne[0],ne[1],Ue),_.selectAll(".centroid").raise(),_.selectAll(".clustering-centroid").raise(),function(e){if(!e||e>0)return _.selectAll(".manual-centroid").remove(),void _.selectAll(".manual-hull").remove();We&&Yt(e,null,null)}(e),t)se.value=se.value.slice(se.value.indexOf("\n\n")+2);else{for(var u in o)Le[u].ci=o[u];yn(e),Xt(e)}document.getElementById("replayer").innerHTML=e<0?B.convergence:B.iteration+" "+e}function rn(){for(var e in fe=!1,he=0,clearInterval(xe),xe=void 0,ze.clusterId=Date.now(),3==le?(ie.noUiSlider.set(2),setTimeout(function(){ie.noUiSlider.set(1),le=1},Ue)):(ie.noUiSlider.set(1),le=1),document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("num-clusters")&&(document.getElementById("num-clusters").readOnly=!1,document.getElementById("num-clusters").value=""),S.selectAll(".clustering-centroid").transition(N).style.display="none",S.selectAll(".cluster-hull").transition(N).style.display="none",setTimeout(function(){S.selectAll(".clustering-centroid").remove(),S.selectAll(".cluster-hull").remove(),Qt()},Ue),Le)Le[e].ci=void 0}function on(){3==le&&(xe?(clearInterval(xe),xe=void 0,this.innerHTML="&#9654"):(xe=setInterval(ln,1e3),this.innerHTML="&#9613&#9613"))}function ln(){if(0==he){fe=!0;var e=document.getElementById("num-clusters"),t=parseInt(e.value);for(var n in(isNaN(t)||t<2)&&(t=3),ob={},Ie)ob[Ie[n].x+"_"+Ie[n].y]=1;for(;t>Object.keys(ob).length;)t--;e.value=t,e.readOnly=!0,Te=[],Me=null;for(var r=0,o=0;r<t;r++)if(o<ge.length)Te[r]=an(null,ge[o++]);else{for(var i;!i;)i=me[Math.floor(F.random()*me.length)],i=ge.includes(i)?void 0:i;Te[r]=an(null,i)}sn(),document.getElementById("clustering").innerHTML=B.randcentroids;var l=yn(he);ze.iteration=he,gn(l)}else!function(e){if(document.getElementById("clustering").innerHTML!=B.convergence)if(0!=Object.keys(Le).length){var t=B.iteration+": "+e;for(var n in Le)Le[n].ci=Hn(Le[n]);for(var r=[],o=0;o<Te.length;o++)r[o]=mn(o);Me=Te,Te=r;var i=!1;if(Me){for(var l,a,s=0,o=0;o<Te.length;o++)l=Me[o].x-Te[o].x,a=Me[o].y-Te[o].y,s+=Math.sqrt(l*l+a*a);s<=Oe&&(t=B.convergence,i=!0)}document.getElementById("clustering").innerHTML=t;var c=yn(e);ze.iteration=i?-1:e,gn(c)}else document.getElementById("clustering").innerHTML=B.convergence}(he),fn(Ue);he++,document.getElementById("clustering").innerHTML==B.convergence&&(clearInterval(xe),xe=void 0,document.getElementById("play-pause").innerHTML="&#9654")}function an(e,t){var n,r,o,i,l=j-100,a=q-100,s=0;if(e)for(;s<100;)n=Math.floor(Math.random()*(l-100)+100),r=Math.floor(Math.random()*(a-100)+100),o=n-e.x,i=r-e.y,s=Math.sqrt(o*o+i*i);else n=Math.floor(Math.random()*(l-100)+100),r=Math.floor(Math.random()*(a-100)+100);return{x:n,y:r,colour:t}}function sn(){S.selectAll(".clustering-centroid").remove();for(var e,t,n=14,r=0;r<Te.length;r++)e=Te[r].x,t=Te[r].y,_.append("line").attr("class","clustering-centroid").attr("id","cluster1-"+r).attr("x1",e-n).attr("y1",t-n).attr("x2",e+n).attr("y2",t+n).style("stroke",Te[r].colour).style("stroke-width","5px").on("click",function(){S.event.stopPropagation()}).on("click.centroidClick",Fn.bind(this,-1*(r+1),r,!0)).on("mouseover",cn.bind(this,r)),_.append("line").attr("class","clustering-centroid").attr("id","cluster2-"+r).attr("x1",e+n).attr("y1",t-n).attr("x2",e-n).attr("y2",t+n).style("stroke",Te[r].colour).style("stroke-width","5px").on("click",function(){S.event.stopPropagation()}).on("click.centroidClick",Fn.bind(this,-1*(r+1),r,!0)).on("mouseover",cn.bind(this,r))}function cn(e,t=!1){z.remove(),Ce=!0,Ae=!1,Be=!0,_.on("click",dn);var n={};if(t){var r=Jt();for(var o in Ve[r])Ve[r][o]==e&&(n[o]=o)}else for(var o in Le)Le[o].ci==e&&(n[o]=o);for(var i=Object.keys(n).length,l={},a=0;a<J.nodes.length;a++)J.nodes[a].visible||(l[J.nodes[a].id]=1);var s={};for(var c in n){var d,u,m,v;for(a=K[0];a<J.edges[c].length&&a<=K[1];a++)"string"==typeof(d=J.edges[c][a]).source?(u=parseInt(d.source),m=parseInt(d.target)):(u=d.source.id,m=d.target.id),l[u]||l[m]||(v=u+"_"+m,u>m&&(v=m+"_"+u),s[v]?s[v][c]?s[v][c]++:s[v][c]=1:(s[v]={},s[v][c]=1))}var y=[];for(var g in s)if(Object.keys(s[g]).length==i){var p=Number.MAX_SAFE_INTEGER;for(var o in s[g])p>s[g][o]&&(p=s[g][o]);var f=g.split("_");y[y.length]={source:f[0],target:f[1],weight:p,colour:"black"}}for(a=0;a<J.links.length;a++)y[y.length]=J.links[a];D.style("display","block").style("opacity",1).on("mouseover",at).on("mouseout",ct),R.force("link").links(y),lt(y),z.on("mouseover",un).on("mouseout",ct),R.restart(),setTimeout(function(){R.stop(),z.lower(),S.selectAll(".cluster-hull").lower()},10)}function dn(){Ce=!1,Ae=!0,Be=!1,z.remove(),D.style("display","none").on("mouseover",null).on("mouseout",null),_.on("click",null)}function un(e){"black"==e.colour&&(z.on("mouseover",null),D.on("mouseover",null).on("mouseout",null),S.selectAll(".clustering-centroid").on("mouseover",null),at(e.source),He=!0,at(e.target,!0),He=!1)}function mn(e){var t=[],n={};for(var r in Le)Le[r].ci==e&&(t[t.length]=[Le[r].x,Le[r].y],n[Le[r].x+"_"+Le[r].y]={x:Le[r].x,y:Le[r].y,colour:Te[e].colour});if(_.selectAll("#hull-"+e).remove(),Rt(n,e),_.selectAll(".centroid").raise(),_.selectAll(".clustering-centroid").raise(),0==Object.keys(n).length)return an(Te[e],Te[e].colour);var o=vn(t);return o.colour=Te[e].colour,o}function vn(e){if(0==e.length)return null;for(var t=0,n=0,r=0;r<e.length;r++)t+=e[r][0],n+=e[r][1];return{x:t/e.length,y:n/e.length}}function yn(e){for(var t,n,r,o=B.numstudents+": "+Object.keys(Le).length+"\n"+B.numofclusters+": "+Te.length+"\n"+B.iteration+": "+e+"\n",i=[],l=0;l<Te.length;l++){for(var a in t=Te[l].x-j/2,n=Te[l].y-q/2,r=Math.sqrt(t*t+n*n),o+=B.disttocluster+" "+l+": "+Math.round(r,2)+"\n"+B.cluster+" "+l+" "+B.members+": [",i[l]=[],Le)Le[a].ci==l&&(o+=a+", ",i[l][i[l].length]=a);-1!=o.indexOf(",",o.length-3)&&(o=o.slice(0,-2)),o+="]\n"}return o+="\n",se.value=o+se.value,i}function gn(e){for(var t={clusterCoords:[]},r=0;r<e.length;r++){t.clusterCoords[r]=pn(Te[r]),t.clusterCoords[r].num=r;for(var o,i=0;i<e[r].length;i++)o=pn(Le[e[r][i]]),e[r][i]={id:C[e[r][i]],num:r,x:o.x,y:o.y}}t.members=e,t.iteration=ze.iteration,t.clusterId=ze.clusterId,t.coordsid=T,t.usegeometric=Ze?1:0,(0!=K[0]||K[1]!=J.maxSession)&&t.iteration<0&&(t.iteration=he),gt(n,t)}function pn(e){var t=(e.x-j/2)/ze.scale+ze.centre.x,n=(e.y-q/2)/ze.scale+ze.centre.y;return{x:t=(t-ze.originalx)/ze.distance,y:n=(n-ze.originaly)/ze.distance}}function fn(e){for(var t,n,r=14,o=0;o<Te.length;o++)t=Te[o].x,n=Te[o].y,S.select("#cluster1-"+o).transition().duration(e).attr("x1",t-r).attr("y1",n-r).attr("x2",t+r).attr("y2",n+r),S.select("#cluster2-"+o).transition().duration(e).attr("x1",t+r).attr("y1",n-r).attr("x2",t-r).attr("y2",n+r)}function hn(e,t){switch(parseInt(e[t])){case 1:if(3==le){ie.noUiSlider.set(2);break}le=1,xn();break;case 2:le=2,bn();break;case 3:if(1==le){ie.noUiSlider.set(2);break}if(le=3,kn(),!fe){var n='<input type="text" placeholder="'+B.numclusters+'" id="num-clusters" size="8" pattern="[0-9]{1,2}">';document.getElementById("cluster-text").innerHTML=n}}}function xn(){Nt(!1),D.on("mouseover",null).on("mouseout",null),En(1,0,0,Ue),setTimeout(function(){S.selectAll(".centroid").raise()},100)}function bn(){D.transition(N).style("opacity",0),z.transition(N).style("opacity",0),S.selectAll(".clustering-centroid").transition(N).style("opacity",0),S.selectAll(".cluster-hull").transition(N).style("opacity",0),setTimeout(function(){D.style("display","none"),z.style("display","none"),S.selectAll(".clustering-centroid").style("display","none"),S.selectAll(".cluster-hull").style("display","none")},Ue),!fe&&document.getElementById("cluster-text")&&(document.getElementById("cluster-text").innerHTML=B.numclusters);var e=function(){var e=[];if($)return function(){var e=[],t=y=0;for(var n in te)if(!(n>=0&&1!=n))for(var r in te[n])for(var o in te[n][r].members)t=(t=te[n][r].members[o].x)*p+ze.originalx,y=te[n][r].members[o].y,y=y*p+ze.originaly,e[e.length]=[t,y];var i=wn(e);if(null===i)return null;for(var l,a,s,c,d=[i.x,i.y],u=0,m=0,v=0;v<e.length;v++)l=Math.abs(e[v][0]-d[0]),a=Math.abs(e[v][1]-d[1]),l>u&&(u=l,s=v),a>m&&(m=a,c=v);if(void 0===c&&void 0===s)return d[2]=1,d;var g=e[s][0]-d[0]+j/2,f=e[s][1]-d[1]+q/2,h=In(g,f,j/2,q/2);g=e[c][0]-d[0]+j/2,f=e[c][1]-d[1]+q/2;var x=In(g,f,j/2,q/2);return d[2]=h<x?h:x,d[2]*=.9,d}();for(var t in Ie)e[e.length]=[Ie[t].x,Ie[t].y];var n=wn(e);if(null===n)return null;var r,o,i,l,a=[n.x,n.y],s=0,c=0;for(var t in Ie)r=Math.abs(Ie[t].x-a[0]),o=Math.abs(Ie[t].y-a[1]),r>s&&(s=r,i=t),o>c&&(c=o,l=t);if(void 0===l&&void 0===i)return a[2]=1,a;var d=Ie[i].x-a[0]+j/2,u=Ie[i].y-a[1]+q/2,m=In(d,u,j/2,q/2);d=Ie[l].x-a[0]+j/2,u=Ie[l].y-a[1]+q/2;var v=In(d,u,j/2,q/2);return a[2]=m<v?m:v,a[2]*=.9,a}();null!==e&&(ze.scale=e[2],ne=e,setTimeout(function(){En(e[2],e[0],e[1],Ue)},Ue/2))}function kn(){S.selectAll(".clustering-centroid").transition(N).style("display","block").style("opacity",1),S.selectAll(".cluster-hull").transition(N).style("display","block").style("opacity",1)}function En(e=1,t=0,n=0,r=0){var o,i,l,a,s,c=j/2,d=q/2;for(var u in Le={},Ie)Le[u]={x:0,y:0};for(var u in ze.centre={x:t,y:n},Ie)l=((o=Ie[u].x)-t)*e,a=((i=Ie[u].y)-n)*e,1==e&&0==t&&0==n?(o=t+l,i=n+a):(o=c+l,i=d+a),Le[u].x=o,Le[u].y=i,s=o+","+(i-14)+" "+(o+14)+","+(i+14)+" "+(o-14)+","+(i+14),S.select("#centroid-"+u).transition().duration(r).attr("points",s);var m=function(e,t){return e*=ze.distance,e+=ze.originalx,t*=ze.distance,t+=ze.originaly,e-=ze.centre.x,e*=ze.scale,e+=j/2,t-=ze.centre.y,t*=ze.scale,{x:e,y:t+=q/2}};for(var u in Qe){var v=m(Qe[u].x,Qe[u].y);o=v.x,i=v.y,S.select("#server-centroid-"+u).transition().duration(r).attr("cx",o).attr("cy",i)}}function wn(e){if(0==e.length)return null;if(1==e.length)return{x:e[0][0],y:e[0][1]};for(var t,n,r=0,o=0,i=j,l=q,a=0;a<e.length;a++)(t=e[a][0])>r&&(r=t),t<i&&(i=t),(n=e[a][1])>o&&(o=n),n<l&&(l=n);return{x:(r+i)/2,y:(o+l)/2}}function In(e,t,n,r){var o=e-n,i=t-r,l=((o>0?j:0)-j/2)/o,a=((i>0?q:0)-q/2)/i;return isFinite(l)&&isFinite(a)&&l<=a?l:isFinite(l)&&!isFinite(a)?l:isFinite(a)?a:1}function Ln(){var e=document.getElementById("log-panel");e.style.width=c+"px";var t=document.createElement("button");t.innerHTML=B.copy,t.addEventListener("click",function(){se.select(),document.execCommand("copy")}),t.style.position="absolute",t.style.right=c-40+"px",e.appendChild(t);var n=document.createElement("button");n.innerHTML=B.print,n.addEventListener("click",function(){var e=window.open(),t=se.value.replace(/\n/g,"<br>");e.document.write("<html><head></head><body>"),e.document.write(t),e.document.write("</body></html>"),e.print(),e.close()}),n.style.position="absolute",n.style.right=c-100+"px",e.appendChild(n),(se=document.createElement("textarea")).readOnly=!0,se.rows=24,-1!=navigator.userAgent.indexOf("Chrome")?se.cols=28:se.cols=20,se.style.resize="none",se.style.border="2px solid black",se.style.position="absolute",se.style.right="6px",se.style.top="60px",e.appendChild(se)}function Tn(){for(var e in Ie)_.append("polygon").attr("class","centroid").attr("id","centroid-"+e).attr("points",Mn(Ie[e].x,Ie[e].y)).style("stroke","black").style("stroke-width","3px").style("fill",Ie[e].colour).call(S.drag().on("start",Cn.bind(this,e)).on("drag",An.bind(this,e)).on("end",Bn.bind(this,e))).on("mouseout",Nn).on("mouseover",On.bind(this,e)).on("click",function(){S.event.stopPropagation()}).on("click.centroidClick",Fn.bind(this,C[e],e,!1));if(Ke)for(var e in Qe){var t=Qe[e].x*ze.distance+ze.originalx,n=Qe[e].y*ze.distance+ze.originaly;_.append("circle").attr("class","server-centroid").attr("id","server-centroid-"+e).attr("r",5).attr("cx",t).attr("cy",n).style("fill","black")}}function Mn(e,t){return e+","+(t-14)+" "+(e+14)+","+(t+14)+" "+(e-14)+","+(t+14)}function Cn(e){Sn()&&(Xe=Date.now(),_.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+e).attr("points",Mn(S.event.x,S.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",Ie[e].colour).style("opacity",.5))}function An(e){Sn()&&S.select("#dragged-"+e).attr("points",Mn(S.event.x,S.event.y))}function Bn(e){if(S.selectAll(".dragged-centroid").remove(),Sn())if(Date.now()-Xe<300)Fn(C[e],e,!1);else{Le[e].ci=Hn(S.event);for(var t=[],n=0;n<Te.length;n++)t[n]=mn(n);Me=Te,Te=t,fn(Ue);var r=B.iteration+": "+he;document.getElementById("clustering").innerHTML=r;var o=yn(he);ze.iteration=he++,gn(o)}}function Hn(e){for(var t,n,r,o=Number.MAX_SAFE_INTEGER,i=-1,l=0;l<Te.length;l++)n=e.x-Te[l].x,r=e.y-Te[l].y,(t=Math.sqrt(n*n+r*r))<o&&(o=t,i=l);return i}function Sn(){if(!Te||!document.getElementById("clustering"))return!1;if(document.getElementById("clustering").innerHTML==B.convergence)return!1;for(var e in Le)if(void 0===Le[e].ci)return!1;return 3==le}function Nn(){Ce||(S.selectAll(".text").remove(),S.selectAll("rect").remove(),fe&&(D.style("display","none").style("opacity",0),z.remove()))}function On(e){if(!Ce){S.selectAll(".text").remove(),S.selectAll("rect").remove();var t=_.append("rect"),n=[0],r=1==le?Ie:Le,o=_.append("text").attr("class","text").attr("id","t-"+e).attr("y",r[e].y+32).attr("dy",".40em").style("pointer-events","none").text(e).call(st,30,r[e].x-18+8,n),i=18*n[0]+16;if(i+r[e].y+10>=q&&o.attr("y",q-i-(q-r[e].y)).text(e).call(st,30,r[e].x-18+8,n),t.attr("id","r-"+e).attr("x",r[e].x-18).attr("y",i+r[e].y+10<=q?r[e].y+16:q-i-16-(q-r[e].y)).attr("width",46).attr("height",i).style("stroke","black").style("fill","yellow"),fe){z.remove();for(var l={},a=0;a<J.nodes.length;a++)J.nodes[a].visible||(l[J.nodes[a].id]=1);var s,c,d={};for(a=K[0];a<J.edges[e].length&&a<=K[1];a++)"string"==typeof(y=J.edges[e][a]).source?(s=parseInt(y.source),o=parseInt(y.target)):(s=y.source.id,o=y.target.id),l[s]||l[o]||(d[c=s+"_"+o]?d[c]++:d[c]=1);var u,m=[],v=J.edges[e][0].colour;for(var y in d)u=y.split("_"),m[m.length]={source:u[0],target:u[1],weight:d[y],colour:v};for(a=0;a<J.links.length;a++)m[m.length]=J.links[a];R.force("link").links(m),lt(m),D.style("display","block").style("opacity",1),R.restart(),setTimeout(function(){R.stop(),D.lower(),z.lower()},1)}}}function Fn(e,t,n){if(fe&&!document.getElementById("textbox-"+e)&&null!==Jt()){var o=document.createElement("textarea");o.id="textbox-"+e,o.style.resize="both",o.style.position="absolute",M[e]&&(o.value=M[e]),Ge!=h&&(o.readOnly=!0),document.body.appendChild(o);var i=o.getBoundingClientRect(),l=document.getElementsByTagName("svg")[0].getBoundingClientRect(),a=n?Te[t].x:Le[t].x,s=a+i.width/2>=j?a+l.x-i.width:a-i.width/2<=0?a+l.x:a+l.x-i.width/2;o.style.left=s+"px";var c=n?Te[t].y:Le[t].y,d=c+190>=q?c+140:c+290;n&&(d=c+165>=q?c+165:c+265),o.style.top=d+"px";var u=document.createElement("button");u.innerHTML=Ge==h?B.save:B.close,u.id=e,u.style.position="absolute",u.style.left=s+"px",u.style.top=d+i.height+"px",document.body.appendChild(u),o.focus(),o.addEventListener("click",function(){this.parentNode.appendChild(this),u.parentNode.appendChild(u),this.focus()});var m=!1;o.addEventListener("mousedown",function(){m=!0}),o.addEventListener("mouseup",function(){m=!1}),o.addEventListener("mousemove",function(){m&&(i=this.getBoundingClientRect(),u.style.left=s+"px",u.style.top=d+i.height+"px")}),u.addEventListener("click",function(){if(Ge==h){var t={coordsid:T,clusterid:ze.clusterId,studentid:e,remark:o.value};""!=o.value&&o.value!=M[e]&&(M[e]=o.value,gt(r,t))}document.body.removeChild(o),document.body.removeChild(u)})}}!function(e){i=e.logs,l=e.users,a=e.mods,e.mods,s=e.panelwidth,c=e.legendwidth,u=e.name,m=e.iframeurl,Ne=e.version38,v=e.positioning,g=e.nodecoords,e.nodecoords,f=e.courseid,h=e.userid,p=e.scale,e.scale,x=e.graphs,b=e.scales,k=e.changes,E=e.names,w=e.allmods,I=e.setnames,L=h,T=e.lastchange,M=e.comments,B=e.strings,t=e.coordsscript,n=e.clustersscript,r=e.commentsscript,o=e.manualscript,H=e.sesskey,Pe=e.gotallnodes,$=e.replaying,Ke=e.debugcentroids,Qe=e.centroids,Je=e.isresearcher,Ge=h,S=window.dataDrivenDocs||d3,O=window.noUiSlider||noUiSlider;var d,y,z=window.mersenneTwister||MersenneTwister;F=new z(259),ve=0,me=["aqua","blue","blueviolet","brown","cadetblue","chartreuse","chocolate","coral","cornflowerblue","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgrey","darkgreen","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgrey","dodgerblue","firebrick","forestgreen","fuchsia","gold","goldenrod","grey","green","greenyellow","hotpink","indianred","indigo","khaki","lawngreen","lightblue","lightcoral","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategrey","lightsteelblue","lime","limegreen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","navy","olive","olivedrab","orange","orangered","orchid","palegreen","paleturquoise","palevioletred","peru","plum","powderblue","purple","rebeccapurple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","sienna","silver","skyblue","slateblue","slategrey","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","yellow","yellowgreen"],Fe=Date.now()+3e3,Ue=1e3,N=S.transition().duration(Ue).ease(S.easeLinear),ae=120,Oe=1,G=1e-4,P=1,Re=Lt,be=!1,ke=220,we=.15,Ee=S.curveCatmullRomClosed,de={},ze={},ye={originalLinks:"lightgrey",grouping:"black",assignment:"blue",quiz:"red",forum:"orange",file:"green","external tool":"yellow",url:"purple",book:"magenta",page:"cyan",lesson:"brown"},ge=["blue","red","orange","green","yellow","brown","purple","magenta","cyan"],Q=v?0:36,s=v?0:s,legendlWidth=v?0:c,j=window.innerWidth-ae-c-150,q=window.innerHeight-Q-90,De=Math.min(j,q)<500?6:8,C={},l.forEach(function(e){C[e.id]=e.realId}),et(),tt(),$?(d=e.replaydata,y=e.manualdata,v=!0,g={0:0,1:1,2:2},q=window.innerHeight-190,function(){var e=document.getElementById("slider"),t=document.createElement("p");t.innerHTML="&nbsp",t.id="replayer",e.appendChild(t);var n=document.createElement("button");n.id="replay-stop",n.innerHTML="&#9606",n.addEventListener("click",Kt),e.appendChild(n);var r=document.createElement("button");r.id="replay-pause",r.innerHTML="&#9654",r.value="play",r.addEventListener("click",$t),e.appendChild(r);var o=document.createElement("button");o.id="replay-back",o.innerHTML="&#9614&#9664",o.addEventListener("click",tn),e.appendChild(o);var i=document.createElement("button");i.id="replay-forward",i.innerHTML="&#9654&nbsp&nbsp&#9614",i.addEventListener("click",en),e.appendChild(i)}(),Ln(),function(e,t){var n=document.getElementById("student-menu");for(var r in(ee=document.createElement("select")).size=3,ee.id="replay-select",ee.style="height: "+(q-12)+"px;",ee.addEventListener("change",function(e,t){var n=function(e,t){for(var n,r=document.getElementById("replay-select"),o=0;o<r.options.length;o++)if(r.options[o].selected){n=r.options[o].value.split("_");break}var s=n[0],c=n[1],d=n[2];for(var u in Ge=s.split("-")[0],ze.clusterId=d,T=e[s][c].last,g=e[s][c].nodes,p=e[s][c].scale,a=e[s][c].mods,te=e[s][c][d],i=e[s][c].logs,l=e[s][c].users,M=e[s][c][d].comments,A={},C={},l.forEach(function(e){C[e.id]=e.realId,A[e.realId]=e.id}),he=0,le=1,re=0,oe=0,te)isNaN(u)||(u>=0?re++:oe--);$e=[],Ve={},We=!1;var m=t[s][c][d];if(m){We=!0;for(var o=-1;o>=oe;o--)for(var v in m[o]&&!m[o-1]&&(m[o-1]=m[o]),Ve[o]={},m[o])for(var y in m[o][v].members){var f=m[o][v].members[y].id;Ve[o][A[f]]=v}}Te=[],Ie={};var h={},x=0;for(var v in te[1]){var o=Te.length;if(Te[o]={x:0,y:0},x<ge.length)Te[o].colour=ge[x++];else{for(var b;!b;)b=me[Math.floor(F.random()*me.length)],b=ge.includes(b)?void 0:b;Te[o].colour=b}for(var y in te[1][v].members){var k=A[te[1][v].members[y].id];Ie[k]={x:te[1][v].members[y].x,y:te[1][v].members[y].y},h[k]=!0}}return{members:h,did:s,gid:c,cid:d}}(e,t),r=n.members;_&&(_.remove(),Vt(),Qt(),document.getElementById("replayer").innerHTML="&nbsp;"),Y&&document.body.removeChild(Y),et(),tt(),K=[0,J.maxSession];for(var o=0;o<J.nodes.length;o++)void 0===J.nodes[o].xcoord&&(J.nodes[o].visible=!1);(function(e){(Y=document.createElement("select")).multiple=!0,Y.id="student-select",Y.style.display="none",ve=0,l.forEach(function(e){Bt(e,Y)});for(var t,n=0;n<Y.options.length;n++)t=Y.options[n].value,e[t]?Y.options[n].selected=!0:Y.options[n].selected=!1,Ie[t]&&(Ie[t].colour=Y.options[n].colour);document.body.appendChild(Y)})(r),ot(),Nt(!1),D.on("mouseover",null).on("mouseout",null),Ce=!0,setTimeout(function(){for(var e in Zt(Ie),Tn(),R.on("tick",ut),Ie)S.select("#centroid-"+e).call(S.drag().on("start",Ut.bind(this,e)).on("drag",Pt.bind(this,e)).on("end",Wt.bind(this,e,t,n)))},500)}.bind(this,e,t)),e){var o=0;for(var s in e[r]){var c=0;for(var d in o++,e[r][s])if(!isNaN(d)&&e[r][s][d][1]){var u=document.createElement("option");u.value=r+"_"+s+"_"+d,u.text=r.split("-")[0]+"_"+o+"_"+ ++c,ee.appendChild(u)}}}n.appendChild(ee)}(d,y)):v?(pe=!1,W=.01,X=.01,_e=Tt,je=Mt,qe=Ct,Pe&&Object.keys(g).length>0&&(P=0),x&&b&&function(){var e=document.getElementById("student-menu"),t=document.createElement("button");t.innerHTML=B.copy,t.addEventListener("click",pt),e.appendChild(t);var n=t.getBoundingClientRect().height,r=document.createElement("button");for(var o in r.innerHTML=B.print,r.addEventListener("click",ft),e.appendChild(r),(ue=document.createElement("select")).size=3,ue.id="teacher-select",ue.style.minWidth="40px",menuHeight=q-n-20,ue.style.height=menuHeight+"px",ue.addEventListener("change",ht),b){var i=document.createElement("option");i.value=o,i.text=o,h==o&&(i.selected=!0),ue.appendChild(i)}e.appendChild(ue)}(),ot(.6),bt(),function(){var e=document.getElementById("student-menu"),t=document.createElement("input");t.id="weight-slider",t.type="range",t.min="-0.2",t.max="2",t.step="0.2",t.value="0.6",t.style.width="130px",t.addEventListener("change",function(){U.strength(this.value),document.getElementById("weights-output").innerHTML="&nbsp;= "+this.value}),e.appendChild(t);var n=document.createTextNode(B.linksweight);e.appendChild(n),(n=document.createElement("label")).id="weights-output",n.innerHTML="&nbsp;= "+t.value,e.appendChild(n)}(),setTimeout(function(){R.force("charge",null).force("x",null).force("y",null)},500)):(pe=!0,v=!0,W=0,_e=null,je=null,qe=null,Pe&&0!=Object.keys(g).length?(At(),ot(),Ht()):(ot(.6),setTimeout(function(){At(),Ht()},500)),U=null)}(e)}});
