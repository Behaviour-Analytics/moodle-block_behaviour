/*! moodle-block_behaviour v0.6.2 08-07-2020 */

!function(e){"function"==typeof define&&define.amd?define([],e):window.behaviourAnalytics=e()}(function(){return function(e){var t,n,r,o,i,l,s,a,c,d,u,m,y,g,v,p,f,h,x,b,k,E,w,I,L,T,M,C,A,B,H,S,N,O,F,_,j,q,R,D,z,U,X,W,G,P,J,Y,Z,K,Q,V,$,ee,te,ne,re,oe,ie,le,se,ae,ce,de,ue,me,ye,ge,ve,pe,fe,he,xe,be,ke,Ee,we,Ie,Le,Te,Me,Ce,Ae,Be,He,Se,Ne,Oe,Fe,_e,je,qe,Re,De,ze,Ue,Xe,We,Ge,Pe,Je,Ye,Ze,Ke={},Qe=[];function Ve(){s.forEach(function(e){for(;!me[e.entype];){var t=de[Math.floor(N.random()*de.length)],n=!0;for(var r in me)me[r]==t&&(n=!1);me[e.entype]=n?t:void 0}})}function $e(){G={nodes:[],links:[],edges:{},maxSession:0},et(),tt()}function et(){var e,t,n,r=G,o={};s.forEach(function(i){e=!0,t=void 0,n=void 0,y[i.id]?(e=1==y[i.id].visible&&1==y["g"+i.sect].visible,1!=y[i.id].visible||e||(y[i.id].visible=0),t=y[i.id].xcoord,n=y[i.id].ycoord):y["g"+i.sect]&&(e=1==y["g"+i.sect].visible&&p==w),r.nodes[r.nodes.length]={id:i.id,name:i.name,group:i.sect,type:i.type,entype:i.entype,colour:me[i.entype],visible:e,xcoord:t,ycoord:n},o[i.sect]||(y["g"+i.sect]&&(e=1==y["g"+i.sect].visible,t=y["g"+i.sect].xcoord,n=y["g"+i.sect].ycoord),o[i.sect]={id:"g"+i.sect,name:C.section+" "+i.sect,group:i.sect,type:"grouping",colour:me.grouping,visible:e,xcoord:t,ycoord:n},r.nodes[r.nodes.length]=o[i.sect]),r.links[r.links.length]={source:"g"+i.sect,target:i.id,weight:z,colour:me.originalLinks}}),t=n=void 0,y.root&&(t=y.root.xcoord,n=y.root.ycoord);var i={id:"root",name:d,group:-1,type:"grouping",colour:me.grouping,visible:!0,xcoord:t,ycoord:n};if(Object.keys(o).length>1)for(var l in o)r.links[r.links.length]={source:"root",target:o[l].id,weight:z,colour:me.originalLinks};else r.nodes=r.nodes.filter(function(e){return"g0"!=e.id}),r.links.forEach(function(e){"g0"==e.source&&(e.source="root")});r.nodes[r.nodes.length]=i}function tt(){var e,t=G,n=0,r=0;Pe={};for(var o=0;o<i.length;o++)e={source:i[o].moduleId,target:i[o].moduleId,weight:z,user:i[o].userId,colour:""},t.edges[i[o].userId]||(t.edges[i[o].userId]=[],Pe[i[o].userId]=[],t.maxSession=t.maxSession<n?n:t.maxSession,n=0,r=0),y[i[o].moduleId]&&1==y[i[o].moduleId].visible&&(Pe[i[o].userId][r++]=i[o].moduleId),o+1<i.length&&i[o].userId==i[o+1].userId?(e.target=i[o+1].moduleId,t.edges[i[o].userId][n++]=e):0==t.edges[i[o].userId].length&&(t.edges[i[o].userId][n++]=e);t.maxSession=t.maxSession<n?n:t.maxSession,l.forEach(function(e){t.edges[e.id]||(t.edges[e.id]=[])})}function nt(e){O=B.select("#graph").append("svg").attr("width",F).attr("height",_),D=B.forceLink(G.links).id(function(e){return e.id}).strength(e),j=B.forceSimulation(G.nodes).force("link",D).force("charge",B.forceManyBody().strength(-80)).force("collide",B.forceCollide().radius(12)).force("center",B.forceCenter(F/2,_/2)).force("x",B.forceX()).force("y",B.forceY()),rt(G.nodes,je,Oe,Fe,_e),ot(G.links),O.on("click",function(){B.selectAll("#rctext").remove(),B.selectAll("#rcrect").remove(),(ge||m)&&q.on("mouseover",it).on("mouseout",st),Q&&q.on("mouseover",null).on("mouseout",null)}),ze&&m&&Object.keys(y).length>0?j.on("tick",ct):j.on("tick",dt);for(var t=0;t<80;t++)j.tick();m&&setTimeout(function(){j.stop(),j.on("tick",dt),ut(),0!=Object.keys(y).length&&ze||(mt(),G.edges={},tt(),ze=!0,z=ge?1:0)},500),ge&&!ze&&setTimeout(function(){G.nodes=[],G.links=[],et()},600)}function rt(e,t,n,r,o){q=O.selectAll(".node").data(e).enter().append("circle").attr("class","node").attr("r",qe).on("mouseover",it).on("mouseout",st).on("contextmenu",t).call(B.drag().on("start",n).on("drag",r).on("end",o))}function ot(e){R=O.selectAll(".link").data(e).enter().append("line").attr("class","link").style("stroke",function(e){return e.colour}).style("stroke-width",function(e){return 2*e.weight+"px"})}function it(e,t){if(!(Me||(q.on("mouseover",null),t||(B.selectAll(".text").remove(),B.selectAll("rect").remove()),Date.now()-Ne<150))){var n=[0],r=!1,o=!1,i=!1,l=304,s=154,a=e.type+"_"+e.name;Ce&&(l=0,s=0);var c,d=O.append("text").attr("class","text").attr("id","t-"+e.id).attr("y",e.y+32).attr("dy",".40em").style("pointer-events","none").text(a).call(lt,150,e.x-78+8,n),m=16*n[0]+16;m+e.y>=_-s&&(d.attr("y",_-m-(_-e.y)).text(a).call(lt,150,e.x-78+8,n),r=!0),e.x<=l/2?(d.text(a).call(lt,150,e.x+8,n),i=!0):e.x>=F-l/2&&(d.text(a).call(lt,150,e.x-156+8,n),o=!0),c=i?e.x:o?e.x-156:e.x-78;var y=O.append("rect").attr("id","r-"+e.id).attr("x",c).attr("y",r?_-m-16-(_-e.y):e.y+16).attr("width",166).attr("height",m).style("stroke","black").style("fill","yellow");d.raise(),isNaN(e.id)||(Ce&&(l=400,s=300),function(e,t,n,r,o,i,l,s,a,c){var d=document.createElement("iframe");d.id="preview",d.style.position="absolute",d.style.width=r+"px",d.style.height=o+"px";var m=document.getElementsByTagName("svg")[0].getBoundingClientRect(),y=document.body.getBoundingClientRect();y.x>0&&(y.x=0),d.style.left=Ae?window.innerWidth-10-r+"px":Ce?"10px":l?a+m.x+"px":s?a+m.x+n-r+18+"px":a+m.x-r/2+n/2+"px";var g=He?0:50;if(d.style.top=Ce?m.y-y.y+_/2+"px":i?g+c+m.y-y.y-o+"px":g+c+m.y+t-y.y+"px","lti"!=e.entype){var v=document.createElement("div");v.id="bgrnd",v.style.position="absolute",v.style.width=parseInt(d.style.width)+24+"px",v.style.height=parseInt(d.style.height)+24+"px",v.style.left=parseInt(d.style.left)-12+"px",v.style.top=parseInt(d.style.top)-12+"px",v.addEventListener("mouseout",function(e){var t=this.getBoundingClientRect();e.x>t.x&&e.x<t.x+t.width&&e.y>t.y&&e.y<t.y+t.height||(Be=!1,setTimeout(at,750))}),v.addEventListener("mouseover",function(){Be=!0}),d.src=u+"/mod/"+e.entype+"/view.php?id="+e.id,document.body.appendChild(v),document.body.appendChild(d)}}(e,m,150,l,s,r,i,o,parseInt(y.attr("x")),parseInt(y.attr("y"))))}}function lt(e,t,n,r){var o=0;e.each(function(){var e,r=B.select(this),i=r.text().split(/\s+/).reverse(),l=[],s=r.attr("y"),a=parseFloat(r.attr("dy")),c=r.text(null).append("tspan").attr("x",n).attr("y",s).attr("dy",a+"em");for(e=i.pop();e;)l.push(e),c.text(l.join(" ")),c.node().getComputedTextLength()>t&&(l.pop(),c.text(l.join(" ")),l=[e],c=r.append("tspan").attr("x",n).attr("y",s).attr("dy",1.1*++o+a+"em").text(e)),e=i.pop()}),r[0]=++o}function st(e){Me||"lightgrey"==e.colour||(q.on("mouseout",null),R.on("mouseout",null),setTimeout(at,750))}function at(){if(!Be&&(B.selectAll(".text").remove(),B.selectAll("rect").remove(),B.selectAll("#preview").remove(),B.selectAll("#bgrnd").remove(),q.on("mouseover",it).on("mouseout",st),Ce)){R.on("mouseover",un).on("mouseout",st);for(var e=0;e<Ie.length;e++)B.select("#cluster1-"+e).on("mouseover",cn.bind(this,e,!1)),B.select("#cluster2-"+e).on("mouseover",cn.bind(this,e,!1))}}function ct(){var e=F/2,t=_/2,n=g;void 0===Re.originalx?(Re.originalx=e,Re.originaly=t):(e=Re.originalx,t=Re.originaly);for(var r,o,i=0;i<G.nodes.length;i++)r=G.nodes[i].xcoord*n+e,o=G.nodes[i].ycoord*n+t,(r<0||r>F||o<0||o>_)&&(n*=.9,--i);g=n,Re.distance=n,R.attr("x1",function(r){var o=G.nodes.filter(function(e){var t="string"==typeof r.source?r.source:r.source.id;return e.id==t})[0];return B.select(this).attr("y1",o.ycoord*n+t),o.xcoord*n+e}).attr("x2",function(r){var o=G.nodes.filter(function(e){var t="string"==typeof r.target?r.target:r.target.id;return e.id==t})[0];return B.select(this).attr("y2",o.ycoord*n+t),o.xcoord*n+e}).style("display",function(e){return e.source.visible&&e.target.visible?"block":"none"}),q.attr("cx",function(t){return t.x=t.xcoord*n+e,t.x}).attr("cy",function(e){return e.y=e.ycoord*n+t,e.y}).style("display",function(e){return e.visible?"block":"none"}).style("fill",function(e){return e.colour}).raise()}function dt(){var e=qe;R.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}).style("stroke-width",function(e){return 2*e.weight+"px"}).style("display",function(e){return e.source.visible&&e.target.visible?"block":"none"}),q.attr("cx",function(t){return t.x=Math.max(e,Math.min(F-e,t.x)),t.x}).attr("cy",function(t){return t.y=Math.max(e,Math.min(_-e,t.y)),t.y}).style("fill",function(e){return e.colour}).style("display",function(e){return e.visible?"block":"none"}).raise(),B.selectAll("rect").raise(),B.selectAll("text").raise()}function ut(){if(b){B.select("#time").remove(),0==I&&(I=Date.now());var e=new Date;e.setTime(I);var t=e.getMinutes();t<10&&(t="0"+t),O.append("text").attr("id","time").attr("y",_-16).attr("dy",".40em").attr("x",6).style("pointer-events","none").text(b[w]+" "+e.getHours()+":"+t+" "+e.toDateString())}}function mt(){var e=function(){var e,t,n,r,o={},i=0,l=F/2,s=_/2;return G.nodes.forEach(function(o){e=o.x-l,t=o.y-s,(n=Math.sqrt(e*e+t*t))>i&&(i=n,r=o)}),o.scale=i,o.module=r.id,g=i,G.nodes.forEach(function(e){o[e.id]={xcoord:""+(e.x-l)/i,ycoord:""+(e.y-s)/i,visible:e.visible?1:0},e.xcoord||(e.xcoord=(e.x-l)/i,e.ycoord=(e.y-s)/i)}),y=o,o}();if(f&&h){var n={};for(var r in e)"scale"!=r&&"module"!=r&&(n[r]=e[r]);f[p]=n,h[p]=e.scale}e.time=Date.now(),I=e.time,x&&(x[p]=e.time),yt(t,e)}function yt(e,t){var n=new XMLHttpRequest;n.open("POST",e),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){4==this.readyState&&this.status},n.send("cid="+v+"&data="+JSON.stringify(t)+"&sesskey="+A)}function gt(){var e=new Image,t=(new XMLSerializer).serializeToString(O.node());e.src="data:image/svg+xml;base64,"+window.btoa(t),document.body.appendChild(e);var n=document.createRange();n.setStartBefore(e),n.setEndAfter(e),n.selectNode(e),window.getSelection().addRange(n),document.execCommand("Copy"),document.body.removeChild(e)}function vt(){var e=(new XMLSerializer).serializeToString(O.node()),t=window.open();t.document.write('<img src="data:image/svg+xml;base64,'+window.btoa(e)+'"/>'),t.print(),t.close()}function pt(){for(var e,t=document.getElementById("teacher-select"),n=0;n<t.options.length;n++)if(t.options[n].selected){e=t.options[n].value;break}e==p?(Oe=It,Fe=Lt,_e=Tt,je=wt):(Oe=null,Fe=null,_e=null,je=null),y=f[e],g=h[e],I=x[e],s=k[e],d=E[e],w=e,O.remove(),ae={},Ve(),B.selectAll("#legendUL").remove(),ht(),z=1,$e(),z=0;var r=document.getElementById("weights-output").innerHTML;for(var o in nt(r=parseFloat(r.split(" ")[1])),ae)y[o]&&(ae[o].checked=1==y[o].visible),p==e?(ae[o].removeEventListener("change",ft),ae[o].addEventListener("change",kt)):(ae[o].removeEventListener("change",kt),ae[o].addEventListener("change",ft))}function ft(){this.checked=!this.checked}function ht(){var e;(se=document.getElementById("legend")).style="width: "+c+"px; height: "+_+"px; min-width: "+c+"px; max-width: 500px;";var t=function(t){var n=e-t.x;e=t.x;var r=parseInt(se.style.width)+n;r>500?r=500:r<c&&(r=c),se.style.width=r+"px"};se.addEventListener("mousemove",function(e){var t=se.offsetLeft+28;e.x>=t&&e.x<=t+6?se.style.cursor="col-resize":se.style.cursor="auto"}),se.addEventListener("mousedown",function(n){e=n.x,"col-resize"==se.style.cursor&&se.addEventListener("mousemove",t)}),document.addEventListener("mouseup",function(){se.removeEventListener("mousemove",t)}),function(e){var t=document.createElement("ul");t.id="legendUL";var n=document.createElement("span");n.className="no-select-text",n.innerHTML=d;var r=document.createElement("li");r.appendChild(n);var o=document.createElement("ul");r.appendChild(o),t.appendChild(r);var i,l,a,c=-1;s.forEach(function(e){c!=e.sect&&((l=document.createElement("ul")).className="nested",(a=document.createElement("span")).className="caret",a.addEventListener("click",xt),(i=document.createElement("li")).appendChild(a),bt("g"+e.sect,C.section+" "+e.sect,me.grouping,e.sect,"grouping",i),i.appendChild(l),o.appendChild(i),c++),(i=document.createElement("li")).className="indented",bt(e.id,e.name,me[e.entype],e.sect,e.type,i),l.appendChild(i)}),e.appendChild(t)}(se)}function xt(){this.parentElement.querySelector(".nested").classList.toggle("active"),this.classList.toggle("caret-down")}function bt(e,t,n,r,o,i){var l=document.createElement("input");l.type="checkbox",y[e]?l.checked=0!=y[e].visible:y["g"+r]?l.checked=1==y["g"+r].visible&&p==w:l.checked=!0,l.id=e,l.group=r,l.nodeT=o,l.addEventListener("change",kt),ae[l.id]=l;var s=document.createElement("label");s.style.color=n,s.className="no-select-text";var a="grouping"==o?t:o+"_"+t;s.appendChild(document.createTextNode(a)),i.appendChild(l),i.appendChild(s)}function kt(){var e=this.id,t=this.checked,n=this.nodeT,r=this.group;G.nodes.forEach(function(o){o.id==e?(o.visible=t,ae[o.id].checked=t):"grouping"==n&&o.group==r?(o.visible=t,ae[o.id].checked=t):t&&"grouping"==o.type&&o.group==r&&(o.visible=t,ae[o.id].checked=t)}),Et(),Bt()}function Et(){parseFloat(document.getElementById("weight-slider").value)<0&&(D.strength(0),document.getElementById("weights-output").innerHTML="&nbsp;= 0",document.getElementById("weight-slider").value=0)}function wt(e){if(B.selectAll(".text").remove(),B.selectAll("rect").remove(),B.selectAll("#preview").remove(),B.selectAll("#bgrnd").remove(),B.event.preventDefault(),"root"!=e.id){var t=e;q.on("mouseover",null).on("mouseout",null);var n=O.append("rect"),r=O.append("text").attr("class","text").attr("id","rctext").attr("x",e.x+10).attr("y",e.y+12).attr("dy",".40em").style("pointer-events","none").text(C.hide);e.y+20>=_&&r.attr("y",_-(_-e.y)-10).text(C.hide),n.attr("id","rcrect").attr("x",e.x).attr("y",e.y+20<=_?e.y:_-(_-e.y)-20).attr("width",60).attr("height",24).style("stroke","black").style("fill","lightgrey"),n.on("mouseover",function(){B.event.target.style="fill: grey;"}),n.on("mouseout",function(){B.event.target.style="fill: lightgrey;"}),n.on("click",function(){B.selectAll("#rctext").remove(),B.selectAll("#rcrect").remove(),q.on("mouseover",it).on("mouseout",st),t.visible=!1,ae[t.id].checked=!1,"grouping"==t.type&&G.nodes.forEach(function(e){e.group==t.group&&(e.visible=!1,ae[e.id].checked=!1)}),Et(),Bt()})}}function It(e){B.event.active||j.alphaTarget(X).restart(),e.fx=e.x,e.fy=e.y}function Lt(e){B.selectAll("rect").remove(),B.selectAll(".text").remove(),B.selectAll("#preview").remove(),B.selectAll("#bgrnd").remove(),e.fx=B.event.x,e.fy=B.event.y}function Tt(e){B.event.active||(m?(j.stop(),mt(),ut()):j.alphaTarget(W)),e.fx=null,e.fy=null,Ne=Date.now()}function Mt(){var e=document.getElementById("student-menu");(K=document.createElement("button")).innerHTML=C.cluster,K.addEventListener("click",Dt),e.appendChild(K);var t=K.getBoundingClientRect().height;(P=document.createElement("select")).multiple=!0,P.id="student-select";var n=_-t-12;P.style="height: "+n+"px;",P.addEventListener("change",function(){for(var e=document.getElementById("student-select"),t=0;t<e.options.length;t++){var n="box-shadow: 0 0 10px 100px "+e.options[t].colour+" inset;";e.options[t].style=e.options[t].selected?n:"box-shadow: 0 0 0 0 white inset;"}i.length>0&&Ht(!0)}),l.sort(function(e,t){return e.id-t.id}),l.forEach(function(e){Ct(e,P)}),e.appendChild(P)}function Ct(e,t){var n=document.createElement("option");n.value=e.id,n.text=e.id,n.colour=de[ue++],ue>=de.length&&(ue=0),G.edges[e.id].forEach(function(e){e.colour=n.colour}),t.appendChild(n)}function At(){var e;J=document.getElementById("slider"),Y=[0,G.maxSession],e=G.maxSession<500?10:G.maxSession<1e3?20:G.maxSession<5e3?100:G.maxSession<1e4?200:500,S.create(J,{start:[0,G.maxSession],range:{min:[0],max:[G.maxSession]},step:1,connect:!0,pips:{mode:"steps",stepped:!0,density:100,filter:function(t){return 0==t||t==G.maxSession?1:t%e==0?2:0}}}),setTimeout(function(){J.noUiSlider.on("update",function(e,t){Y[t]=parseInt(e[t]),P.dispatchEvent(new Event("change"))})},1e3)}function Bt(){R.remove(),q.remove(),B.selectAll(".hull").remove();var e=St(wt);Nt(e),Ft(e),j.alphaTarget(U).restart(),m&&setTimeout(function(){j.stop(),mt(),ut()},100)}function Ht(e){R.remove(),q.remove(),B.selectAll(".hull").remove(),m=!1;var t=St(null);Nt(t),e&&Ft(t),m=!0,j.on("tick",ct),j.restart(),setTimeout(j.stop,100)}function St(e){var t=[],n={};return G.nodes.forEach(function(e){null===e.fx&&(e.fx=e.x,e.fy=e.y),e.visible?t[t.length]=e:n[e.id]=1}),j.nodes(t),rt(t,e,Oe,Fe,_e),n}function Nt(e){var t,n,r,o,i,l=[];for(i in G.links)"string"==typeof(r=G.links[i]).source?(t=r.source,n=r.target):(t=r.source.id,n=r.target.id),e[t]||e[n]||(l[l.length]=r);var s=m?[]:document.getElementById("student-select").options;for(i=0;i<s.length;i++)if(s[i].selected){var a,c,d={};for(c=Y[0];c<=Y[1]&&G.edges[s[i].value].length>c;c++)"string"==typeof(o=G.edges[s[i].value][c]).source?(a=o.source+"_"+o.target,t=o.source,n=o.target):(a=o.source.id+"_"+o.target.id,t=o.source.id,n=o.target.id),d[a]?d[a]++:d[a]=1,e[t]||e[n]||(l[l.length]=o);for(c=Y[0];c<=Y[1]&&G.edges[s[i].value].length>c;c++)a="string"==typeof(o=G.edges[s[i].value][c]).source?o.source+"_"+o.target:o.source.id+"_"+o.target.id,o.weight=d[a]}j.force("link").links(l),ot(l)}function Ot(e){return G.nodes.find(function(t){return t.id==e})}function Ft(e){if(!m){B.selectAll(".hull").remove();for(var t=document.getElementById("student-select").options,n={},r=0;r<t.length;r++)if(t[r].selected){var o,i,l,s,a,c,d;n[t[r].value]={};for(var u=Y[0];u<=Y[1]&&G.edges[t[r].value].length>u;u++){var y=G.edges[t[r].value][u];if("string"==typeof y.source){c=y.source,d=y.target;var g=Ot(c);o=g.x,i=g.y,l=(g=Ot(d)).x,s=g.y}else c=y.source.id,d=y.target.id,o=y.source.x,i=y.source.y,l=y.target.x,s=y.target.y;e[c]||e[d]||(a=y.colour,n[t[r].value][c]={x:o,y:i,colour:a},n[t[r].value][d]={x:l,y:s,colour:a})}}for(var v in n)qt(n[v],v,!1,!1);ge&&(t=document.getElementById("student-select").options,Je?jt(t):_t(t))}}function _t(e){Ee={};for(var t=0;t<e.length;t++)if(e[t].selected){var n=e[t].value;if(Pe[n].length<=Y[0])continue;var r=Y[0],o=Pe[n].length>Y[1]+1?Y[1]:Pe[n].length,i=parseInt(r/2+o/2),l=Pe[n][i],s=parseFloat(y[l].xcoord),a=parseFloat(y[l].ycoord);Ee[n]={x:s*g+Re.originalx,y:a*g+Re.originaly,colour:e[t].colour}}}function jt(e){Ee={};for(var t=0;t<e.length;t++)if(e[t].selected){var n=e[t].value;if(Pe[n].length<=Y[0])continue;for(var r,o=Y[0],i=Pe[n].length>Y[1]+1?Y[1]:Pe[n].length,l=0,s=0,a=0,c=o;c<i;c++)r=Pe[n][c],l+=parseFloat(y[r].xcoord),s+=parseFloat(y[r].ycoord),a++;Ee[n]={x:l/a*g+Re.originalx,y:s/a*g+Re.originaly,colour:e[t].colour}}}function qt(e,t,n,r){if(0!=Object.keys(e).length){var o,i,l,s=[],a=20;for(var c in l=ge?"hull":n?"manual-hull":"cluster-hull",e)s[s.length]=[e[c].x,e[c].y],o=e[c].colour;if(1==s.length)i=function(e){var t=[e[0][0],e[0][1]-a],n=[e[0][0],e[0][1]+a];return"M "+t+" A "+[a,a,"0,0,0",n].join(",")+" A "+[a,a,"0,0,0",t].join(",")};else{if(2!=s.length){var d=B.concaveHull().padding(15);he||d.distance(xe);var u=s.length>4?d(s):[s];return i=B.line().curve(be),void O.selectAll("#hull-"+t).data(u).enter().append("path").attr("id","hull-"+t).attr("class",l).style("stroke",o).style("stroke-opacity",r?0:1).style("fill",o).style("fill-opacity",r?0:ke).attr("d",i)}var m=function(e,t){return[t[0]-e[0],t[1]-e[1]]},y=function(e,t){return[t*e[0],t*e[1]]},g=function(e,t){return[e[0]+t[0],e[1]+t[1]]},v=function(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return y(e,1/t)},p=function(e,t){return y(v(e),t)};i=function(e){var t=m(e[0],e[1]),n=p(t,a),r=g(e[0],y(n,-1)),o=g(e[1],n),i=1.2*a,l=p(function(e,t){void 0!==t&&(e=m(e,t));var n=[-e[1],e[0]];return v(n)}(t),i),s=y(l,-1),c=g(r,s),d=g(o,s),u=g(r,l);return"M "+r+" C "+[c,d,o].join(",")+" S "+[u,r].join(",")+" Z"}}O.append("path").attr("id","hull-"+t).attr("class",l).style("stroke",o).style("stroke-opacity",r?0:1).style("fill",o).style("fill-opacity",r?0:ke).attr("d",i(s))}}function Rt(){clearInterval(fe),fe=void 0,Qt(),B.selectAll(".clustering-centroid").remove(),B.selectAll(".cluster-hull").remove(),B.selectAll(".centroid").remove(),B.selectAll(".server-centroid").remove(),re.style.display="none",document.getElementById("anim-controls").style.display="none",document.getElementById("log-panel").style.display="none",document.getElementById("student-menu").style.width=K.style.width,ge=!0,Ce=!1,J.style.display="block",P.style.display="block",q.style("display","block"),q.style("opacity",1),R.style("display","block"),R.style("opacity",1),Ht(!0),q.on("mouseover",it).on("mouseout",st),K.innerHTML=C.cluster,K.removeEventListener("click",Rt),K.addEventListener("click",Dt)}function Dt(){ge=!1,J.style.display="none",P.style.display="none",B.selectAll(".hull").remove(),B.selectAll(".text").remove(),B.selectAll("rect").remove(),document.getElementById("student-menu").style.width=ie+"px",K.innerHTML=C.graph,K.removeEventListener("click",Dt),K.addEventListener("click",Rt),j.stop(),q.on("mouseover",null).on("mouseout",null).on("contextmenu",null).call(B.drag().on("start",null).on("drag",null).on("end",null)),Re.clusterId=Date.now(),L={},pe=0,ve=!1,oe=1,fe=void 0;var e='<p id="cluster-text">'+C.numclusters+"</p>";setTimeout(function(){if(re)document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("cluster-text").innerHTML=e,document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("anim-controls").style.display="block",document.getElementById("log-panel").style.display="block",re.noUiSlider.set(1),re.style.display="block";else{var t=function(){var e=document.getElementById("anim-controls");e.appendChild(document.createTextNode(C.runkmeans));var t=document.createElement("p");t.innerHTML="&nbsp",t.id="clustering",e.appendChild(t);var n=document.createElement("button");n.id="stop",n.innerHTML="&#9606",n.addEventListener("click",rn),e.appendChild(n);var r=document.createElement("button");r.id="play-pause",r.innerHTML="&#9654",r.addEventListener("click",on);var o=document.createElement("button");return o.id="play-step",o.innerHTML="&#9654&#9614",o.addEventListener("click",function(e){3==oe&&(fe?(clearInterval(fe),fe=void 0,e.innerHTML="&#9654"):ln())}.bind(this,r)),e.appendChild(o),e.appendChild(r),e}();!function(e,t){re=document.getElementById("cluster-slider"),S.create(re,{start:[1],handles:1,range:{min:1,max:3},step:1,orientation:"vertical",direction:"rtl",pips:{mode:"steps",stepped:!0,density:100,filter:function(){return 1},format:{to:function(t){switch(t){case 1:return C.showcentroids;case 2:return C.removegraph;case 3:return e;default:return""}},from:function(){return""}}}}),re.noUiSlider.on("update",hn),re.style="margin-top: 20px;";var n=K.getBoundingClientRect().height,r=t.getBoundingClientRect().height;re.style.height=_-n-r-120+"px";var o=document.createElement("input");o.type="checkbox",o.style="margin-top: 30px",o.addEventListener("click",function(){if(1!=oe||ve)this.checked=!this.checked;else{Je=this.checked,O.selectAll(".centroid").remove();var e,t=[],n=0;for(e in Ee)t[n++]={value:e,selected:!0,colour:Ee[e].colour};Je?jt(t):_t(t),Dt()}}),re.appendChild(o);var i=document.createElement("label");i.appendChild(document.createTextNode(C.geometrics)),re.appendChild(i)}(e,t),Ln()}Tn()},De/2)}function zt(e){Gt(e)&&(Xe=Date.now(),O.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+e).attr("points",Mn(B.event.x,B.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",Ee[e].colour).style("opacity",.5))}function Ut(e){B.select("#dragged-"+e).attr("points",Mn(B.event.x,B.event.y))}function Xt(e,t,n){if(B.selectAll(".dragged-centroid").remove(),Gt(e))if(Date.now()-Xe<300)Fn(T[e],e,!1);else{Ue||function(){for(var e in $)if(!(e>=0)){Ke[e]={};for(var t=0;t<$[e].length;t++)for(var n in $[e][t].members){var r=M[$[e][t].members[n].id];Ke[e][r]=t}}}();var r=Pt();if(0==Object.keys(Ke[r]).length)for(var i=0;i<$[r].length;i++)for(var l in $[r][i].members){var s=M[$[r][i].members[l].id];Ke[r][s]=i}var a=Hn(B.event);for(var c in Ke)c<=r&&(Ke[c][e]=a);Jt(r,t,n),Ue=!0,Wt(r),function(e){for(var t={clusterCoords:[],members:[]},n=0;n<Qe.length;n++){var r=Qe[n]?Qe[n]:Ie[n];for(var i in t.clusterCoords[n]=pn(r),t.clusterCoords[n].num=n,Ke[e])Ke[e][i]==n&&(t.members[t.members.length]={id:T[i],num:n})}t.iteration=e,t.clusterId=Re.clusterId,t.coordsid=I,yt(o,t)}(r)}}function Wt(e){if(!(e>=0)&&Ke[e]&&0!=Object.keys(Ke[e]).length){var t,n=function(e){var t,n,r,o=0,i=0,l=0,s=[];for(r=0;r<Ie.length;r++){for(var a in we)we[a].ci==r&&Ke[e][a]==we[a].ci?o++:we[a].ci==r&&Ke[e][a]!=we[a].ci?i++:Ke[e][a]==r&&Ke[e][a]!=we[a].ci&&l++;t=o/(o+i),n=o/(o+l),s[r]={tp:o,fp:i,fn:l,precision:t,recall:n,f1:t+n==0?0:2*t*n/(t+n),fhalf:t+n==0?0:1.25*t*n/(.25*t+n),f2:t+n==0?0:5*t*n/(4*t+n)},o=0,i=0,l=0}for(r=0;r<s.length;r++)o+=s[r].tp,i+=s[r].fp,l+=s[r].fn;return t=o/(o+i),n=o/(o+l),s[s.length]={tp:o,fp:i,fn:l,precision:t,recall:n,f1:t+n==0?0:2*t*n/(t+n),fhalf:t+n==0?0:1.25*t*n/(.25*t+n),f2:t+n==0?0:5*t*n/(4*t+n)},s}(e),r=C.manualcluster+"\n";for(t=0;t<Qe.length;t++)if(Qe[t]){var o=Qe[t].x-F/2,i=Qe[t].y-_/2,l=Math.sqrt(o*o+i*i);for(var s in r+=C.disttocluster+" "+t+": "+Math.round(l)+"\n"+C.cluster+" "+t+" "+C.members+": [",Ke[e])Ke[e][s]==t&&(r+=s+", ");-1!=r.indexOf(",",r.length-3)&&(r=r.slice(0,-2)),r+="]\n",Ge&&(r+=C.precision+": "+n[t].precision.toFixed(4)+"\n",r+=C.recall+": "+n[t].recall.toFixed(4)+"\n",r+=C.f1+": "+n[t].f1.toFixed(4)+"\n",r+=C.fhalf+": "+n[t].fhalf.toFixed(4)+"\n",r+=C.f2+": "+n[t].f2.toFixed(4)+"\n")}var a=le.value.split("\n\n"),c=a[0].split("\n");for(le.value="",t=0;t<c.length&&!c[t].startsWith(C.manualcluster);t++)le.value+=c[t]+"\n";for(Ge&&(t=n.length-1,r+=C.totalmeasures+"\n",r+=C.precision+": "+n[t].precision.toFixed(4)+"\n",r+=C.recall+": "+n[t].recall.toFixed(4)+"\n",r+=C.f1+": "+n[t].f1.toFixed(4)+"\n",r+=C.fhalf+": "+n[t].fhalf.toFixed(4)+"\n",r+=C.f2+": "+n[t].f2.toFixed(4)+"\n"),le.value+=r+"\n",t=1;t<a.length;t++)le.value+=a[t]+"\n\n"}}function Gt(e){if(document.getElementById("replayer").innerHTML!=C.convergence)return!1;if(We!=p)return!1;var t,n=we[e].ci,r=0;for(t in we)we[t].ci==n&&r++;var o=Pt(),i=0;if(Ke[o])for(t in n=Ke[o][e],Ke[o])Ke[o][t]==n&&i++;return!(1==r&&i<=1)&&1!=i}function Pt(){var e=le.value.split("\n");return e[2]&&e[2].startsWith(C.iteration)?parseInt(e[2].split(" ")[1]):null}function Jt(e,t,n){var r,o,i=[],l=[];for(r=0;r<$[e].length;r++)for(o in i[r]={},l[r]=[],Ke[e])if(Ke[e][o]==r){var s=we[o].x,a=we[o].y;i[r][s+"_"+a]={x:s,y:a,colour:Ie[r].colour},l[r][l[r].length]=[s,a]}var c=0==document.getElementsByClassName("manual-centroid").length;for(B.selectAll(".manual-hull").remove(),r=0;r<i.length;r++)qt(i[r],-1*(r+1),!0,c),Qe[r]=yn(l[r]);if(t)for(t[n.did]||(t[n.did]={}),t[n.did][n.gid]||(t[n.did][n.gid]={}),t[n.did][n.gid][n.cid]||(t[n.did][n.gid][n.cid]={}),t[n.did][n.gid][n.cid][e]||(t[n.did][n.gid][n.cid][e]=[]),r=0;r<Qe.length;r++)if(Qe[r]){var d=[];for(o in Ke[e])Ke[e][o]==r&&(d[d.length]={id:T[o],num:r});t[n.did][n.gid][n.cid][e][r]={centroidx:Qe[r].x,centroidy:Qe[r].y,members:d}}c?function(){B.selectAll(".manual-centroid").remove();for(var e,t,n=14,r=0;r<Qe.length;r++){if(!Qe[r])return;e=Qe[r].x,t=Qe[r].y,O.append("line").attr("class","manual-centroid").attr("id","manual1-"+r).attr("x1",e-n).attr("y1",t-n).attr("x2",e+n).attr("y2",t+n).style("stroke",Ie[r].colour).style("stroke-width","5px").style("opacity",0).on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(r+1),r,!0)).on("mouseover",cn.bind(this,r,!0)),O.append("line").attr("class","manual-centroid").attr("id","manual2-"+r).attr("x1",e+n).attr("y1",t-n).attr("x2",e-n).attr("y2",t+n).style("stroke",Ie[r].colour).style("stroke-width","5px").style("opacity",0).on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(r+1),r,!0)).on("mouseover",cn.bind(this,r,!0))}B.selectAll(".manual-centroid").transition().duration(De).style("opacity",.5),B.selectAll(".manual-hull").transition().duration(De).style("stroke-opacity",1).style("fill-opacity",ke)}():function(){for(var e,t,n=14,r=0;r<Qe.length;r++){if(!Qe[r])return void B.selectAll(".manual-centroid").remove();e=Qe[r].x,t=Qe[r].y,B.select("#manual1-"+r).transition().duration(De).attr("x1",e-n).attr("y1",t-n).attr("x2",e+n).attr("y2",t+n).style("display","block"),B.select("#manual2-"+r).transition().duration(De).attr("x1",e+n).attr("y1",t-n).attr("x2",e-n).attr("y2",t+n).style("display","block")}}(),O.selectAll(".centroid").raise(),O.selectAll(".clustering-centroid").raise(),O.selectAll(".manual-centroid").raise()}function Yt(){B.event.stopPropagation()}function Zt(e,t){for(var n in e)e[n].x*=Re.distance,e[n].x+=Re.originalx,e[n].y*=Re.distance,e[n].y+=Re.originaly,t&&(e[n].x-=Re.centre.x,e[n].x*=Re.scale,e[n].x+=F/2,e[n].y-=Re.centre.y,e[n].y*=Re.scale,e[n].y+=_/2)}function Kt(){O&&setTimeout(function(){O.remove(),Qt(),document.getElementById("replayer").innerHTML="&nbsp;"},500),$=void 0,Vt();for(var e=document.getElementById("replay-select"),t=0;t<e.options.length;t++)e.options[t].selected&&(e.options[t].selected=!1)}function Qt(){le.readOnly=!1,le.value="",setTimeout(function(){le.readOnly=!0},300)}function Vt(){var e=document.getElementById("replay-pause");e.innerHTML="&#9654",e.value="play",clearInterval(fe)}function $t(){if($){var e=document.getElementById("replay-pause");"play"==e.value?(e.innerHTML="&#9613&#9613",e.value="pause",en(!1),fe=setInterval(en.bind(this,!1),1200)):Vt()}}function en(e){if($){e&&Vt();var t=++pe-1;return pe>te&&$[-1]&&!$[(t=te-pe+1)-1]?(pe--,void Vt()):t>te?(pe--,void Vt()):void(1==pe?(oe=2,ve=!0,Te=!1,bn()):2==pe?(kn(),nn(t-1,!1,!0)):nn(t-1,!1,!1))}}function tn(){if($&&ee&&!(pe-1<0)){Vt();var e=--pe-1;pe>te&&(e=te-pe+1),0==pe?(oe=1,xn(),ve=!1,le.value=le.value.slice(le.value.indexOf("\n\n")+2),document.getElementById("replayer").innerHTML="&nbsp;"):1==pe?(bn(),le.value=le.value.slice(le.value.indexOf("\n\n")+2),document.getElementById("replayer").innerHTML="&nbsp;"):nn(e-1,!0,2==pe)}}function nn(e,t,n){var r,o=[],i={},l={};for(r=0;r<$[e].length;r++,l={}){for(var s in O.selectAll("#hull-"+r).remove(),Ie[r].x=$[e][r].centroidx,Ie[r].y=$[e][r].centroidy,$[e][r].members){var a=$[e][r].members[s].x,c=$[e][r].members[s].y,d=M[$[e][r].members[s].id];Ee[d].x=a,Ee[d].y=c,l[a+"_"+c]={x:a,y:c,colour:Ie[r].colour},i[d]=r}o[r]=l}if(Zt(Ie,!0),n)an();else{for(Zt(Ee,!1),r=0;r<o.length;r++)Zt(o[r],!0),qt(o[r],r,!1,!1);fn(De)}if(En(ee[2],ee[0],ee[1],De),O.selectAll(".centroid").raise(),O.selectAll(".clustering-centroid").raise(),function(e){if(!e||e>0)return O.selectAll(".manual-centroid").remove(),void O.selectAll(".manual-hull").remove();Ue&&Jt(e,null,null)}(e),t)le.value=le.value.slice(le.value.indexOf("\n\n")+2);else{for(var u in i)we[u].ci=i[u];gn(e),Wt(e)}document.getElementById("replayer").innerHTML=e<0?C.convergence:C.iteration+" "+e}function rn(){for(var e in ve=!1,pe=0,clearInterval(fe),fe=void 0,Re.clusterId=Date.now(),3==oe?(re.noUiSlider.set(2),setTimeout(function(){re.noUiSlider.set(1),oe=1},De)):(re.noUiSlider.set(1),oe=1),document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("num-clusters")&&(document.getElementById("num-clusters").readOnly=!1,document.getElementById("num-clusters").value=""),B.selectAll(".clustering-centroid").transition(H).style.display="none",B.selectAll(".cluster-hull").transition(H).style.display="none",setTimeout(function(){B.selectAll(".clustering-centroid").remove(),B.selectAll(".cluster-hull").remove(),Qt()},De),we)we[e].ci=void 0}function on(){3==oe&&(fe?(clearInterval(fe),fe=void 0,this.innerHTML="&#9654"):(fe=setInterval(ln,1e3),this.innerHTML="&#9613&#9613"))}function ln(){if(0==pe){ve=!0;var e=document.getElementById("num-clusters"),t=parseInt(e.value);(isNaN(t)||t<2)&&(t=3);var n,r,o={};for(var i in Ee)o[Ee[i].x+"_"+Ee[i].y]=1;for(;t>Object.keys(o).length;)t--;for(e.value=t,e.readOnly=!0,Ie=[],Le=null,n=0,r=0;n<t;n++)if(r<ye.length)Ie[n]=sn(null,ye[r++]);else{for(var l;!l;)l=de[Math.floor(N.random()*de.length)],l=ye.includes(l)?void 0:l;Ie[n]=sn(null,l)}an(),document.getElementById("clustering").innerHTML=C.randcentroids;var s=gn(pe);Re.iteration=pe,vn(s)}else!function(e){if(document.getElementById("clustering").innerHTML!=C.convergence)if(0!=Object.keys(we).length){var t,n,r,o,i=C.iteration+": "+e;for(t in we)we[t].ci=Hn(we[t]);var l=[];for(n=0;n<Ie.length;n++)l[n]=mn(n);Le=Ie,Ie=l;var s=!1;if(Le){var a=0;for(n=0;n<Ie.length;n++)r=Le[n].x-Ie[n].x,o=Le[n].y-Ie[n].y,a+=Math.sqrt(r*r+o*o);a<=Se&&(i=C.convergence,s=!0)}document.getElementById("clustering").innerHTML=i;var c=gn(e);Re.iteration=s?-1:e,vn(c)}else document.getElementById("clustering").innerHTML=C.convergence}(pe),fn(De);pe++,document.getElementById("clustering").innerHTML==C.convergence&&(clearInterval(fe),fe=void 0,document.getElementById("play-pause").innerHTML="&#9654")}function sn(e,t){var n,r,o,i,l=F-100,s=_-100,a=0;if(e)for(;a<100;)n=Math.floor(Math.random()*(l-100)+100),r=Math.floor(Math.random()*(s-100)+100),o=n-e.x,i=r-e.y,a=Math.sqrt(o*o+i*i);else n=Math.floor(Math.random()*(l-100)+100),r=Math.floor(Math.random()*(s-100)+100);return{x:n,y:r,colour:t}}function an(){B.selectAll(".clustering-centroid").remove();var e,t,n,r=14;for(e=0;e<Ie.length;e++)t=Ie[e].x,n=Ie[e].y,O.append("line").attr("class","clustering-centroid").attr("id","cluster1-"+e).attr("x1",t-r).attr("y1",n-r).attr("x2",t+r).attr("y2",n+r).style("stroke",Ie[e].colour).style("stroke-width","5px").on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(e+1),e,!0)).on("mouseover",cn.bind(this,e,!1)),O.append("line").attr("class","clustering-centroid").attr("id","cluster2-"+e).attr("x1",t+r).attr("y1",n-r).attr("x2",t-r).attr("y2",n+r).style("stroke",Ie[e].colour).style("stroke-width","5px").on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(e+1),e,!0)).on("mouseover",cn.bind(this,e,!1))}function cn(e,t){R.remove(),Te=!0,Me=!1,Ce=!0,O.on("click",dn);var n,r={};if(t){var o=Pt();for(n in Ke[o])Ke[o][n]==e&&(r[n]=n)}else for(n in we)we[n].ci==e&&(r[n]=n);var i,l=Object.keys(r).length,s={};for(i=0;i<G.nodes.length;i++)G.nodes[i].visible||(s[G.nodes[i].id]=1);var a=function(e,t,n){var r,o,i,l,s,a,c={};for(r in e)for(a=Y[0];a<G.edges[r].length&&a<=Y[1];a++)"string"==typeof(o=G.edges[r][a]).source?(i=parseInt(o.source),l=parseInt(o.target)):(i=o.source.id,l=o.target.id),t[i]||t[l]||(s=i+"_"+l,i>l&&(s=l+"_"+i),c[s]?c[s][r]?c[s][r]++:c[s][r]=1:(c[s]={},c[s][r]=1));var d,u,m=[];for(d in c)if(Object.keys(c[d]).length==n){var y=Number.MAX_SAFE_INTEGER;for(u in c[d])y>c[d][u]&&(y=c[d][u]);var g=d.split("_");m[m.length]={source:g[0],target:g[1],weight:y,colour:"black"}}for(a=0;a<G.links.length;a++)m[m.length]=G.links[a];return m}(r,s,l);q.style("display","block").style("opacity",1).on("mouseover",it).on("mouseout",st),j.force("link").links(a),ot(a),R.on("mouseover",un).on("mouseout",st),j.restart(),setTimeout(function(){j.stop(),R.lower(),B.selectAll(".cluster-hull").lower()},10)}function dn(){Te=!1,Me=!0,Ce=!1,R.remove(),q.style("display","none").on("mouseover",null).on("mouseout",null),O.on("click",null)}function un(e){"black"==e.colour&&(R.on("mouseover",null),q.on("mouseover",null).on("mouseout",null),B.selectAll(".clustering-centroid").on("mouseover",null),it(e.source),Ae=!0,it(e.target,!0),Ae=!1)}function mn(e){var t,n=[],r={};for(t in we)we[t].ci==e&&(n[n.length]=[we[t].x,we[t].y],r[we[t].x+"_"+we[t].y]={x:we[t].x,y:we[t].y,colour:Ie[e].colour});if(O.selectAll("#hull-"+e).remove(),qt(r,e,!1,!1),O.selectAll(".centroid").raise(),O.selectAll(".clustering-centroid").raise(),0==Object.keys(r).length)return sn(Ie[e],Ie[e].colour);var o=yn(n);return o.colour=Ie[e].colour,o}function yn(e){if(0==e.length)return null;var t,n=0,r=0;for(t=0;t<e.length;t++)n+=e[t][0],r+=e[t][1];return{x:n/e.length,y:r/e.length}}function gn(e){var t,n,r,o,i,l=C.numstudents+": "+Object.keys(we).length+"\n"+C.numofclusters+": "+Ie.length+"\n"+C.iteration+": "+e+"\n",s=[];for(t=0;t<Ie.length;t++){for(i in n=Ie[t].x-F/2,r=Ie[t].y-_/2,o=Math.sqrt(n*n+r*r),l+=C.disttocluster+" "+t+": "+Math.round(o,2)+"\n"+C.cluster+" "+t+" "+C.members+": [",s[t]=[],we)we[i].ci==t&&(l+=i+", ",s[t][s[t].length]=i);-1!=l.indexOf(",",l.length-3)&&(l=l.slice(0,-2)),l+="]\n"}return l+="\n",le.value=l+le.value,s}function vn(e){var t,r,o,i={clusterCoords:[]};for(t=0;t<e.length;t++)for(i.clusterCoords[t]=pn(Ie[t]),i.clusterCoords[t].num=t,r=0;r<e[t].length;r++)o=pn(we[e[t][r]]),e[t][r]={id:T[e[t][r]],num:t,x:o.x,y:o.y};i.members=e,i.iteration=Re.iteration,i.clusterId=Re.clusterId,i.coordsid=I,i.usegeometric=Je?1:0,(0!=Y[0]||Y[1]!=G.maxSession)&&i.iteration<0&&(i.iteration=pe),yt(n,i)}function pn(e){var t=(e.x-F/2)/Re.scale+Re.centre.x,n=(e.y-_/2)/Re.scale+Re.centre.y;return{x:t=(t-Re.originalx)/Re.distance,y:n=(n-Re.originaly)/Re.distance}}function fn(e){var t,n,r,o=14;for(t=0;t<Ie.length;t++)n=Ie[t].x,r=Ie[t].y,B.select("#cluster1-"+t).transition().duration(e).attr("x1",n-o).attr("y1",r-o).attr("x2",n+o).attr("y2",r+o),B.select("#cluster2-"+t).transition().duration(e).attr("x1",n+o).attr("y1",r-o).attr("x2",n-o).attr("y2",r+o)}function hn(e,t){switch(parseInt(e[t])){case 1:if(3==oe){re.noUiSlider.set(2);break}oe=1,xn();break;case 2:oe=2,bn();break;case 3:if(1==oe){re.noUiSlider.set(2);break}if(oe=3,kn(),!ve){var n='<input type="text" placeholder="'+C.numclusters+'" id="num-clusters" size="8" pattern="[0-9]{1,2}">';document.getElementById("cluster-text").innerHTML=n}}}function xn(){Ht(!1),q.on("mouseover",null).on("mouseout",null),En(1,0,0,De),setTimeout(function(){B.selectAll(".centroid").raise()},100)}function bn(){q.transition(H).style("opacity",0),R.transition(H).style("opacity",0),B.selectAll(".clustering-centroid").transition(H).style("opacity",0),B.selectAll(".cluster-hull").transition(H).style("opacity",0),setTimeout(function(){q.style("display","none"),R.style("display","none"),B.selectAll(".clustering-centroid").style("display","none"),B.selectAll(".cluster-hull").style("display","none")},De),!ve&&document.getElementById("cluster-text")&&(document.getElementById("cluster-text").innerHTML=C.numclusters);var e=function(){var e,t=[];if(Q)return function(){var e,t=[],n=0,r=0;for(e in $)if(!(e>=0&&1!=e))for(var o in $[e])for(var i in $[e][o].members)n=(n=$[e][o].members[i].x)*g+Re.originalx,r=(r=$[e][o].members[i].y)*g+Re.originaly,t[t.length]=[n,r];var l=wn(t);if(null===l)return null;var s,a,c,d,u,m=[l.x,l.y],y=0,v=0;for(u=0;u<t.length;u++)s=Math.abs(t[u][0]-m[0]),a=Math.abs(t[u][1]-m[1]),s>y&&(y=s,c=u),a>v&&(v=a,d=u);if(void 0===d&&void 0===c)return m[2]=1,m;var p=t[c][0]-m[0]+F/2,f=t[c][1]-m[1]+_/2,h=In(p,f,F/2,_/2);p=t[d][0]-m[0]+F/2,f=t[d][1]-m[1]+_/2;var x=In(p,f,F/2,_/2);return m[2]=h<x?h:x,m[2]*=.9,m}();for(e in Ee)t[t.length]=[Ee[e].x,Ee[e].y];var n=wn(t);if(null===n)return null;var r,o,i,l,s=[n.x,n.y],a=0,c=0;for(e in Ee)r=Math.abs(Ee[e].x-s[0]),o=Math.abs(Ee[e].y-s[1]),r>a&&(a=r,i=e),o>c&&(c=o,l=e);if(void 0===l&&void 0===i)return s[2]=1,s;var d=Ee[i].x-s[0]+F/2,u=Ee[i].y-s[1]+_/2,m=In(d,u,F/2,_/2);d=Ee[l].x-s[0]+F/2,u=Ee[l].y-s[1]+_/2;var y=In(d,u,F/2,_/2);return s[2]=m<y?m:y,s[2]*=.9,s}();null!==e&&(Re.scale=e[2],ee=e,setTimeout(function(){En(e[2],e[0],e[1],De)},De/2))}function kn(){B.selectAll(".clustering-centroid").transition(H).style("display","block").style("opacity",1),B.selectAll(".cluster-hull").transition(H).style("display","block").style("opacity",1)}function En(e,t,n,r){var o,i,l,s,a,c,d=F/2,u=_/2;for(c in we={},Ee)we[c]={x:0,y:0};for(c in Re.centre={x:t,y:n},Ee)l=((o=Ee[c].x)-t)*e,s=((i=Ee[c].y)-n)*e,1==e&&0==t&&0==n?(o=t+l,i=n+s):(o=d+l,i=u+s),we[c].x=o,we[c].y=i,a=o+","+(i-14)+" "+(o+14)+","+(i+14)+" "+(o-14)+","+(i+14),B.select("#centroid-"+c).transition().duration(r).attr("points",a);var m=function(e,t){return e*=Re.distance,e+=Re.originalx,t*=Re.distance,t+=Re.originaly,e-=Re.centre.x,e*=Re.scale,e+=F/2,t-=Re.centre.y,t*=Re.scale,{x:e,y:t+=_/2}};for(c in Ze){var y=m(Ze[c].x,Ze[c].y);o=y.x,i=y.y,B.select("#server-centroid-"+c).transition().duration(r).attr("cx",o).attr("cy",i)}}function wn(e){if(0==e.length)return null;if(1==e.length)return{x:e[0][0],y:e[0][1]};var t,n,r,o=0,i=0,l=F,s=_;for(t=0;t<e.length;t++)(n=e[t][0])>o&&(o=n),n<l&&(l=n),(r=e[t][1])>i&&(i=r),r<s&&(s=r);return{x:(o+l)/2,y:(i+s)/2}}function In(e,t,n,r){var o=e-n,i=t-r,l=((o>0?F:0)-F/2)/o,s=((i>0?_:0)-_/2)/i;return isFinite(l)&&isFinite(s)&&l<=s?l:isFinite(l)&&!isFinite(s)?l:isFinite(s)?s:1}function Ln(){var e=document.getElementById("log-panel");e.style.width=c+"px";var t=document.createElement("button");t.innerHTML=C.copy,t.addEventListener("click",function(){le.select(),document.execCommand("copy")}),t.style.position="absolute",t.style.right=c-40+"px",e.appendChild(t);var n=document.createElement("button");n.innerHTML=C.print,n.addEventListener("click",function(){var e=window.open(),t=le.value.replace(/\n/g,"<br>");e.document.write("<html><head></head><body>"),e.document.write(t),e.document.write("</body></html>"),e.print(),e.close()}),n.style.position="absolute",n.style.right=c-100+"px",e.appendChild(n),(le=document.createElement("textarea")).readOnly=!0,le.rows=24,-1!=navigator.userAgent.indexOf("Chrome")?le.cols=28:le.cols=20,le.style.resize="none",le.style.border="2px solid black",le.style.position="absolute",le.style.right="6px",le.style.top="60px",e.appendChild(le)}function Tn(){var e;for(e in Ee)O.append("polygon").attr("class","centroid").attr("id","centroid-"+e).attr("points",Mn(Ee[e].x,Ee[e].y)).style("stroke","black").style("stroke-width","3px").style("fill",Ee[e].colour).call(B.drag().on("start",Cn.bind(this,e)).on("drag",An.bind(this,e)).on("end",Bn.bind(this,e))).on("mouseout",Nn).on("mouseover",On.bind(this,e)).on("click",Yt).on("click.centroidClick",Fn.bind(this,T[e],e,!1));if(Ye)for(e in Ze){var t=Ze[e].x*Re.distance+Re.originalx,n=Ze[e].y*Re.distance+Re.originaly;O.append("circle").attr("class","server-centroid").attr("id","server-centroid-"+e).attr("r",5).attr("cx",t).attr("cy",n).style("fill","black")}}function Mn(e,t){return e+","+(t-14)+" "+(e+14)+","+(t+14)+" "+(e-14)+","+(t+14)}function Cn(e){Sn()&&(Xe=Date.now(),O.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+e).attr("points",Mn(B.event.x,B.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",Ee[e].colour).style("opacity",.5))}function An(e){Sn()&&B.select("#dragged-"+e).attr("points",Mn(B.event.x,B.event.y))}function Bn(e){if(B.selectAll(".dragged-centroid").remove(),Sn())if(Date.now()-Xe<300)Fn(T[e],e,!1);else{we[e].ci=Hn(B.event);for(var t=[],n=0;n<Ie.length;n++)t[n]=mn(n);Le=Ie,Ie=t,fn(De);var r=C.iteration+": "+pe;document.getElementById("clustering").innerHTML=r;var o=gn(pe);Re.iteration=pe++,vn(o)}}function Hn(e){for(var t,n,r,o=Number.MAX_SAFE_INTEGER,i=-1,l=0;l<Ie.length;l++)n=e.x-Ie[l].x,r=e.y-Ie[l].y,(t=Math.sqrt(n*n+r*r))<o&&(o=t,i=l);return i}function Sn(){if(!Ie||!document.getElementById("clustering"))return!1;if(document.getElementById("clustering").innerHTML==C.convergence)return!1;for(var e in we)if(void 0===we[e].ci)return!1;return 3==oe}function Nn(){Te||(B.selectAll(".text").remove(),B.selectAll("rect").remove(),ve&&(q.style("display","none").style("opacity",0),R.remove()))}function On(e){if(!Te){B.selectAll(".text").remove(),B.selectAll("rect").remove();var t=O.append("rect"),n=[0],r=1==oe?Ee:we,o=O.append("text").attr("class","text").attr("id","t-"+e).attr("y",r[e].y+32).attr("dy",".40em").style("pointer-events","none").text(e).call(lt,30,r[e].x-18+8,n),i=18*n[0]+16;if(i+r[e].y+10>=_&&o.attr("y",_-i-(_-r[e].y)).text(e).call(lt,30,r[e].x-18+8,n),t.attr("id","r-"+e).attr("x",r[e].x-18).attr("y",i+r[e].y+10<=_?r[e].y+16:_-i-16-(_-r[e].y)).attr("width",46).attr("height",i).style("stroke","black").style("fill","yellow"),ve){R.remove();var l,s={};for(l=0;l<G.nodes.length;l++)G.nodes[l].visible||(s[G.nodes[l].id]=1);var a,c,d,u,m={};for(l=Y[0];l<G.edges[e].length&&l<=Y[1];l++)"string"==typeof(a=G.edges[e][l]).source?(c=parseInt(a.source),d=parseInt(a.target)):(c=a.source.id,d=a.target.id),s[c]||s[d]||(m[u=c+"_"+d]?m[u]++:m[u]=1);var y,g=[],v=G.edges[e][0].colour;for(a in m)y=a.split("_"),g[g.length]={source:y[0],target:y[1],weight:m[a],colour:v};for(l=0;l<G.links.length;l++)g[g.length]=G.links[l];j.force("link").links(g),ot(g),q.style("display","block").style("opacity",1),j.restart(),setTimeout(function(){j.stop(),q.lower(),R.lower()},1)}}}function Fn(e,t,n){if(ve&&!document.getElementById("textbox-"+e)&&null!==Pt()){var o=document.createElement("textarea");o.id="textbox-"+e,o.style.resize="both",o.style.position="absolute",L[e]&&(o.value=L[e]),We!=p&&(o.readOnly=!0),document.body.appendChild(o);var i,l=o.getBoundingClientRect(),s=document.getElementsByTagName("svg")[0].getBoundingClientRect(),a=n?Ie[t].x:we[t].x;i=a+l.width/2>=F?a+s.x-l.width:a-l.width/2<=0?a+s.x:a+s.x-l.width/2,o.style.left=i+"px";var c=n?Ie[t].y:we[t].y,d=c+190>=_?c+140:c+290;n&&(d=c+165>=_?c+165:c+265),o.style.top=d+"px";var u=document.createElement("button");u.innerHTML=We==p?C.save:C.close,u.id=e,u.style.position="absolute",u.style.left=i+"px",u.style.top=d+l.height+"px",document.body.appendChild(u),o.focus(),o.addEventListener("click",function(){this.parentNode.appendChild(this),u.parentNode.appendChild(u),this.focus()});var m=!1;o.addEventListener("mousedown",function(){m=!0}),o.addEventListener("mouseup",function(){m=!1}),o.addEventListener("mousemove",function(){m&&(l=this.getBoundingClientRect(),u.style.left=i+"px",u.style.top=d+l.height+"px")}),u.addEventListener("click",function(){if(We==p){var t={coordsid:I,clusterid:Re.clusterId,studentid:e,remark:o.value};""!=o.value&&o.value!=L[e]&&(L[e]=o.value,yt(r,t))}document.body.removeChild(o),document.body.removeChild(u)})}}!function(e){i=e.logs,l=e.users,s=e.mods,a=e.panelwidth,c=e.legendwidth,d=e.name,u=e.iframeurl,He=e.version38,m=e.positioning,y=e.nodecoords,v=e.courseid,p=e.userid,g=e.scale,f=e.graphs,h=e.scales,x=e.changes,b=e.names,k=e.allmods,E=e.setnames,w=p,I=e.lastchange,L=e.comments,C=e.strings,t=e.coordsscript,n=e.clustersscript,r=e.commentsscript,o=e.manualscript,A=e.sesskey,ze=e.gotallnodes,Q=e.replaying,Ye=e.debugcentroids,Ze=e.centroids,Ge=e.isresearcher,We=p,B=window.dataDrivenDocs,S=window.noUiSlider;var R,J,K=window.mersenneTwister;N=new K(259),ue=0,de=["aqua","blue","blueviolet","brown","cadetblue","chartreuse","chocolate","coral","cornflowerblue","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgrey","darkgreen","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgrey","dodgerblue","firebrick","forestgreen","fuchsia","gold","goldenrod","grey","green","greenyellow","hotpink","indianred","indigo","khaki","lawngreen","lightblue","lightcoral","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategrey","lightsteelblue","lime","limegreen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","navy","olive","olivedrab","orange","orangered","orchid","palegreen","paleturquoise","palevioletred","peru","plum","powderblue","purple","rebeccapurple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","sienna","silver","skyblue","slateblue","slategrey","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","yellow","yellowgreen"],Ne=Date.now()+3e3,De=1e3,H=B.transition().duration(De).ease(B.easeLinear),ie=120,Se=1,W=1e-4,z=1,je=wt,he=!1,xe=220,ke=.15,be=B.curveCatmullRomClosed,ae={},Re={},me={originalLinks:"lightgrey",grouping:"black",assign:"blue",quiz:"red",forum:"orange",resource:"green",lti:"yellow",url:"purple",book:"magenta",page:"cyan",lesson:"brown"},ye=["blue","red","orange","green","yellow","brown","purple","magenta","cyan"],Z=m?0:36,a=m?0:a,F=window.innerWidth-ie-c-150,_=window.innerHeight-Z-90,qe=Math.min(F,_)<500?6:8,T={},l.forEach(function(e){T[e.id]=e.realId}),Ve(),$e(),Q?(R=e.replaydata,J=e.manualdata,m=!0,y={0:0,1:1,2:2},_=window.innerHeight-190,function(){var e=document.getElementById("slider"),t=document.createElement("p");t.innerHTML="&nbsp",t.id="replayer",e.appendChild(t);var n=document.createElement("button");n.id="replay-stop",n.innerHTML="&#9606",n.addEventListener("click",Kt),e.appendChild(n);var r=document.createElement("button");r.id="replay-pause",r.innerHTML="&#9654",r.value="play",r.addEventListener("click",$t),e.appendChild(r);var o=document.createElement("button");o.id="replay-back",o.innerHTML="&#9614&#9664",o.addEventListener("click",tn),e.appendChild(o);var i=document.createElement("button");i.id="replay-forward",i.innerHTML="&#9654&nbsp&nbsp&#9614",i.addEventListener("click",en.bind(this,!0)),e.appendChild(i)}(),Ln(),function(e,t){var n=document.getElementById("student-menu");for(var r in(V=document.createElement("select")).size=3,V.id="replay-select",V.style="height: "+(_-12)+"px;",V.addEventListener("change",function(e,t){var n=function(e,t){var n,r,o=document.getElementById("replay-select");for(r=0;r<o.options.length;r++)if(o.options[r].selected){n=o.options[r].value.split("_");break}var a=n[0],c=n[1],d=n[2];for(var u in We=a.split("-")[0],Re.clusterId=d,I=e[a][c].last,y=e[a][c].nodes,g=e[a][c].scale,s=e[a][c].mods,$=e[a][c][d],i=e[a][c].logs,l=e[a][c].users,L=e[a][c][d].comments,M={},T={},l.forEach(function(e){T[e.id]=e.realId,M[e.realId]=e.id}),pe=0,oe=1,te=0,ne=0,$)isNaN(u)||(u>=0?te++:ne--);Qe=[],Ke={},Ue=!1;var m,v,p=t[a][c][d];if(p)for(Ue=!0,r=-1;r>=ne;r--)for(m in p[r]&&!p[r-1]&&(p[r-1]=p[r]),Ke[r]={},p[r])for(v in p[r][m].members){var f=p[r][m].members[v].id;Ke[r][M[f]]=m}Ie=[],Ee={};var h={},x=0;for(m in $[1]){if(r=Ie.length,Ie[r]={x:0,y:0},x<ye.length)Ie[r].colour=ye[x++];else{for(var b;!b;)b=de[Math.floor(N.random()*de.length)],b=ye.includes(b)?void 0:b;Ie[r].colour=b}for(v in $[1][m].members){var k=M[$[1][m].members[v].id];Ee[k]={x:$[1][m].members[v].x,y:$[1][m].members[v].y},h[k]=!0}}return{members:h,did:a,gid:c,cid:d}}(e,t),r=n.members;O&&(O.remove(),Vt(),Qt(),document.getElementById("replayer").innerHTML="&nbsp;"),P&&document.body.removeChild(P),Ve(),$e(),Y=[0,G.maxSession];for(var o=0;o<G.nodes.length;o++)void 0===G.nodes[o].xcoord&&(G.nodes[o].visible=!1);(function(e){(P=document.createElement("select")).multiple=!0,P.id="student-select",P.style.display="none",ue=0,l.forEach(function(e){Ct(e,P)});for(var t,n=0;n<P.options.length;n++)t=P.options[n].value,e[t]?P.options[n].selected=!0:P.options[n].selected=!1,Ee[t]&&(Ee[t].colour=P.options[n].colour);document.body.appendChild(P)})(r),nt(0),Ht(!1),q.on("mouseover",null).on("mouseout",null),Te=!0,setTimeout(function(){for(var e in Zt(Ee,!1),Tn(),j.on("tick",ct),Ee)B.select("#centroid-"+e).call(B.drag().on("start",zt.bind(this,e)).on("drag",Ut.bind(this,e)).on("end",Xt.bind(this,e,t,n)))},500)}.bind(this,e,t)),e){var o=0;for(var a in e[r]){var c=0;for(var d in o++,e[r][a])if(!isNaN(d)&&e[r][a][d][1]){var u=document.createElement("option");u.value=r+"_"+a+"_"+d,u.text=r.split("-")[0]+"_"+o+"_"+ ++c,V.appendChild(u)}}}n.appendChild(V)}(R,J)):m?(ge=!1,U=.01,X=.01,Oe=It,Fe=Lt,_e=Tt,ze&&Object.keys(y).length>0&&(z=0),f&&h&&function(){var e=document.getElementById("student-menu"),t=document.createElement("button");t.innerHTML=C.copy,t.addEventListener("click",gt),e.appendChild(t);var n=t.getBoundingClientRect().height,r=document.createElement("button");r.innerHTML=C.print,r.addEventListener("click",vt),e.appendChild(r),(ce=document.createElement("select")).size=3,ce.id="teacher-select",ce.style.minWidth="40px";var o=_-n-20;for(var i in ce.style.height=o+"px",ce.addEventListener("change",pt),h){var l=document.createElement("option");l.value=i,l.text=i,p==i&&(l.selected=!0),ce.appendChild(l)}e.appendChild(ce)}(),nt(.6),ht(),function(){var e=document.getElementById("student-menu"),t=document.createElement("input");t.id="weight-slider",t.type="range",t.min="-0.2",t.max="2",t.step="0.2",t.value="0.6",t.style.width="130px",t.addEventListener("change",function(){D.strength(this.value),document.getElementById("weights-output").innerHTML="&nbsp;= "+this.value}),e.appendChild(t);var n=document.createTextNode(C.linksweight);e.appendChild(n),(n=document.createElement("label")).id="weights-output",n.innerHTML="&nbsp;= "+t.value,e.appendChild(n)}(),setTimeout(function(){j.force("charge",null).force("x",null).force("y",null)},500)):(ge=!0,m=!0,U=0,Oe=null,Fe=null,_e=null,ze&&0!=Object.keys(y).length?(Mt(),nt(0),At()):(nt(.6),setTimeout(function(){Mt(),At()},500)),D=null)}(e)}});
