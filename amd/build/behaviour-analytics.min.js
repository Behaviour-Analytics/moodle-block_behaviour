!function(e){"function"==typeof define&&define.amd?define([],e):window.behaviourAnalytics=e()}(function(){return function(e){var u,i,m,c,f,h,x,o,d,p,v,b,k,l,y,g,E,w,s,a,I,L,T,M,C,A,B,H,S,N,O,F,_,j,q,R,D,z,U,X,W,G,P,J,Y,n,Z,K,Q,V,$,ee,te,ne,re,oe,ie,le,se,ae,ce,de,ue,me,ye,ge,pe,ve,fe,he,xe,be,ke,Ee,we,Ie,Le,Te,Me,Ce,Ae,Be,He,Se,Ne,Oe,Fe,_e,je,qe,Re,De,ze,Ue,Xe,We,Ge,Pe,Je,Ye,Ze,Ke,Qe={},Ve=[];function $e(){x.forEach(function(e){for(;!ye[e.entype];){var t=ue[Math.floor(F.random()*ue.length)],n=!0;for(var r in ye)ye[r]==t&&(n=!1);ye[e.entype]=n?t:void 0}})}function et(){J={nodes:[],links:[],edges:{},maxSession:0},r(),tt()}function r(){var t,n,r,o=J,i={};x.forEach(function(e){t=!0,r=n=void 0,b[e.id]?(t=1==b[e.id].visible&&1==b["g"+e.sect].visible,1!=b[e.id].visible||t||(b[e.id].visible=0),n=b[e.id].xcoord,r=b[e.id].ycoord):b["g"+e.sect]&&(t=1==b["g"+e.sect].visible&&y==L),o.nodes[o.nodes.length]={id:e.id,name:e.name,group:e.sect,type:e.type,entype:e.entype,colour:ye[e.entype],visible:t,xcoord:n,ycoord:r},i[e.sect]||(b["g"+e.sect]&&(t=1==b["g"+e.sect].visible,n=b["g"+e.sect].xcoord,r=b["g"+e.sect].ycoord),i[e.sect]={id:"g"+e.sect,name:B.section+" "+e.sect,group:e.sect,type:"grouping",colour:ye.grouping,visible:t,xcoord:n,ycoord:r},o.nodes[o.nodes.length]=i[e.sect]),o.links[o.links.length]={source:"g"+e.sect,target:e.id,weight:X,colour:ye.originalLinks}}),n=r=void 0,b.root&&(n=b.root.xcoord,r=b.root.ycoord);var e={id:"root",name:d,group:-1,type:"grouping",colour:ye.grouping,visible:!0,xcoord:n,ycoord:r};if(1<Object.keys(i).length)for(var l in i)o.links[o.links.length]={source:"root",target:i[l].id,weight:X,colour:ye.originalLinks};else o.nodes=o.nodes.filter(function(e){return"g0"!=e.id}),o.links.forEach(function(e){"g0"==e.source&&(e.source="root")});o.nodes[o.nodes.length]=e}function tt(){var e,t=J,n=0,r=0;Je={};for(var o=0;o<f.length;o++)e={source:f[o].moduleId,target:f[o].moduleId,weight:X,user:f[o].userId,colour:""},t.edges[f[o].userId]||(t.edges[f[o].userId]=[],Je[f[o].userId]=[],t.maxSession=t.maxSession<n?n:t.maxSession,r=n=0),b[f[o].moduleId]&&1==b[f[o].moduleId].visible&&(Je[f[o].userId][r++]=f[o].moduleId),o+1<f.length&&f[o].userId==f[o+1].userId?(e.target=f[o+1].moduleId,t.edges[f[o].userId][n++]=e):0==t.edges[f[o].userId].length&&(t.edges[f[o].userId][n++]=e);t.maxSession=t.maxSession<n?n:t.maxSession,h.forEach(function(e){t.edges[e.id]||(t.edges[e.id]=[])})}function nt(e){_=S.select("#graph").append("svg").attr("width",j).attr("height",q),U=S.forceLink(J.links).id(function(e){return e.id}).strength(e),R=S.forceSimulation(J.nodes).force("link",U).force("charge",S.forceManyBody().strength(-80)).force("collide",S.forceCollide().radius(12)).force("center",S.forceCenter(j/2,q/2)).force("x",S.forceX()).force("y",S.forceY()),rt(J.nodes,qe,Fe,_e,je),ot(J.links),_.on("click",function(){S.selectAll("#rctext").remove(),S.selectAll("#rcrect").remove(),(pe||v)&&D.on("mouseover",it).on("mouseout",st),V&&D.on("mouseover",null).on("mouseout",null)}),Ue&&v&&0<Object.keys(b).length?R.on("tick",ct):R.on("tick",dt);for(var t=0;t<80;t++)R.tick();v&&setTimeout(function(){R.stop(),R.on("tick",dt),ut(),0!=Object.keys(b).length&&Ue||(mt(),J.edges={},tt(),Ue=!0,X=pe?1:0)},500),pe&&!Ue&&setTimeout(function(){J.nodes=[],J.links=[],r()},600)}function rt(e,t,n,r,o){D=_.selectAll(".node").data(e).enter().append("circle").attr("class","node").attr("r",Re).on("mouseover",it).on("mouseout",st).on("contextmenu",t).call(S.drag().on("start",n).on("drag",r).on("end",o))}function ot(e){z=_.selectAll(".link").data(e).enter().append("line").attr("class","link").style("stroke",function(e){return e.colour}).style("stroke-width",function(e){return 2*e.weight+"px"})}function it(e,t){var n,r,o,i,l,s,a,c,d,u,m,y;Ce||(D.on("mouseover",null),t||(S.selectAll(".text").remove(),S.selectAll("rect").remove()),Date.now()-Oe<150||(i=o=r=!(n=[0]),l=150,s=304,a=154,c=e.type+"_"+e.name,Ae&&(a=s=0),d=_.append("text").attr("class","text").attr("id","t-"+e.id).attr("y",e.y+32).attr("dy",".40em").style("pointer-events","none").text(c).call(lt,l,e.x-78+8,n),(u=16*n[0]+16)+e.y>=q-a&&(d.attr("y",q-u-(q-e.y)).text(c).call(lt,l,e.x-78+8,n),r=!0),e.x<=s/2?(d.text(c).call(lt,l,e.x+8,n),i=!0):e.x>=j-s/2&&(d.text(c).call(lt,l,e.x-156+8,n),o=!0),m=i?e.x:o?e.x-156:e.x-78,y=_.append("rect").attr("id","r-"+e.id).attr("x",m).attr("y",r?q-u-16-(q-e.y):e.y+16).attr("width",166).attr("height",u).style("stroke","black").style("fill","yellow"),d.raise(),isNaN(e.id)||(Ae&&(s=400,a=300),function(e,t,n,r,o,i,l,s,a,c){var d=document.createElement("iframe");d.id="preview",d.style.position="absolute",d.style.width=r+"px",d.style.height=o+"px";var u=document.getElementsByTagName("svg")[0].getBoundingClientRect(),m=document.body.getBoundingClientRect();0<m.x&&(m.x=0);d.style.left=Be?window.innerWidth-10-r+"px":Ae?"10px":l?a+u.x+"px":s?a+u.x+n-r+18+"px":a+u.x-r/2+n/2+"px";var y=Se?0:50;d.style.top=Ae?u.y-m.y+q/2+"px":i?y+c+u.y-m.y-o+"px":y+c+u.y+t-m.y+"px";{var g;"lti"!=e.entype&&((g=document.createElement("div")).id="bgrnd",g.style.position="absolute",g.style.width=parseInt(d.style.width)+24+"px",g.style.height=parseInt(d.style.height)+24+"px",g.style.left=parseInt(d.style.left)-12+"px",g.style.top=parseInt(d.style.top)-12+"px",g.addEventListener("mouseout",function(e){var t=this.getBoundingClientRect();e.x>t.x&&e.x<t.x+t.width&&e.y>t.y&&e.y<t.y+t.height||(He=!1,setTimeout(at,750))}),g.addEventListener("mouseover",function(){He=!0}),d.src=p+"/mod/"+e.entype+"/view.php?id="+e.id,document.body.appendChild(g),document.body.appendChild(d))}}(e,u,l,s,a,r,i,o,parseInt(y.attr("x")),parseInt(y.attr("y"))))))}function lt(e,s,a,t){var c=0;e.each(function(){for(var e=S.select(this),t=e.text().split(/\s+/).reverse(),n=[],r=e.attr("y"),o=parseFloat(e.attr("dy")),i=e.text(null).append("tspan").attr("x",a).attr("y",r).attr("dy",o+"em"),l=t.pop();l;)n.push(l),i.text(n.join(" ")),i.node().getComputedTextLength()>s&&(n.pop(),i.text(n.join(" ")),n=[l],i=e.append("tspan").attr("x",a).attr("y",r).attr("dy",1.1*++c+o+"em").text(l)),l=t.pop()}),t[0]=++c}function st(e){Ce||"lightgrey"==e.colour||(D.on("mouseout",null),z.on("mouseout",null),setTimeout(at,750))}function at(){if(!He&&(S.selectAll(".text").remove(),S.selectAll("rect").remove(),S.selectAll("#preview").remove(),S.selectAll("#bgrnd").remove(),D.on("mouseover",it).on("mouseout",st),Ae)){z.on("mouseover",un).on("mouseout",st);for(var e=0;e<Le.length;e++)S.select("#cluster1-"+e).on("mouseover",cn.bind(this,e,!1)),S.select("#cluster2-"+e).on("mouseover",cn.bind(this,e,!1))}}function ct(){var t=j/2,r=q/2,o=k;void 0===De.originalx?(De.originalx=t,De.originaly=r):(t=De.originalx,r=De.originaly);for(var e,n,i=0;i<J.nodes.length;i++)e=J.nodes[i].xcoord*o+t,n=J.nodes[i].ycoord*o+r,(e<0||j<e||n<0||q<n)&&(o*=.9,--i);k=o,De.distance=o,z.attr("x1",function(n){var e=J.nodes.filter(function(e){var t="string"==typeof n.source?n.source:n.source.id;return e.id==t})[0];return S.select(this).attr("y1",e.ycoord*o+r),e.xcoord*o+t}).attr("x2",function(n){var e=J.nodes.filter(function(e){var t="string"==typeof n.target?n.target:n.target.id;return e.id==t})[0];return S.select(this).attr("y2",e.ycoord*o+r),e.xcoord*o+t}).style("display",function(e){return e.source.visible&&e.target.visible?"block":"none"}),D.attr("cx",function(e){return e.x=e.xcoord*o+t,e.x}).attr("cy",function(e){return e.y=e.ycoord*o+r,e.y}).style("display",function(e){return e.visible?"block":"none"}).style("fill",function(e){return e.colour}).raise()}function dt(){var t=Re;z.attr("x1",function(e){return e.source.x}).attr("y1",function(e){return e.source.y}).attr("x2",function(e){return e.target.x}).attr("y2",function(e){return e.target.y}).style("stroke-width",function(e){return 2*e.weight+"px"}).style("display",function(e){return e.source.visible&&e.target.visible?"block":"none"}),D.attr("cx",function(e){return e.x=Math.max(t,Math.min(j-t,e.x)),e.x}).attr("cy",function(e){return e.y=Math.max(t,Math.min(q-t,e.y)),e.y}).style("fill",function(e){return e.colour}).style("display",function(e){return e.visible?"block":"none"}).raise(),S.selectAll("rect").raise(),S.selectAll("text").raise()}function ut(){var e,t;s&&(S.select("#time").remove(),0==T&&(T=Date.now()),(e=new Date).setTime(T),(t=e.getMinutes())<10&&(t="0"+t),_.append("text").attr("id","time").attr("y",q-16).attr("dy",".40em").attr("x",6).style("pointer-events","none").text(s[L]+" "+e.getHours()+":"+t+" "+e.toDateString()))}function mt(){var t,n,r,o,i,l,s,a,e=(i={},l=0,s=j/2,a=q/2,J.nodes.forEach(function(e){t=e.x-s,n=e.y-a,r=Math.sqrt(t*t+n*n),l<r&&(l=r,o=e)}),i.scale=l,i.module=o.id,k=l,J.nodes.forEach(function(e){i[e.id]={xcoord:""+(e.x-s)/l,ycoord:""+(e.y-a)/l,visible:e.visible?1:0},e.xcoord||(e.xcoord=(e.x-s)/l,e.ycoord=(e.y-a)/l)}),b=i);if(g&&E){var c={};for(var d in e)"scale"!=d&&"module"!=d&&(c[d]=e[d]);g[y]=c,E[y]=e.scale}e.time=Date.now(),T=e.time,w&&(w[y]=e.time),yt(u,e)}function yt(e,t){var n=new XMLHttpRequest;n.open("POST",e),n.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onreadystatechange=function(){4==this.readyState&&this.status},n.send("cid="+l+"&data="+JSON.stringify(t)+"&sesskey="+H)}function gt(){var e=new Image,t=(new XMLSerializer).serializeToString(_.node());e.src="data:image/svg+xml;base64,"+window.btoa(t),document.body.appendChild(e);var n=document.createRange();n.setStartBefore(e),n.setEndAfter(e),n.selectNode(e),window.getSelection().addRange(n),document.execCommand("Copy"),document.body.removeChild(e)}function pt(){var e=(new XMLSerializer).serializeToString(_.node()),t=window.open();t.document.write('<img src="data:image/svg+xml;base64,'+window.btoa(e)+'"/>'),t.print(),t.close()}function vt(){for(var e,t=document.getElementById("teacher-select"),n=0;n<t.options.length;n++)if(t.options[n].selected){e=t.options[n].value;break}qe=e==y?(Fe=It,_e=Lt,je=Tt,wt):je=_e=Fe=null,b=g[e],k=E[e],T=w[e],x=a[e],d=I[e],L=e,_.remove(),ce={},$e(),S.selectAll("#legendUL").remove(),ht(),X=1,et(),X=0;var r=document.getElementById("weights-output").innerHTML,r=parseFloat(r.split(" ")[1]);for(var o in nt(r),ce)b[o]&&(ce[o].checked=1==b[o].visible),y==e?(ce[o].removeEventListener("change",ft),ce[o].addEventListener("change",kt)):(ce[o].removeEventListener("change",kt),ce[o].addEventListener("change",ft))}function ft(){this.checked=!this.checked}function ht(){var r;(ae=document.getElementById("legend")).style="width: "+o+"px; height: "+q+"px; min-width: "+o+"px; max-width: 500px;";function t(e){var t=r-e.x;r=e.x;var n=parseInt(ae.style.width)+t;500<n?n=500:n<o&&(n=o),ae.style.width=n+"px"}ae.addEventListener("mousemove",function(e){var t=ae.offsetLeft+28;e.x>=t&&e.x<=t+6?ae.style.cursor="col-resize":ae.style.cursor="auto"}),ae.addEventListener("mousedown",function(e){r=e.x,"col-resize"==ae.style.cursor&&ae.addEventListener("mousemove",t)}),document.addEventListener("mouseup",function(){ae.removeEventListener("mousemove",t)}),function(e){var t=document.createElement("ul");t.id="legendUL";var n=document.createElement("span");n.className="no-select-text",n.innerHTML=d;var r=document.createElement("li");r.appendChild(n);var o=document.createElement("ul");r.appendChild(o),t.appendChild(r);var i,l,s,a=-1;x.forEach(function(e){a!=e.sect&&((l=document.createElement("ul")).className="nested",(s=document.createElement("span")).className="caret",s.addEventListener("click",xt),(i=document.createElement("li")).appendChild(s),bt("g"+e.sect,B.section+" "+e.sect,ye.grouping,e.sect,"grouping",i),i.appendChild(l),o.appendChild(i),a++),(i=document.createElement("li")).className="indented",bt(e.id,e.name,ye[e.entype],e.sect,e.type,i),l.appendChild(i)}),e.appendChild(t)}(ae)}function xt(){this.parentElement.querySelector(".nested").classList.toggle("active"),this.classList.toggle("caret-down")}function bt(e,t,n,r,o,i){var l=document.createElement("input");l.type="checkbox",b[e]?l.checked=0!=b[e].visible:b["g"+r]?l.checked=1==b["g"+r].visible&&y==L:l.checked=!0,l.id=e,l.group=r,l.nodeT=o,l.addEventListener("change",kt),ce[l.id]=l;var s=document.createElement("label");s.style.color=n,s.className="no-select-text";var a="grouping"==o?t:o+"_"+t;s.appendChild(document.createTextNode(a)),i.appendChild(l),i.appendChild(s)}function kt(){var t=this.id,n=this.checked,r=this.nodeT,o=this.group;J.nodes.forEach(function(e){(e.id==t||"grouping"==r&&e.group==o||n&&"grouping"==e.type&&e.group==o)&&(e.visible=n,ce[e.id].checked=n)}),Et(),Bt()}function Et(){parseFloat(document.getElementById("weight-slider").value)<0&&(U.strength(0),document.getElementById("weights-output").innerHTML="&nbsp;= 0",document.getElementById("weight-slider").value=0)}function wt(e){var t,n,r;S.selectAll(".text").remove(),S.selectAll("rect").remove(),S.selectAll("#preview").remove(),S.selectAll("#bgrnd").remove(),S.event.preventDefault(),"root"!=e.id&&(t=e,D.on("mouseover",null).on("mouseout",null),n=_.append("rect"),r=_.append("text").attr("class","text").attr("id","rctext").attr("x",e.x+10).attr("y",e.y+12).attr("dy",".40em").style("pointer-events","none").text(B.hide),e.y+20>=q&&r.attr("y",q-(q-e.y)-10).text(B.hide),n.attr("id","rcrect").attr("x",e.x).attr("y",e.y+20<=q?e.y:q-(q-e.y)-20).attr("width",60).attr("height",24).style("stroke","black").style("fill","lightgrey"),n.on("mouseover",function(){S.event.target.style="fill: grey;"}),n.on("mouseout",function(){S.event.target.style="fill: lightgrey;"}),n.on("click",function(){S.selectAll("#rctext").remove(),S.selectAll("#rcrect").remove(),D.on("mouseover",it).on("mouseout",st),t.visible=!1,ce[t.id].checked=!1,"grouping"==t.type&&J.nodes.forEach(function(e){e.group==t.group&&(e.visible=!1,ce[e.id].checked=!1)}),Et(),Bt()}))}function It(e){S.event.active||R.alphaTarget(G).restart(),e.fx=e.x,e.fy=e.y}function Lt(e){S.selectAll("rect").remove(),S.selectAll(".text").remove(),S.selectAll("#preview").remove(),S.selectAll("#bgrnd").remove(),e.fx=S.event.x,e.fy=S.event.y}function Tt(e){S.event.active||(v?(R.stop(),mt(),ut()):R.alphaTarget(P)),e.fx=null,e.fy=null,Oe=Date.now()}function Mt(){var e=document.getElementById("student-menu");(Q=document.createElement("button")).innerHTML=B.cluster,Q.addEventListener("click",Dt),e.appendChild(Q);var t=Q.getBoundingClientRect().height;(Y=document.createElement("select")).multiple=!0,Y.id="student-select";var n=q-t-12;Y.style="height: "+n+"px;",Y.addEventListener("change",function(){for(var e=document.getElementById("student-select"),t=0;t<e.options.length;t++){var n="box-shadow: 0 0 10px 100px "+e.options[t].colour+" inset;";e.options[t].style=e.options[t].selected?n:"box-shadow: 0 0 0 0 white inset;"}0<f.length&&Ht(!0)}),h.forEach(function(e){Ct(e,Y)}),e.appendChild(Y)}function Ct(e,t){var n=document.createElement("option");n.value=e.id,n.text=e.id,n.colour=ue[me++],me>=ue.length&&(me=0),J.edges[e.id].forEach(function(e){e.colour=n.colour}),t.appendChild(n)}function At(){var t;n=document.getElementById("slider"),Z=[0,J.maxSession],t=J.maxSession<500?10:J.maxSession<1e3?20:J.maxSession<5e3?100:J.maxSession<1e4?200:500,O.create(n,{start:[0,J.maxSession],range:{min:[0],max:[J.maxSession]},step:1,connect:!0,pips:{mode:"steps",stepped:!0,density:100,filter:function(e){return 0==e||e==J.maxSession?1:e%t==0?2:0}}}),setTimeout(function(){n.noUiSlider.on("update",function(e,t){Z[t]=parseInt(e[t]),Y.dispatchEvent(new Event("change"))})},1e3)}function Bt(){z.remove(),D.remove(),S.selectAll(".hull").remove();var e=St(wt);Nt(e),Ft(e),R.alphaTarget(W).restart(),v&&setTimeout(function(){R.stop(),mt(),ut()},100)}function Ht(e){z.remove(),D.remove(),S.selectAll(".hull").remove(),v=!1;var t=St(null);Nt(t),e&&Ft(t),v=!0,R.on("tick",ct),R.restart(),setTimeout(R.stop,100)}function St(e){var t=[],n={};return J.nodes.forEach(function(e){null===e.fx&&(e.fx=e.x,e.fy=e.y),e.visible?t[t.length]=e:n[e.id]=1}),R.nodes(t),rt(t,e,Fe,_e,je),n}function Nt(e){var t,n,r,o,i=[];for(s in J.links)n="string"==typeof(r=J.links[s]).source?(t=r.source,r.target):(t=r.source.id,r.target.id),e[t]||e[n]||(i[i.length]=r);for(var l=v?[]:document.getElementById("student-select").options,s=0;s<l.length;s++)if(l[s].selected){for(var a,c={},d=Z[0];d<=Z[1]&&J.edges[l[s].value].length>d;d++)n="string"==typeof(o=J.edges[l[s].value][d]).source?(a=o.source+"_"+o.target,t=o.source,o.target):(a=o.source.id+"_"+o.target.id,t=o.source.id,o.target.id),c[a]?c[a]++:c[a]=1,e[t]||e[n]||(i[i.length]=o);for(d=Z[0];d<=Z[1]&&J.edges[l[s].value].length>d;d++)a="string"==typeof(o=J.edges[l[s].value][d]).source?o.source+"_"+o.target:o.source.id+"_"+o.target.id,o.weight=c[a]}R.force("link").links(i),ot(i)}function Ot(t){return J.nodes.find(function(e){return e.id==t})}function Ft(e){if(!v){S.selectAll(".hull").remove();for(var t,n,r,o=document.getElementById("student-select").options,i={},l=0;l<o.length;l++)if(o[l].selected){i[o[l].value]={};for(var s=Z[0];s<=Z[1]&&J.edges[o[l].value].length>s;s++){var a,c,d,u,m,y=J.edges[o[l].value][s];m="string"==typeof y.source?(n=y.source,r=y.target,a=(d=Ot(n)).x,c=d.y,u=(d=Ot(r)).x,d.y):(n=y.source.id,r=y.target.id,a=y.source.x,c=y.source.y,u=y.target.x,y.target.y),e[n]||e[r]||(t=y.colour,i[o[l].value][n]={x:a,y:c,colour:t},i[o[l].value][r]={x:u,y:m,colour:t})}}for(var g in i)qt(i[g],g,!1,!1);pe&&(o=document.getElementById("student-select").options,(Ye?jt:_t)(o))}}function _t(e){we={};for(var t=0;t<e.length;t++)if(e[t].selected){var n=e[t].value;if(Je[n].length<=Z[0])continue;var r=Z[0],o=Je[n].length>Z[1]+1?Z[1]:Je[n].length,i=parseInt(r/2+o/2),l=Je[n][i],s=parseFloat(b[l].xcoord),a=parseFloat(b[l].ycoord);we[n]={x:s*k+De.originalx,y:a*k+De.originaly,colour:e[t].colour}}}function jt(e){we={};for(var t=0;t<e.length;t++)if(e[t].selected){var n=e[t].value;if(Je[n].length<=Z[0])continue;for(var r,o=Z[0],i=Je[n].length>Z[1]+1?Z[1]:Je[n].length,l=0,s=0,a=0,c=o;c<i;c++)r=Je[n][c],l+=parseFloat(b[r].xcoord),s+=parseFloat(b[r].ycoord),a++;we[n]={x:l/a*k+De.originalx,y:s/a*k+De.originaly,colour:e[t].colour}}}function qt(e,t,n,r){if(0!=Object.keys(e).length){var o,i=[],u=20,l=pe?"hull":n?"manual-hull":"cluster-hull";for(var s in e)i[i.length]=[e[s].x,e[s].y],o=e[s].colour;if(1==i.length)d=function(e){var t=[e[0][0],e[0][1]-u],n=[e[0][0],e[0][1]+u];return"M "+t+" A "+[u,u,"0,0,0",n].join(",")+" A "+[u,u,"0,0,0",t].join(",")};else{if(2!=i.length){var a=S.concaveHull().padding(15);xe||a.distance(be);var c=4<i.length?a(i):[i];return d=S.line().curve(ke),void _.selectAll("#hull-"+t).data(c).enter().append("path").attr("id","hull-"+t).attr("class",l).style("stroke",o).style("stroke-opacity",r?0:1).style("fill",o).style("fill-opacity",r?0:Ee).attr("d",d)}function m(e,t){return[t[0]-e[0],t[1]-e[1]]}function y(e,t){return[t*e[0],t*e[1]]}function g(e,t){return[e[0]+t[0],e[1]+t[1]]}function p(e){var t=Math.sqrt(e[0]*e[0]+e[1]*e[1]);return y(e,1/t)}function v(e,t){return y(p(e),t)}var d=function(e){var t=m(e[0],e[1]),n=v(t,u),r=g(e[0],y(n,-1)),o=g(e[1],n),i=1.2*u,l=v(function(e,t){void 0!==t&&(e=m(e,t));var n=[-e[1],e[0]];return p(n)}(t),i),s=y(l,-1),a=g(r,s),c=g(o,s),d=g(r,l);return"M "+r+" C "+[a,c,o].join(",")+" S "+[d,r].join(",")+" Z"}}_.append("path").attr("id","hull-"+t).attr("class",l).style("stroke",o).style("stroke-opacity",r?0:1).style("fill",o).style("fill-opacity",r?0:Ee).attr("d",d(i))}}function Rt(){clearInterval(he),he=void 0,Qt(),S.selectAll(".clustering-centroid").remove(),S.selectAll(".cluster-hull").remove(),S.selectAll(".centroid").remove(),S.selectAll(".server-centroid").remove(),oe.style.display="none",document.getElementById("anim-controls").style.display="none",document.getElementById("log-panel").style.display="none",document.getElementById("student-menu").style.width=Q.style.width,Ae=!(pe=!0),n.style.display="block",Y.style.display="block",D.style("display","block"),D.style("opacity",1),z.style("display","block"),z.style("opacity",1),Ht(!0),D.on("mouseover",it).on("mouseout",st),Q.innerHTML=B.cluster,Q.removeEventListener("click",Rt),Q.addEventListener("click",Dt)}function Dt(){pe=!1,n.style.display="none",Y.style.display="none",S.selectAll(".hull").remove(),S.selectAll(".text").remove(),S.selectAll("rect").remove(),document.getElementById("student-menu").style.width=le+"px",Q.innerHTML=B.graph,Q.removeEventListener("click",Dt),Q.addEventListener("click",Rt),R.stop(),D.on("mouseover",null).on("mouseout",null).on("contextmenu",null).call(S.drag().on("start",null).on("drag",null).on("end",null)),De.clusterId=Date.now(),ve=!(M={}),ie=1,he=void(fe=0);var t='<p id="cluster-text">'+B.numclusters+"</p>";setTimeout(function(){var e;oe?(document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("cluster-text").innerHTML=t,document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("anim-controls").style.display="block",document.getElementById("log-panel").style.display="block",oe.noUiSlider.set(1),oe.style.display="block"):(e=function(){var e=document.getElementById("anim-controls");e.appendChild(document.createTextNode(B.runkmeans));var t=document.createElement("p");t.innerHTML="&nbsp",t.id="clustering",e.appendChild(t);var n=document.createElement("button");n.id="stop",n.innerHTML="&#9606",n.addEventListener("click",rn),e.appendChild(n);var r=document.createElement("button");r.id="play-pause",r.innerHTML="&#9654",r.addEventListener("click",on);var o=document.createElement("button");return o.id="play-step",o.innerHTML="&#9654&#9614",o.addEventListener("click",function(e){if(3!=ie)return;he?(clearInterval(he),he=void 0,e.innerHTML="&#9654"):ln()}.bind(this,r)),e.appendChild(o),e.appendChild(r),e}(),function(t,e){oe=document.getElementById("cluster-slider"),O.create(oe,{start:[1],handles:1,range:{min:1,max:3},step:1,orientation:"vertical",direction:"rtl",pips:{mode:"steps",stepped:!0,density:100,filter:function(){return 1},format:{to:function(e){switch(e){case 1:return B.showcentroids;case 2:return B.removegraph;case 3:return t;default:return""}},from:function(){return""}}}}),oe.noUiSlider.on("update",hn),oe.style="margin-top: 20px;";var n=Q.getBoundingClientRect().height,r=e.getBoundingClientRect().height;oe.style.height=q-n-r-120+"px";var o=document.createElement("input");o.type="checkbox",o.style="margin-top: 30px",o.addEventListener("click",function(){if(1!=ie||ve)this.checked=!this.checked;else{Ye=this.checked,_.selectAll(".centroid").remove();var e,t=[],n=0;for(e in we)t[n++]={value:e,selected:!0,colour:we[e].colour};(Ye?jt:_t)(t),Dt()}}),oe.appendChild(o);var i=document.createElement("label");i.appendChild(document.createTextNode(B.geometrics)),oe.appendChild(i)}(t,e),Ln()),Tn()},ze/2)}function zt(e){Gt(e)&&(We=Date.now(),_.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+e).attr("points",Mn(S.event.x,S.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",we[e].colour).style("opacity",.5))}function Ut(e){S.select("#dragged-"+e).attr("points",Mn(S.event.x,S.event.y))}function Xt(e,t,n){if(S.selectAll(".dragged-centroid").remove(),Gt(e))if(Date.now()-We<300)Fn(C[e],e,!1);else{Xe||function(){for(var e in ee)if(!(0<=e)){Qe[e]={};for(var t=0;t<ee[e].length;t++)for(var n in ee[e][t].members){var r=A[ee[e][t].members[n].id];Qe[e][r]=t}}}();var r=Pt();if(0==Object.keys(Qe[r]).length)for(var o=0;o<ee[r].length;o++)for(var i in ee[r][o].members){var l=A[ee[r][o].members[i].id];Qe[r][l]=o}var s=Hn(S.event);for(var a in Qe)a<=r&&(Qe[a][e]=s);Jt(r,t,n),Xe=!0,Wt(r),function(e){for(var t={clusterCoords:[],members:[]},n=0;n<Ve.length;n++){var r=Ve[n]?Ve[n]:Le[n];for(var o in t.clusterCoords[n]=vn(r),t.clusterCoords[n].num=n,Qe[e])Qe[e][o]==n&&(t.members[t.members.length]={id:C[o],num:n})}t.iteration=e,t.clusterId=De.clusterId,t.coordsid=T,yt(c,t)}(r)}}function Wt(e){if(!(0<=e)&&Qe[e]&&0!=Object.keys(Qe[e]).length){for(var t=function(e){var t,n,r,o=0,i=0,l=0,s=[];for(r=0;r<Le.length;r++){for(var a in Ie)Ie[a].ci==r&&Qe[e][a]==Ie[a].ci?o++:Ie[a].ci==r&&Qe[e][a]!=Ie[a].ci?i++:Qe[e][a]==r&&Qe[e][a]!=Ie[a].ci&&l++;t=o/(o+i),n=o/(o+l),s[r]={tp:o,fp:i,fn:l,precision:t,recall:n,f1:t+n==0?0:2*t*n/(t+n),fhalf:t+n==0?0:1.25*t*n/(.25*t+n),f2:t+n==0?0:5*t*n/(4*t+n)},l=i=o=0}for(r=0;r<s.length;r++)o+=s[r].tp,i+=s[r].fp,l+=s[r].fn;return t=o/(o+i),n=o/(o+l),s[s.length]={tp:o,fp:i,fn:l,precision:t,recall:n,f1:t+n==0?0:2*t*n/(t+n),fhalf:t+n==0?0:1.25*t*n/(.25*t+n),f2:t+n==0?0:5*t*n/(4*t+n)},s}(e),n=B.manualcluster+"\n",r=0;r<Ve.length;r++)if(Ve[r]){var o=Ve[r].x-j/2,i=Ve[r].y-q/2,l=Math.sqrt(o*o+i*i);for(var s in n+=B.disttocluster+" "+r+": "+Math.round(l)+"\n"+B.cluster+" "+r+" "+B.members+": [",Qe[e])Qe[e][s]==r&&(n+=s+", ");-1!=n.indexOf(",",n.length-3)&&(n=n.slice(0,-2)),n+="]\n",Pe&&(n+=B.precision+": "+t[r].precision.toFixed(4)+"\n",n+=B.recall+": "+t[r].recall.toFixed(4)+"\n",n+=B.f1+": "+t[r].f1.toFixed(4)+"\n",n+=B.fhalf+": "+t[r].fhalf.toFixed(4)+"\n",n+=B.f2+": "+t[r].f2.toFixed(4)+"\n")}var a=se.value.split("\n\n"),c=a[0].split("\n");for(se.value="",r=0;r<c.length&&!c[r].startsWith(B.manualcluster);r++)se.value+=c[r]+"\n";for(Pe&&(r=t.length-1,n+=B.totalmeasures+"\n",n+=B.precision+": "+t[r].precision.toFixed(4)+"\n",n+=B.recall+": "+t[r].recall.toFixed(4)+"\n",n+=B.f1+": "+t[r].f1.toFixed(4)+"\n",n+=B.fhalf+": "+t[r].fhalf.toFixed(4)+"\n",n+=B.f2+": "+t[r].f2.toFixed(4)+"\n"),se.value+=n+"\n",r=1;r<a.length;r++)se.value+=a[r]+"\n\n"}}function Gt(e){if(document.getElementById("replayer").innerHTML==B.convergence&&Ge==y){var t,n=Ie[e].ci,r=0;for(t in Ie)Ie[t].ci==n&&r++;var o=Pt(),i=0;if(Qe[o])for(t in n=Qe[o][e],Qe[o])Qe[o][t]==n&&i++;if(!(1==r&&i<=1)&&1!=i)return 1}}function Pt(){var e=se.value.split("\n");return e[2]&&e[2].startsWith(B.iteration)?parseInt(e[2].split(" ")[1]):null}function Jt(e,t,n){for(var r,o,i,l=[],s=[],a=0;a<ee[e].length;a++)for(r in l[a]={},s[a]=[],Qe[e]){Qe[e][r]==a&&(o=Ie[r].x,i=Ie[r].y,l[a][o+"_"+i]={x:o,y:i,colour:Le[a].colour},s[a][s[a].length]=[o,i])}var c=0==document.getElementsByClassName("manual-centroid").length;for(S.selectAll(".manual-hull").remove(),a=0;a<l.length;a++)qt(l[a],-1*(a+1),!0,c),Ve[a]=yn(s[a]);if(t)for(t[n.did]||(t[n.did]={}),t[n.did][n.gid]||(t[n.did][n.gid]={}),t[n.did][n.gid][n.cid]||(t[n.did][n.gid][n.cid]={}),t[n.did][n.gid][n.cid][e]||(t[n.did][n.gid][n.cid][e]=[]),a=0;a<Ve.length;a++)if(Ve[a]){var d=[];for(r in Qe[e])Qe[e][r]==a&&(d[d.length]={id:C[r],num:a});t[n.did][n.gid][n.cid][e][a]={centroidx:Ve[a].x,centroidy:Ve[a].y,members:d}}(c?function(){S.selectAll(".manual-centroid").remove();for(var e,t,n=0;n<Ve.length;n++){if(!Ve[n])return;e=Ve[n].x,t=Ve[n].y,_.append("line").attr("class","manual-centroid").attr("id","manual1-"+n).attr("x1",e-14).attr("y1",t-14).attr("x2",e+14).attr("y2",t+14).style("stroke",Le[n].colour).style("stroke-width","5px").style("opacity",0).on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(n+1),n,!0)).on("mouseover",cn.bind(this,n,!0)),_.append("line").attr("class","manual-centroid").attr("id","manual2-"+n).attr("x1",e+14).attr("y1",t-14).attr("x2",e-14).attr("y2",t+14).style("stroke",Le[n].colour).style("stroke-width","5px").style("opacity",0).on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(n+1),n,!0)).on("mouseover",cn.bind(this,n,!0))}S.selectAll(".manual-centroid").transition().duration(ze).style("opacity",.5),S.selectAll(".manual-hull").transition().duration(ze).style("stroke-opacity",1).style("fill-opacity",Ee)}:function(){for(var e,t,n=0;n<Ve.length;n++){if(!Ve[n])return S.selectAll(".manual-centroid").remove();e=Ve[n].x,t=Ve[n].y,S.select("#manual1-"+n).transition().duration(ze).attr("x1",e-14).attr("y1",t-14).attr("x2",e+14).attr("y2",t+14).style("display","block"),S.select("#manual2-"+n).transition().duration(ze).attr("x1",e+14).attr("y1",t-14).attr("x2",e-14).attr("y2",t+14).style("display","block")}})(),_.selectAll(".centroid").raise(),_.selectAll(".clustering-centroid").raise(),_.selectAll(".manual-centroid").raise()}function Yt(){S.event.stopPropagation()}function Zt(e,t){for(var n in e)e[n].x*=De.distance,e[n].x+=De.originalx,e[n].y*=De.distance,e[n].y+=De.originaly,t&&(e[n].x-=De.centre.x,e[n].x*=De.scale,e[n].x+=j/2,e[n].y-=De.centre.y,e[n].y*=De.scale,e[n].y+=q/2)}function Kt(){_&&setTimeout(function(){_.remove(),Qt(),document.getElementById("replayer").innerHTML="&nbsp;"},500),ee=void 0,Vt();for(var e=document.getElementById("replay-select"),t=0;t<e.options.length;t++)e.options[t].selected&&(e.options[t].selected=!1)}function Qt(){se.readOnly=!1,se.value="",setTimeout(function(){se.readOnly=!0},300)}function Vt(){var e=document.getElementById("replay-pause");e.innerHTML="&#9654",e.value="play",clearInterval(he)}function $t(){var e;ee&&("play"==(e=document.getElementById("replay-pause")).value?(e.innerHTML="&#9613&#9613",en(!(e.value="pause")),he=setInterval(en.bind(this,!1),1200)):Vt())}function en(e){if(ee){e&&Vt();var t=++fe-1;return ne<fe&&ee[-1]&&!ee[(t=ne-fe+1)-1]||ne<t?(fe--,void Vt()):void(1==fe?(ie=2,Me=!(ve=!0),bn()):2==fe?(kn(),nn(t-1,!1,!0)):nn(t-1,!1,!1))}}function tn(){var e;!ee||!te||fe-1<0||(Vt(),e=ne<--fe?ne-fe+1:fe-1,0==fe?(ie=1,xn(),ve=!1,se.value=se.value.slice(se.value.indexOf("\n\n")+2),document.getElementById("replayer").innerHTML="&nbsp;"):1==fe?(bn(),se.value=se.value.slice(se.value.indexOf("\n\n")+2),document.getElementById("replayer").innerHTML="&nbsp;"):nn(e-1,!0,2==fe))}function nn(e,t,n){for(var r=[],o={},i={},l=0;l<ee[e].length;l++,i={}){for(var s in _.selectAll("#hull-"+l).remove(),Le[l].x=ee[e][l].centroidx,Le[l].y=ee[e][l].centroidy,ee[e][l].members){var a=ee[e][l].members[s].x,c=ee[e][l].members[s].y,d=A[ee[e][l].members[s].id];i[(we[d].x=a)+"_"+(we[d].y=c)]={x:a,y:c,colour:Le[l].colour},o[d]=l}r[l]=i}if(Zt(Le,!0),n)an();else{for(Zt(we,!1),l=0;l<r.length;l++)Zt(r[l],!0),qt(r[l],l,!1,!1);fn(ze)}if(En(te[2],te[0],te[1],ze),_.selectAll(".centroid").raise(),_.selectAll(".clustering-centroid").raise(),function(e){if(!e||0<e)return _.selectAll(".manual-centroid").remove(),_.selectAll(".manual-hull").remove();Xe&&Jt(e,null,null)}(e),t)se.value=se.value.slice(se.value.indexOf("\n\n")+2);else{for(var u in o)Ie[u].ci=o[u];gn(e),Wt(e)}document.getElementById("replayer").innerHTML=e<0?B.convergence:B.iteration+" "+e}function rn(){for(var e in ve=!1,fe=0,clearInterval(he),he=void 0,De.clusterId=Date.now(),3==ie?(oe.noUiSlider.set(2),setTimeout(function(){oe.noUiSlider.set(1),ie=1},ze)):(oe.noUiSlider.set(1),ie=1),document.getElementById("clustering").innerHTML="&nbsp",document.getElementById("play-pause").innerHTML="&#9654",document.getElementById("num-clusters")&&(document.getElementById("num-clusters").readOnly=!1,document.getElementById("num-clusters").value=""),S.selectAll(".clustering-centroid").transition(N).style.display="none",S.selectAll(".cluster-hull").transition(N).style.display="none",setTimeout(function(){S.selectAll(".clustering-centroid").remove(),S.selectAll(".cluster-hull").remove(),Qt()},ze),Ie)Ie[e].ci=void 0}function on(){3==ie&&(he?(clearInterval(he),he=void 0,this.innerHTML="&#9654"):(he=setInterval(ln,1e3),this.innerHTML="&#9613&#9613"))}function ln(){if(0==fe){ve=!0;var e=document.getElementById("num-clusters"),t=parseInt(e.value);(isNaN(t)||t<2)&&(t=3);var n,r,o,i={};for(var l in we)i[we[l].x+"_"+we[l].y]=1;for(;t>Object.keys(i).length;)t--;for(e.value=t,e.readOnly=!0,Le=[],Te=null,r=n=0;n<t;n++)if(r<ge.length)Le[n]=sn(null,ge[r++]);else{for(;!o;)o=ue[Math.floor(F.random()*ue.length)],o=ge.includes(o)?void 0:o;Le[n]=sn(null,o)}an(),document.getElementById("clustering").innerHTML=B.randcentroids;var s=gn(fe);De.iteration=fe,pn(s)}else!function(e){{if(document.getElementById("clustering").innerHTML==B.convergence)return;if(0==Object.keys(Ie).length)return document.getElementById("clustering").innerHTML=B.convergence}var t,n,r,o,i=B.iteration+": "+e;for(t in Ie)Ie[t].ci=Hn(Ie[t]);var l=[];for(n=0;n<Le.length;n++)l[n]=mn(n);Te=Le,Le=l;var s=!1;if(Te){var a=0;for(n=0;n<Le.length;n++)r=Te[n].x-Le[n].x,o=Te[n].y-Le[n].y,a+=Math.sqrt(r*r+o*o);a<=Ne&&(i=B.convergence,s=!0)}document.getElementById("clustering").innerHTML=i;var c=gn(e);De.iteration=s?-1:e,pn(c)}(fe),fn(ze);fe++,document.getElementById("clustering").innerHTML==B.convergence&&(clearInterval(he),he=void 0,document.getElementById("play-pause").innerHTML="&#9654")}function sn(e,t){var n,r,o,i,l=j-100,s=q-100,a=0;if(e)for(;a<100;)n=Math.floor(Math.random()*(l-100)+100),r=Math.floor(Math.random()*(s-100)+100),o=n-e.x,i=r-e.y,a=Math.sqrt(o*o+i*i);else n=Math.floor(Math.random()*(l-100)+100),r=Math.floor(Math.random()*(s-100)+100);return{x:n,y:r,colour:t}}function an(){S.selectAll(".clustering-centroid").remove();for(var e,t,n=0;n<Le.length;n++)e=Le[n].x,t=Le[n].y,_.append("line").attr("class","clustering-centroid").attr("id","cluster1-"+n).attr("x1",e-14).attr("y1",t-14).attr("x2",e+14).attr("y2",t+14).style("stroke",Le[n].colour).style("stroke-width","5px").on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(n+1),n,!0)).on("mouseover",cn.bind(this,n,!1)),_.append("line").attr("class","clustering-centroid").attr("id","cluster2-"+n).attr("x1",e+14).attr("y1",t-14).attr("x2",e-14).attr("y2",t+14).style("stroke",Le[n].colour).style("stroke-width","5px").on("click",Yt).on("click.centroidClick",Fn.bind(this,-1*(n+1),n,!0)).on("mouseover",cn.bind(this,n,!1))}function cn(e,t){z.remove(),Ae=!(Ce=!(Me=!0)),_.on("click",dn);var n,r={};if(t){var o=Pt();for(n in Qe[o])Qe[o][n]==e&&(r[n]=n)}else for(n in Ie)Ie[n].ci==e&&(r[n]=n);for(var i=Object.keys(r).length,l={},s=0;s<J.nodes.length;s++)J.nodes[s].visible||(l[J.nodes[s].id]=1);var a=function(e,t,n){var r,o,i,l,s,a,c={};for(r in e)for(a=Z[0];a<J.edges[r].length&&a<=Z[1];a++)l="string"==typeof(o=J.edges[r][a]).source?(i=parseInt(o.source),parseInt(o.target)):(i=o.source.id,o.target.id),t[i]||t[l]||(c[s=l<i?l+"_"+i:i+"_"+l]?c[s][r]?c[s][r]++:c[s][r]=1:(c[s]={},c[s][r]=1));var d,u,m=[];for(d in c)if(Object.keys(c[d]).length==n){var y=Number.MAX_SAFE_INTEGER;for(u in c[d])y>c[d][u]&&(y=c[d][u]);var g=d.split("_");m[m.length]={source:g[0],target:g[1],weight:y,colour:"black"}}for(a=0;a<J.links.length;a++)m[m.length]=J.links[a];return m}(r,l,i);D.style("display","block").style("opacity",1).on("mouseover",it).on("mouseout",st),R.force("link").links(a),ot(a),z.on("mouseover",un).on("mouseout",st),R.restart(),setTimeout(function(){R.stop(),z.lower(),S.selectAll(".cluster-hull").lower()},10)}function dn(){Ae=!(Ce=!(Me=!1)),z.remove(),D.style("display","none").on("mouseover",null).on("mouseout",null),_.on("click",null)}function un(e){"black"==e.colour&&(z.on("mouseover",null),D.on("mouseover",null).on("mouseout",null),S.selectAll(".clustering-centroid").on("mouseover",null),it(e.source),Be=!0,it(e.target,!0),Be=!1)}function mn(e){var t,n=[],r={};for(t in Ie)Ie[t].ci==e&&(n[n.length]=[Ie[t].x,Ie[t].y],r[Ie[t].x+"_"+Ie[t].y]={x:Ie[t].x,y:Ie[t].y,colour:Le[e].colour});if(_.selectAll("#hull-"+e).remove(),qt(r,e,!1,!1),_.selectAll(".centroid").raise(),_.selectAll(".clustering-centroid").raise(),0==Object.keys(r).length)return sn(Le[e],Le[e].colour);var o=yn(n);return o.colour=Le[e].colour,o}function yn(e){if(0==e.length)return null;for(var t=0,n=0,r=0;r<e.length;r++)t+=e[r][0],n+=e[r][1];return{x:t/e.length,y:n/e.length}}function gn(e){for(var t,n,r,o,i=B.numstudents+": "+Object.keys(Ie).length+"\n"+B.numofclusters+": "+Le.length+"\n"+B.iteration+": "+e+"\n",l=[],s=0;s<Le.length;s++){for(o in t=Le[s].x-j/2,n=Le[s].y-q/2,r=Math.sqrt(t*t+n*n),i+=B.disttocluster+" "+s+": "+Math.round(r,2)+"\n"+B.cluster+" "+s+" "+B.members+": [",l[s]=[],Ie)Ie[o].ci==s&&(i+=o+", ",l[s][l[s].length]=o);-1!=i.indexOf(",",i.length-3)&&(i=i.slice(0,-2)),i+="]\n"}return i+="\n",se.value=i+se.value,l}function pn(e){for(var t,n,r={clusterCoords:[]},o=0;o<e.length;o++)for(r.clusterCoords[o]=vn(Le[o]),r.clusterCoords[o].num=o,t=0;t<e[o].length;t++)n=vn(Ie[e[o][t]]),e[o][t]={id:C[e[o][t]],num:o,x:n.x,y:n.y};r.members=e,r.iteration=De.iteration,r.clusterId=De.clusterId,r.coordsid=T,r.usegeometric=Ye?1:0,(0!=Z[0]||Z[1]!=J.maxSession)&&r.iteration<0&&(r.iteration=fe),yt(i,r)}function vn(e){var t=(e.x-j/2)/De.scale+De.centre.x,n=(e.y-q/2)/De.scale+De.centre.y;return{x:t=(t-De.originalx)/De.distance,y:n=(n-De.originaly)/De.distance}}function fn(e){for(var t,n,r=0;r<Le.length;r++)t=Le[r].x,n=Le[r].y,S.select("#cluster1-"+r).transition().duration(e).attr("x1",t-14).attr("y1",n-14).attr("x2",t+14).attr("y2",n+14),S.select("#cluster2-"+r).transition().duration(e).attr("x1",t+14).attr("y1",n-14).attr("x2",t-14).attr("y2",n+14)}function hn(e,t){switch(parseInt(e[t])){case 1:if(3==ie){oe.noUiSlider.set(2);break}ie=1,xn();break;case 2:ie=2,bn();break;case 3:if(1==ie){oe.noUiSlider.set(2);break}var n;ie=3,kn(),ve||(n='<input type="text" placeholder="'+B.numclusters+'" id="num-clusters" size="8" pattern="[0-9]{1,2}">',document.getElementById("cluster-text").innerHTML=n)}}function xn(){Ht(!1),D.on("mouseover",null).on("mouseout",null),En(1,0,0,ze),setTimeout(function(){S.selectAll(".centroid").raise()},100)}function bn(){D.transition(N).style("opacity",0),z.transition(N).style("opacity",0),S.selectAll(".clustering-centroid").transition(N).style("opacity",0),S.selectAll(".cluster-hull").transition(N).style("opacity",0),setTimeout(function(){D.style("display","none"),z.style("display","none"),S.selectAll(".clustering-centroid").style("display","none"),S.selectAll(".cluster-hull").style("display","none")},ze),!ve&&document.getElementById("cluster-text")&&(document.getElementById("cluster-text").innerHTML=B.numclusters);var e=function(){var e,t=[];if(V)return function(){var e,t=[],n=0,r=0;for(e in ee)if(!(0<=e&&1!=e))for(var o in ee[e])for(var i in ee[e][o].members)n=(n=ee[e][o].members[i].x)*k+De.originalx,r=(r=ee[e][o].members[i].y)*k+De.originaly,t[t.length]=[n,r];var l=wn(t);if(null===l)return null;var s,a,c,d,u,m=[l.x,l.y],y=0,g=0;for(u=0;u<t.length;u++)s=Math.abs(t[u][0]-m[0]),a=Math.abs(t[u][1]-m[1]),y<s&&(y=s,c=u),g<a&&(g=a,d=u);if(void 0===d&&void 0===c)return m[2]=1,m;var p=t[c][0]-m[0]+j/2,v=t[c][1]-m[1]+q/2,f=In(p,v,j/2,q/2);p=t[d][0]-m[0]+j/2,v=t[d][1]-m[1]+q/2;var h=In(p,v,j/2,q/2);return m[2]=f<h?f:h,m[2]*=.9,m}();for(e in we)t[t.length]=[we[e].x,we[e].y];var n=wn(t);if(null===n)return null;var r,o,i,l,s=[n.x,n.y],a=0,c=0;for(e in we)r=Math.abs(we[e].x-s[0]),o=Math.abs(we[e].y-s[1]),a<r&&(a=r,i=e),c<o&&(c=o,l=e);if(void 0===l&&void 0===i)return s[2]=1,s;var d=we[i].x-s[0]+j/2,u=we[i].y-s[1]+q/2,m=In(d,u,j/2,q/2);d=we[l].x-s[0]+j/2,u=we[l].y-s[1]+q/2;var y=In(d,u,j/2,q/2);return s[2]=m<y?m:y,s[2]*=.9,s}();null!==e&&(De.scale=e[2],te=e,setTimeout(function(){En(e[2],e[0],e[1],ze)},ze/2))}function kn(){S.selectAll(".clustering-centroid").transition(N).style("display","block").style("opacity",1),S.selectAll(".cluster-hull").transition(N).style("display","block").style("opacity",1)}function En(e,t,n,r){var o,i,l,s,a=j/2,c=q/2;for(s in Ie={},we)Ie[s]={x:0,y:0};for(s in De.centre={x:t,y:n},we)o=((y=we[s].x)-t)*e,i=((g=we[s].y)-n)*e,g=1==e&&0==t&&0==n?(y=t+o,n+i):(y=a+o,c+i),l=(Ie[s].x=y)+","+((Ie[s].y=g)-14)+" "+(y+14)+","+(g+14)+" "+(y-14)+","+(g+14),S.select("#centroid-"+s).transition().duration(r).attr("points",l);var d,u;for(s in Ke){var m=(d=Ke[s].x,u=Ke[s].y,d*=De.distance,d+=De.originalx,u*=De.distance,u+=De.originaly,d-=De.centre.x,d*=De.scale,d+=j/2,u-=De.centre.y,u*=De.scale,{x:d,y:u+=q/2}),y=m.x,g=m.y;S.select("#server-centroid-"+s).transition().duration(r).attr("cx",y).attr("cy",g)}}function wn(e){if(0==e.length)return null;if(1==e.length)return{x:e[0][0],y:e[0][1]};for(var t,n,r=0,o=0,i=j,l=q,s=0;s<e.length;s++)r<(t=e[s][0])&&(r=t),t<i&&(i=t),o<(n=e[s][1])&&(o=n),n<l&&(l=n);return{x:(r+i)/2,y:(o+l)/2}}function In(e,t,n,r){var o=e-n,i=t-r,l=((0<o?j:0)-j/2)/o,s=((0<i?q:0)-q/2)/i;return isFinite(l)&&isFinite(s)&&l<=s||isFinite(l)&&!isFinite(s)?l:isFinite(s)?s:1}function Ln(){var e=document.getElementById("log-panel");e.style.width=o+"px";var t=document.createElement("button");t.innerHTML=B.copy,t.addEventListener("click",function(){se.select(),document.execCommand("copy")}),t.style.position="absolute",t.style.right=o-40+"px",e.appendChild(t);var n=document.createElement("button");n.innerHTML=B.print,n.addEventListener("click",function(){var e=window.open(),t=se.value.replace(/\n/g,"<br>");e.document.write("<html><head></head><body>"),e.document.write(t),e.document.write("</body></html>"),e.print(),e.close()}),n.style.position="absolute",n.style.right=o-100+"px",e.appendChild(n),(se=document.createElement("textarea")).readOnly=!0,se.rows=24,-1!=navigator.userAgent.indexOf("Chrome")?se.cols=28:se.cols=20,se.style.resize="none",se.style.border="2px solid black",se.style.position="absolute",se.style.right="6px",se.style.top="60px",e.appendChild(se)}function Tn(){var e;for(e in we)_.append("polygon").attr("class","centroid").attr("id","centroid-"+e).attr("points",Mn(we[e].x,we[e].y)).style("stroke","black").style("stroke-width","3px").style("fill",we[e].colour).call(S.drag().on("start",Cn.bind(this,e)).on("drag",An.bind(this,e)).on("end",Bn.bind(this,e))).on("mouseout",Nn).on("mouseover",On.bind(this,e)).on("click",Yt).on("click.centroidClick",Fn.bind(this,C[e],e,!1));if(Ze)for(e in Ke){var t=Ke[e].x*De.distance+De.originalx,n=Ke[e].y*De.distance+De.originaly;_.append("circle").attr("class","server-centroid").attr("id","server-centroid-"+e).attr("r",5).attr("cx",t).attr("cy",n).style("fill","black")}}function Mn(e,t){return e+","+(t-14)+" "+(e+14)+","+(t+14)+" "+(e-14)+","+(t+14)}function Cn(e){Sn()&&(We=Date.now(),_.append("polygon").attr("class","dragged-centroid").attr("id","dragged-"+e).attr("points",Mn(S.event.x,S.event.y)).style("stroke","black").style("stroke-width","3px").style("fill",we[e].colour).style("opacity",.5))}function An(e){Sn()&&S.select("#dragged-"+e).attr("points",Mn(S.event.x,S.event.y))}function Bn(e){if(S.selectAll(".dragged-centroid").remove(),Sn())if(Date.now()-We<300)Fn(C[e],e,!1);else{Ie[e].ci=Hn(S.event);for(var t=[],n=0;n<Le.length;n++)t[n]=mn(n);Te=Le,Le=t,fn(ze);var r=B.iteration+": "+fe;document.getElementById("clustering").innerHTML=r;var o=gn(fe);De.iteration=fe++,pn(o)}}function Hn(e){for(var t,n,r,o=Number.MAX_SAFE_INTEGER,i=-1,l=0;l<Le.length;l++)n=e.x-Le[l].x,r=e.y-Le[l].y,(t=Math.sqrt(n*n+r*r))<o&&(o=t,i=l);return i}function Sn(){if(Le&&document.getElementById("clustering")&&document.getElementById("clustering").innerHTML!=B.convergence){for(var e in Ie)if(void 0===Ie[e].ci)return;if(3==ie)return 1}}function Nn(){Me||(S.selectAll(".text").remove(),S.selectAll("rect").remove(),ve&&(D.style("display","none").style("opacity",0),z.remove()))}function On(e){if(!Me){S.selectAll(".text").remove(),S.selectAll("rect").remove();var t=_.append("rect"),n=[0],r=1==ie?we:Ie,o=_.append("text").attr("class","text").attr("id","t-"+e).attr("y",r[e].y+32).attr("dy",".40em").style("pointer-events","none").text(e).call(lt,30,r[e].x-18+8,n),i=18*n[0]+16;if(i+r[e].y+10>=q&&o.attr("y",q-i-(q-r[e].y)).text(e).call(lt,30,r[e].x-18+8,n),t.attr("id","r-"+e).attr("x",r[e].x-18).attr("y",i+r[e].y+10<=q?r[e].y+16:q-i-16-(q-r[e].y)).attr("width",46).attr("height",i).style("stroke","black").style("fill","yellow"),ve){z.remove();for(var l={},s=0;s<J.nodes.length;s++)J.nodes[s].visible||(l[J.nodes[s].id]=1);var a,c,d,u,m={};for(s=Z[0];s<J.edges[e].length&&s<=Z[1];s++)d="string"==typeof(a=J.edges[e][s]).source?(c=parseInt(a.source),parseInt(a.target)):(c=a.source.id,a.target.id),l[c]||l[d]||(m[u=c+"_"+d]?m[u]++:m[u]=1);var y,g=[],p=J.edges[e][0].colour;for(a in m)y=a.split("_"),g[g.length]={source:y[0],target:y[1],weight:m[a],colour:p};for(s=0;s<J.links.length;s++)g[g.length]=J.links[s];R.force("link").links(g),ot(g),D.style("display","block").style("opacity",1),R.restart(),setTimeout(function(){R.stop(),D.lower(),z.lower()},1)}}}function Fn(t,e,n){var r,o,i,l,s,a,c,d,u;ve&&!document.getElementById("textbox-"+t)&&null!==Pt()&&((r=document.createElement("textarea")).id="textbox-"+t,r.style.resize="both",r.style.position="absolute",M[t]&&(r.value=M[t]),Ge!=y&&(r.readOnly=!0),document.body.appendChild(r),o=r.getBoundingClientRect(),i=document.getElementsByTagName("svg")[0].getBoundingClientRect(),l=n?Le[e].x:Ie[e].x,s=l+o.width/2>=j?l+i.x-o.width:l-o.width/2<=0?l+i.x:l+i.x-o.width/2,r.style.left=s+"px",a=n?Le[e].y:Ie[e].y,c=n?q<=a+165?a+165:a+265:q<=a+190?a+140:a+290,r.style.top=c+"px",(d=document.createElement("button")).innerHTML=Ge==y?B.save:B.close,d.id=t,d.style.position="absolute",d.style.left=s+"px",d.style.top=c+o.height+"px",document.body.appendChild(d),r.focus(),r.addEventListener("click",function(){this.parentNode.appendChild(this),d.parentNode.appendChild(d),this.focus()}),u=!1,r.addEventListener("mousedown",function(){u=!0}),r.addEventListener("mouseup",function(){u=!1}),r.addEventListener("mousemove",function(){u&&(o=this.getBoundingClientRect(),d.style.left=s+"px",d.style.top=c+o.height+"px")}),d.addEventListener("click",function(){var e;Ge==y&&(e={coordsid:T,clusterid:De.clusterId,studentid:t,remark:r.value},""!=r.value&&r.value!=M[t]&&(M[t]=r.value,yt(m,e))),document.body.removeChild(r),document.body.removeChild(d)}))}!function(e){f=e.logs,h=e.users,x=e.mods,e.panelwidth,o=e.legendwidth,d=e.name,p=e.iframeurl,Se=e.version38,v=e.positioning,b=e.nodecoords,l=e.courseid,y=e.userid,k=e.scale,g=e.graphs,E=e.scales,w=e.changes,s=e.names,a=e.allmods,I=e.setnames,L=y,T=e.lastchange,M=e.comments,B=e.strings,u=e.coordsscript,i=e.clustersscript,m=e.commentsscript,c=e.manualscript,H=e.sesskey,Ue=e.gotallnodes,V=e.replaying,Ze=e.debugcentroids,Ke=e.centroids,Pe=e.isresearcher,Ge=y,S=window.dataDrivenDocs,O=window.noUiSlider;var t,n,r=window.mersenneTwister;F=new r(259),me=0,ue=["aqua","blue","blueviolet","brown","cadetblue","chartreuse","chocolate","coral","cornflowerblue","crimson","cyan","darkblue","darkcyan","darkgoldenrod","darkgrey","darkgreen","darkmagenta","darkolivegreen","darkorange","darkorchid","darkred","darksalmon","darkseagreen","darkslateblue","darkslategrey","darkturquoise","darkviolet","deeppink","deepskyblue","dimgrey","dodgerblue","firebrick","forestgreen","fuchsia","gold","goldenrod","grey","green","greenyellow","hotpink","indianred","indigo","khaki","lawngreen","lightblue","lightcoral","lightgreen","lightpink","lightsalmon","lightseagreen","lightskyblue","lightslategrey","lightsteelblue","lime","limegreen","magenta","maroon","mediumaquamarine","mediumblue","mediumorchid","mediumpurple","mediumseagreen","mediumslateblue","mediumspringgreen","mediumturquoise","mediumvioletred","midnightblue","navy","olive","olivedrab","orange","orangered","orchid","palegreen","paleturquoise","palevioletred","peru","plum","powderblue","purple","rebeccapurple","red","rosybrown","royalblue","saddlebrown","salmon","sandybrown","seagreen","sienna","silver","skyblue","slateblue","slategrey","springgreen","steelblue","tan","teal","thistle","tomato","turquoise","violet","yellow","yellowgreen"],Oe=Date.now()+3e3,ze=1e3,N=S.transition().duration(ze).ease(S.easeLinear),le=120,P=1e-4,qe=wt,xe=!(X=Ne=1),be=220,Ee=.15,ke=S.curveCatmullRomClosed,ce={},De={},ye={originalLinks:"lightgrey",grouping:"black",assignment:"blue",quiz:"red",forum:"orange",file:"green","external tool":"yellow",url:"purple",book:"magenta",page:"cyan",lesson:"brown"},ge=["blue","red","orange","green","yellow","brown","purple","magenta","cyan"],K=v?0:36,j=window.innerWidth-le-o-150,q=window.innerHeight-K-90,Re=Math.min(j,q)<500?6:8,C={},h.forEach(function(e){C[e.id]=e.realId}),$e(),et(),V?(t=e.replaydata,n=e.manualdata,v=!0,b={0:0,1:1,2:2},q=window.innerHeight-190,function(){var e=document.getElementById("slider"),t=document.createElement("p");t.innerHTML="&nbsp",t.id="replayer",e.appendChild(t);var n=document.createElement("button");n.id="replay-stop",n.innerHTML="&#9606",n.addEventListener("click",Kt),e.appendChild(n);var r=document.createElement("button");r.id="replay-pause",r.innerHTML="&#9654",r.value="play",r.addEventListener("click",$t),e.appendChild(r);var o=document.createElement("button");o.id="replay-back",o.innerHTML="&#9614&#9664",o.addEventListener("click",tn),e.appendChild(o);var i=document.createElement("button");i.id="replay-forward",i.innerHTML="&#9654&nbsp&nbsp&#9614",i.addEventListener("click",en.bind(this,!0)),e.appendChild(i)}(),Ln(),function(e,t){var n=document.getElementById("student-menu");for(var r in($=document.createElement("select")).size=3,$.id="replay-select",$.style="height: "+(q-12)+"px;",$.addEventListener("change",function(e,t){var n=function(e,t){var n,r,o=document.getElementById("replay-select");for(r=0;r<o.options.length;r++)if(o.options[r].selected){n=o.options[r].value.split("_");break}var i=n[0],l=n[1],s=n[2];for(var a in Ge=i.split("-")[0],De.clusterId=s,T=e[i][l].last,b=e[i][l].nodes,k=e[i][l].scale,x=e[i][l].mods,ee=e[i][l][s],f=e[i][l].logs,h=e[i][l].users,M=e[i][l][s].comments,A={},C={},h.forEach(function(e){C[e.id]=e.realId,A[e.realId]=e.id}),ie=1,re=ne=fe=0,ee)isNaN(a)||(0<=a?ne++:re--);Ve=[],Qe={},Xe=!1;var c,d,u=t[i][l][s];if(u)for(Xe=!0,r=-1;re<=r;r--)for(c in u[r]&&!u[r-1]&&(u[r-1]=u[r]),Qe[r]={},u[r])for(d in u[r][c].members){var m=u[r][c].members[d].id;Qe[r][A[m]]=c}Le=[],we={};var y,g={},p=0;for(c in ee[1]){if(r=Le.length,Le[r]={x:0,y:0},p<ge.length)Le[r].colour=ge[p++];else{for(;!y;)y=ue[Math.floor(F.random()*ue.length)],y=ge.includes(y)?void 0:y;Le[r].colour=y}for(d in ee[1][c].members){var v=A[ee[1][c].members[d].id];we[v]={x:ee[1][c].members[d].x,y:ee[1][c].members[d].y},g[v]=!0}}return{members:g,did:i,gid:l,cid:s}}(e,t),r=n.members;_&&(_.remove(),Vt(),Qt(),document.getElementById("replayer").innerHTML="&nbsp;");Y&&document.body.removeChild(Y);$e(),et(),Z=[0,J.maxSession];for(var o=0;o<J.nodes.length;o++)void 0===J.nodes[o].xcoord&&(J.nodes[o].visible=!1);(function(e){(Y=document.createElement("select")).multiple=!0,Y.id="student-select",Y.style.display="none",me=0,h.forEach(function(e){Ct(e,Y)});for(var t,n=0;n<Y.options.length;n++)t=Y.options[n].value,e[t]?Y.options[n].selected=!0:Y.options[n].selected=!1,we[t]&&(we[t].colour=Y.options[n].colour);document.body.appendChild(Y)})(r),nt(0),Ht(!1),D.on("mouseover",null).on("mouseout",null),Me=!0,setTimeout(function(){for(var e in Zt(we,!1),Tn(),R.on("tick",ct),we)S.select("#centroid-"+e).call(S.drag().on("start",zt.bind(this,e)).on("drag",Ut.bind(this,e)).on("end",Xt.bind(this,e,t,n)))},500)}.bind(this,e,t)),e){var o=0;for(var i in e[r]){var l,s=0;for(var a in o++,e[r][i]){!isNaN(a)&&e[r][i][a][1]&&((l=document.createElement("option")).value=r+"_"+i+"_"+a,l.text=r.split("-")[0]+"_"+o+"_"+ ++s,$.appendChild(l))}}}n.appendChild($)}(t,n)):(v?function(){pe=!1,G=W=.01,Fe=It,_e=Lt,je=Tt,Ue&&0<Object.keys(b).length&&(X=0);g&&E&&function(){var e=document.getElementById("student-menu"),t=document.createElement("button");t.innerHTML=B.copy,t.addEventListener("click",gt),e.appendChild(t);var n=t.getBoundingClientRect().height,r=document.createElement("button");r.innerHTML=B.print,r.addEventListener("click",pt),e.appendChild(r),(de=document.createElement("select")).size=3,de.id="teacher-select",de.style.minWidth="40px";var o=q-n-20;for(var i in de.style.height=o+"px",de.addEventListener("change",vt),E){var l=document.createElement("option");l.value=i,l.text=i,y==i&&(l.selected=!0),de.appendChild(l)}e.appendChild(de)}();nt(.6),ht(),function(){var e=document.getElementById("student-menu"),t=document.createElement("input");t.id="weight-slider",t.type="range",t.min="-0.2",t.max="2",t.step="0.2",t.value="0.6",t.style.width="130px",t.addEventListener("change",function(){U.strength(this.value),document.getElementById("weights-output").innerHTML="&nbsp;= "+this.value}),e.appendChild(t);var n=document.createTextNode(B.linksweight);e.appendChild(n),(n=document.createElement("label")).id="weights-output",n.innerHTML="&nbsp;= "+t.value,e.appendChild(n)}(),setTimeout(function(){R.force("charge",null).force("x",null).force("y",null)},500)}:function(){v=pe=!0,W=0,je=_e=Fe=null,Ue&&0!=Object.keys(b).length?(Mt(),nt(0),At()):(nt(.6),setTimeout(function(){Mt(),At()},500));U=null})()}(e)}});