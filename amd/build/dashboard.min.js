/*! moodle-block_behaviour v0.7.8 09-11-2021 */

!function(e){"function"==typeof define&&define.amd?define([],e):window.behaviourAnalyticsDashboard=e()}(function(){return function(e){var t,p=0,m={},g={};function f(e){var t,n,i=null,r=!1,l=document.createElement("div");l.id="question-list";var d,a=e.langstrings.likertscale.split(","),o=Object.keys(m).sort(function(e,t){return m[e].ordering>m[t].ordering});for(d in o){var s,r=!1,i=document.createElement("div");if(m[o[d]].edit?((s=document.createElement("input")).type="text",s.id="question-"+o[d],s.value=m[o[d]].qtext,r=!0,i.appendChild(s)):i.appendChild(document.createTextNode(m[o[d]].qtext)),i.appendChild(document.createElement("br")),"likert"==m[o[d]].qtype)for(var u in a)y(i,a[u]);else if(m[o[d]].edit)for(n in g[o[d]])!function(e,t,n,i){var r=document.createElement("input");r.type="radio",r.name="radio",r.addEventListener("click",v),r.style.marginLeft="5px";var l=document.createElement("input");l.type="text",l.id="option-"+n+"-"+i,l.value=t,l.appendChild(r),l.style.marginRight="10px",e.appendChild(l)}(i,g[o[d]][n],o[d],n);else for(n in g[o[d]])y(i,g[o[d]][n]);t=function(r,i,l,e){var t=document.createElement("div"),n=document.createTextNode(i);t.appendChild(n);n=document.createElement("img");n.src=r.uparrowurl,n.style.marginLeft="12px",1===i?n.style.opacity=0:n.addEventListener("click",function(){var e,t=0;for(e in m)if(m[e].ordering===i-1){m[e].ordering++,t=e;break}m[l].ordering--,f(r);var n={courseid:r.courseid,minusqid:l,plusqid:t};h(r.changequestionurl,n,r)});t.appendChild(n);n=document.createElement("img");n.src=r.uparrowurl,n.style.marginLeft="12px",n.style.transform="rotate(180deg)",i===Object.keys(m).length?n.style.opacity=0:n.addEventListener("click",function(){var e,t=0;for(e in m)if(m[e].ordering===i+1){m[e].ordering--,t=e;break}m[l].ordering++,f(r);var n={courseid:r.courseid,minusqid:t,plusqid:l};h(r.changequestionurl,n,r)});t.appendChild(n);n=document.createElement("button");{var d;n.style.marginLeft="12px",n.addEventListener("click",function(){var e={courseid:r.courseid,id:l,ordering:m[l].ordering,survey:p,deleted:!0};h(r.deletequrl,e,r),delete m[l],f(r)}),n.textContent=r.langstrings.delete,t.appendChild(n),e?((d=document.createElement("button")).style.marginLeft="12px",d.addEventListener("click",function(){delete m[l].edit;var e=document.getElementById("question-"+l);m[l].qtext=e.value;var t,n,i=[];for(n in g[l])t=document.getElementById("option-"+l+"-"+n).value,i[i.length]=t,g[l][n]=t;e={courseid:r.courseid,surveyid:p,questionid:l,qtype:m[l].qtype,qtext:m[l].qtext,qorder:m[l].ordering,labels:i};h(r.questionurl,e,r),f(r)}),d.textContent=r.langstrings.save,t.appendChild(d)):((d=document.createElement("button")).style.marginLeft="12px",d.addEventListener("click",function(){m[l].edit=!0,f(r)}),d.textContent=r.langstrings.edit,t.appendChild(d))}return t}(e,m[o[d]].ordering,o[d],r),l.appendChild(t),l.appendChild(i)}var c=document.getElementById("question-list");c?document.getElementById("survey-questions").replaceChild(l,c):document.getElementById("survey-questions").appendChild(l)}function y(e,t){var n=document.createElement("input");n.type="radio",n.name="radio",n.addEventListener("click",v),n.style.marginLeft="5px";var i=document.createElement("label");i.appendChild(document.createTextNode(t)),i.appendChild(n),i.style.marginRight="10px",e.appendChild(i)}function v(){this.checked=!1}function o(e){var t=document.getElementById("new-survey"),n=document.createElement("p");n.style.color="red",n.appendChild(document.createTextNode(e)),n.appendChild(document.createElement("br")),t.appendChild(n),setTimeout(function(){t.removeChild(n)},2e3)}function h(e,i,r){var t=new XMLHttpRequest;t.open("POST",e),t.setRequestHeader("Content-type","application/x-www-form-urlencoded"),t.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(i.title)p=parseInt(this.responseText);else if(i.deleted){for(var e in m)m[e].ordering>i.ordering&&m[e].ordering--;f(r)}else if(i.surveyid){var t,n=parseInt(this.responseText);for(t in m[n]=i,m[n].ordering=i.qorder,g[n]=[],i.labels)g[n][t]=i.labels[t];f(r)}},t.send("data="+JSON.stringify(i)+"&sesskey="+M.cfg.sesskey)}function b(e,t,n){var i,r,l={};for(i in e)l[e[i]]=1;for(r in t)l[t[r]]=1;return(n/Object.keys(l).length*100).toFixed(0)}function x(n,e,i,r){for(var t=window.dataDrivenDocs,l=100+25*n.length,d=0,a=20,o=30,s=140,u=i?["#003f5c","#bc5090","#ffa600"]:["#488f31","#489a68","#78ab63","#a8ba61","#dac767","#dfa850","#e18745","#de6347","#de425b"],c=[],p=n.length-1;0<=p;p--)c[c.length]=n[p];var m,g=0;for(m in n=c)"system"==n[m].type&&(g+=n[m].memberCount);var f=t.scaleOrdinal().domain(n).range(u),y=t.scaleBand().domain(t.range(n.length)).range([l-o,d]).padding(.1),v=t.scaleLinear().domain([0,g]).range([s,800-a]),e=t.select(e).append("svg").attr("viewBox",[0,0,800,l]).attr("id","graph-svg");e.selectAll(".bar").data(n).enter().append("g").append("rect").attr("class","bar").attr("id",function(e){return e.type+"-"+e.cluster}).attr("fill",function(e,t){return f(t)}).attr("y",function(e,t){return y(t)}).attr("x",function(){return v(0)}).attr("width",function(e){return v(e.memberCount)-v(0)}).attr("height",y.bandwidth()).append("title").text(function(e){return e.percent?e.percent+"% - "+e.members:e.members}).style("display","none").on("mouseover",function(e){t.select("#"+e.type+"-"+e.cluster).style("dislpay","block")}).on("mouseout",function(e){t.select("#"+e.type+"-"+e.cluster).style("dislpay","none")}),e.append("g").call(function(e){e.attr("transform","translate(0,"+(l-o)+")").call(t.axisBottom(v)).selectAll("text").style("font-size","2.5em")}),e.append("g").call(function(e){e.attr("transform","translate("+s+",0)").call(t.axisLeft(y).tickFormat(function(e){var t=r.cluster;return(t=i?"system"==n[e].type?r.system:"manual"==n[e].type?r.manual:r.diff:t)+" "+n[e].cluster}).tickSizeOuter(0)).selectAll("text").style("font-size","2.5em")})}((t=e).newsurvey||t.managesurvey?function(e){var t,n=document.getElementById("new-survey");if(e.newsurvey)(t=document.createElement("input")).type="text",t.id="survey-title",t.placeholder=e.langstrings.surveytitle,n.appendChild(t),n.appendChild(document.createElement("br"));else{for(var i in(t=document.createElement("h3")).textContent=e.survey.title,n.appendChild(t),p=e.survey.id,e.questions)for(var r in m[i]=e.questions[i],m[i].ordering=parseInt(m[i].ordering),g[i]={},e.qoptions[i])g[i][r]=e.qoptions[i][r];f(e)}var l=document.createElement("button");l.textContent=e.langstrings.addquestion,e.title=t,e.div=n,(e.addQ=l).addEventListener("click",function(e){if("text"!=e.title.type||""!=e.title.value){var t;0===p&&(h(e.surveyurl,{courseid:e.courseid,title:e.title.value},!0),(t=document.createElement("h3")).textContent=e.title.value,e.div.replaceChild(t,e.title));var n=["likert","binary"],i=document.createElement("select");i.id="qtype-select",e.qtype=i;var r,l=document.createElement("option");for(r in l.text=e.langstrings.qtype,l.disabled=!0,l.hidden=!0,l.selected=!0,i.appendChild(l),n)(l=document.createElement("option")).text=n[r],l.value=n[r],i.appendChild(l);i.addEventListener("change",function(e){document.getElementById("question-div")&&e.div.removeChild(document.getElementById("question-div"));var t=document.createElement("div");t.id="question-div";var n=document.createElement("textarea");n.id="qtext",n.placeholder=e.langstrings.qtext,e.qText=n,t.appendChild(n),t.appendChild(document.createElement("br"));var i=null,r=null,n=e.qtype.options[e.qtype.selectedIndex].value;if("likert"==n){var l,d=e.langstrings.likertscale.split(",");for(l in d)y(t,d[l])}else if("binary"==n)for(var a=0;a<2;a++)(i=document.createElement("input")).type="radio",i.name="radio",i.style.marginLeft="5px",i.style.marginRight="10px",i.addEventListener("click",v),(r=document.createElement("input")).type="text",r.id="text-label-"+a,r.placeholder="Option "+(a+1),t.appendChild(r),t.appendChild(i);n=document.createElement("button");n.id="savequestion",n.textContent="Save",n.addEventListener("click",function(e){var t=e.qtype.options[e.qtype.selectedIndex].value;if(""!=e.qText.value){if("binary"==t)for(var n=0;n<2;n++)if(""==document.getElementById("text-label-"+n).value)return void o(e.langstrings.addopterr);document.getElementById("questions-title").style.display="block";var i=[];if("binary"==t)for(var r=0,l=null;r<2;r++)l=document.getElementById("text-label-"+r),i[i.length]=l.value;t={courseid:e.courseid,surveyid:p,qtype:t,qtext:e.qText.value,qorder:Object.keys(m).length+1,labels:i};h(e.questionurl,t,e),e.div.removeChild(document.getElementById("question-div")),e.div.removeChild(e.qtype),e.addQ.style.display="block"}else o(e.langstrings.addqerr)}.bind(this,e)),t.appendChild(document.createElement("br")),t.appendChild(n),e.div.appendChild(t)}.bind(this,e)),i.appendChild(document.createElement("br")),e.div.appendChild(i),e.addQ.style.display="none"}else o(e.langstrings.surveytitleerr)}.bind(this,e)),n.appendChild(l),n.appendChild(document.createElement("br"));n=document.getElementById("questions-title");n.style.display=0<Object.keys(e.questions).length?"block":"none",n.appendChild(document.createTextNode(e.langstrings.questionstitle))}:function(e){var t=e.membermap,n=[],i=[],r=[],l=[],d=null,a=null,o=null,s=null,u=null,c=null;if(e.iteration)for(o in t)for(d in t[o])for(a in t[o][d])for(var p in t[o][d][a]){for(s in n=[],t[o][d][a][p])if(r=t[o][d][a][p][s][0].split(", "),l=t[o][d][a][p][s][1].split(", "),n[n.length]={members:t[o][d][a][p][s][0],memberCount:r.length,cluster:s,type:"system"},0<t[o][d][a][p][s][1].length){for(u in n[n.length]={members:t[o][d][a][p][s][1],memberCount:l.length,cluster:s,type:"manual"},i=[],r)-1===l.indexOf(r[u])&&(i[i.length]=r[u]);for(c in l)-1===r.indexOf(l[c])&&(i[i.length]=l[c]);n[n.length]={members:i.toString(),memberCount:i.length,cluster:s,type:"diff",percent:b(r,l,i.length)}}x(n,"#pie"+a+"-"+p,3*t[o][d][a][p].length==n.length,e.langstrings)}else for(o in t)for(d in t[o])for(a in t[o][d]){for(s in n=[],t[o][d][a])if(r=t[o][d][a][s][0].split(", "),l=t[o][d][a][s][1].split(", "),n[n.length]={members:t[o][d][a][s][0],memberCount:r.length,cluster:s,type:"system"},0<t[o][d][a][s][1].length){for(u in n[n.length]={members:t[o][d][a][s][1],memberCount:l.length,cluster:s,type:"manual"},i=[],r)-1===l.indexOf(r[u])&&(i[i.length]=r[u]);for(c in l)-1===r.indexOf(l[c])&&(i[i.length]=l[c]);n[n.length]={members:i.toString(),memberCount:i.length,cluster:s,type:"diff",percent:b(r,l,i.length)}}x(n,"#pie"+a,3*t[o][d][a].length==n.length,e.langstrings)}})(t)}});