/*! moodle-block_behaviour v0.7.8 27-10-2021 */
!function(a){"function"==typeof define&&define.amd?define([],a):window.behaviourAnalyticsDashboard=a()}(function(){return function(a){function b(a){a.newsurvey||a.managesurvey?g(a):n(a)}function c(a){var b,c=null,g=null,h=!1,i=document.createElement("div");i.id="question-list";var j=a.langstrings.likertscale.split(","),k=Object.keys(r).sort(function(a,b){return r[a].ordering>r[b].ordering});for(var l in k){if(h=!1,c=document.createElement("div"),r[k[l]].edit){var m=document.createElement("input");m.type="text",m.id="question-"+k[l],m.value=r[k[l]].qtext,h=!0,c.appendChild(m)}else c.appendChild(document.createTextNode(r[k[l]].qtext));if(c.appendChild(document.createElement("br")),"likert"==r[k[l]].qtype)for(var n in j)d(c,j[n]);else if(r[k[l]].edit)for(b in s[k[l]])e(c,s[k[l]][b],k[l],b);else for(b in s[k[l]])d(c,s[k[l]][b]);g=f(a,r[k[l]].ordering,k[l],h),i.appendChild(g),i.appendChild(c)}var o=document.getElementById("question-list");o?document.getElementById("survey-questions").replaceChild(i,o):document.getElementById("survey-questions").appendChild(i)}function d(a,b){var c=document.createElement("input");c.type="radio",c.name="radio",c.addEventListener("click",i),c.style.marginLeft="5px";var d=document.createElement("label");d.appendChild(document.createTextNode(b)),d.appendChild(c),d.style.marginRight="10px",a.appendChild(d)}function e(a,b,c,d){var e=document.createElement("input");e.type="radio",e.name="radio",e.addEventListener("click",i),e.style.marginLeft="5px";var f=document.createElement("input");f.type="text",f.id="option-"+c+"-"+d,f.value=b,f.appendChild(e),f.style.marginRight="10px",a.appendChild(f)}function f(a,b,d,e){var f=document.createElement("div"),g=document.createTextNode(b);f.appendChild(g);var h=document.createElement("img");h.src=a.uparrowurl,h.style.marginLeft="12px",1===b?h.style.opacity=0:h.addEventListener("click",function(){var e=0;for(var f in r)if(r[f].ordering===b-1){r[f].ordering++,e=f;break}r[d].ordering--,c(a);var g={courseid:a.courseid,minusqid:d,plusqid:e};m(a.changequestionurl,g,a)}),f.appendChild(h);var i=document.createElement("img");i.src=a.uparrowurl,i.style.marginLeft="12px",i.style.transform="rotate(180deg)",b===Object.keys(r).length?i.style.opacity=0:i.addEventListener("click",function(){var e=0;for(var f in r)if(r[f].ordering===b+1){r[f].ordering--,e=f;break}r[d].ordering++,c(a);var g={courseid:a.courseid,minusqid:e,plusqid:d};m(a.changequestionurl,g,a)}),f.appendChild(i);var j=document.createElement("button");if(j.style.marginLeft="12px",j.addEventListener("click",function(){var b={courseid:a.courseid,id:d,ordering:r[d].ordering,survey:q,deleted:!0};m(a.deletequrl,b,a),delete r[d],c(a)}),j.textContent=a.langstrings.delete,f.appendChild(j),e){var k=document.createElement("button");k.style.marginLeft="12px",k.addEventListener("click",function(){delete r[d].edit;var b=document.getElementById("question-"+d);r[d].qtext=b.value;var e=[],f="";for(var g in s[d])f=document.getElementById("option-"+d+"-"+g).value,e[e.length]=f,s[d][g]=f;var h={courseid:a.courseid,surveyid:q,questionid:d,qtype:r[d].qtype,qtext:r[d].qtext,qorder:r[d].ordering,labels:e};m(a.questionurl,h,a),c(a)}),k.textContent=a.langstrings.save,f.appendChild(k)}else{var l=document.createElement("button");l.style.marginLeft="12px",l.addEventListener("click",function(){r[d].edit=!0,c(a)}),l.textContent=a.langstrings.edit,f.appendChild(l)}return f}function g(a){var b,d=document.getElementById("new-survey");if(a.newsurvey)b=document.createElement("input"),b.type="text",b.id="survey-title",b.placeholder=a.langstrings.surveytitle,d.appendChild(b),d.appendChild(document.createElement("br"));else{b=document.createElement("h3"),b.textContent=a.survey.title,d.appendChild(b),q=a.survey.id;for(var e in a.questions){r[e]=a.questions[e],r[e].ordering=parseInt(r[e].ordering),s[e]={};for(var f in a.qoptions[e])s[e][f]=a.qoptions[e][f]}c(a)}var g=document.createElement("button");g.textContent=a.langstrings.addquestion,a.title=b,a.div=d,a.addQ=g,g.addEventListener("click",h.bind(this,a)),d.appendChild(g),d.appendChild(document.createElement("br"));var i=document.getElementById("questions-title");i.style.display=Object.keys(a.questions).length>0?"block":"none",i.appendChild(document.createTextNode(a.langstrings.questionstitle))}function h(a){if("text"==a.title.type&&""==a.title.value)return void l(a.langstrings.surveytitleerr);if(0===q){m(a.surveyurl,{courseid:a.courseid,title:a.title.value},!0);var b=document.createElement("h3");b.textContent=a.title.value,a.div.replaceChild(b,a.title)}var c=["likert","binary"],d=document.createElement("select");d.id="qtype-select",a.qtype=d;var e=document.createElement("option");e.text=a.langstrings.qtype,e.disabled=!0,e.hidden=!0,e.selected=!0,d.appendChild(e);for(var f in c)e=document.createElement("option"),e.text=c[f],e.value=c[f],d.appendChild(e);d.addEventListener("change",j.bind(this,a)),d.appendChild(document.createElement("br")),a.div.appendChild(d),a.addQ.style.display="none"}function i(){this.checked=!1}function j(a){document.getElementById("question-div")&&a.div.removeChild(document.getElementById("question-div"));var b=document.createElement("div");b.id="question-div";var c=document.createElement("textarea");c.id="qtext",c.placeholder=a.langstrings.qtext,a.qText=c,b.appendChild(c),b.appendChild(document.createElement("br"));var e=null,f=null,g=a.qtype.options[a.qtype.selectedIndex].value;if("likert"==g){var h=a.langstrings.likertscale.split(",");for(var j in h)d(b,h[j])}else if("binary"==g)for(var l=0;l<2;l++)e=document.createElement("input"),e.type="radio",e.name="radio",e.style.marginLeft="5px",e.style.marginRight="10px",e.addEventListener("click",i),f=document.createElement("input"),f.type="text",f.id="text-label-"+l,f.placeholder="Option "+(l+1),b.appendChild(f),b.appendChild(e);var m=document.createElement("button");m.id="savequestion",m.textContent="Save",m.addEventListener("click",k.bind(this,a)),b.appendChild(document.createElement("br")),b.appendChild(m),a.div.appendChild(b)}function k(a){var b=a.qtype.options[a.qtype.selectedIndex].value;if(""==a.qText.value)return void l(a.langstrings.addqerr);if("binary"==b)for(var c=0;c<2;c++)if(""==document.getElementById("text-label-"+c).value)return void l(a.langstrings.addopterr);document.getElementById("questions-title").style.display="block";var d=[];if("binary"==b)for(var e=0,f=null;e<2;e++)f=document.getElementById("text-label-"+e),d[d.length]=f.value;var g={courseid:a.courseid,surveyid:q,qtype:b,qtext:a.qText.value,qorder:Object.keys(r).length+1,labels:d};m(a.questionurl,g,a),a.div.removeChild(document.getElementById("question-div")),a.div.removeChild(a.qtype),a.addQ.style.display="block"}function l(a){var b=document.getElementById("new-survey"),c=document.createElement("p");c.style.color="red",c.appendChild(document.createTextNode(a)),c.appendChild(document.createElement("br")),b.appendChild(c),setTimeout(function(){b.removeChild(c)},2e3)}function m(a,b,d){var e=new XMLHttpRequest;e.open("POST",a),e.setRequestHeader("Content-type","application/x-www-form-urlencoded"),e.onreadystatechange=function(){if(4==this.readyState&&200==this.status)if(b.title)q=parseInt(this.responseText);else if(b.deleted){for(var a in r)r[a].ordering>b.ordering&&r[a].ordering--;c(d)}else if(b.surveyid){var e=parseInt(this.responseText);r[e]=b,r[e].ordering=b.qorder,s[e]=[];for(var f in b.labels)s[e][f]=b.labels[f];c(d)}},e.send("data="+JSON.stringify(b)+"&sesskey="+M.cfg.sesskey)}function n(a){var b=a.membermap,c=[],d=[],e=[],f=[],g=null,h=null,i=null,j=null,k=null;if(a.iteration)for(g in b)for(h in b[g])for(var l in b[g][h]){c=[];for(i in b[g][h][l])if(e=b[g][h][l][i][0].split(", "),f=b[g][h][l][i][1].split(", "),c[c.length]={members:b[g][h][l][i][0],memberCount:e.length,cluster:i,type:"system"},b[g][h][l][i][1].length>0){c[c.length]={members:b[g][h][l][i][1],memberCount:f.length,cluster:i,type:"manual"},d=[];for(j in e)-1===f.indexOf(e[j])&&(d[d.length]=e[j]);for(k in f)-1===e.indexOf(f[k])&&(d[d.length]=f[k]);c[c.length]={members:d.toString(),memberCount:d.length,cluster:i,type:"diff",percent:o(e,f,d.length)}}p(c,"#pie"+h+"-"+l,3*b[g][h][l].length==c.length,a.langstrings)}else for(g in b)for(h in b[g]){c=[];for(i in b[g][h])if(e=b[g][h][i][0].split(", "),f=b[g][h][i][1].split(", "),c[c.length]={members:b[g][h][i][0],memberCount:e.length,cluster:i,type:"system"},b[g][h][i][1].length>0){c[c.length]={members:b[g][h][i][1],memberCount:f.length,cluster:i,type:"manual"},d=[];for(j in e)-1===f.indexOf(e[j])&&(d[d.length]=e[j]);for(k in f)-1===e.indexOf(f[k])&&(d[d.length]=f[k]);c[c.length]={members:d.toString(),memberCount:d.length,cluster:i,type:"diff",percent:o(e,f,d.length)}}p(c,"#pie"+h,3*b[g][h].length==c.length,a.langstrings)}}function o(a,b,c){var d={};for(var e in a)d[a[e]]=1;for(var f in b)d[b[f]]=1;return(c/Object.keys(d).length*100).toFixed(0)}function p(a,b,c,d){for(var e=window.dataDrivenDocs,f=800,g=100+25*a.length,h={top:0,right:20,bottom:30,left:140},i=c?["#003f5c","#bc5090","#ffa600"]:["#488f31","#489a68","#78ab63","#a8ba61","#dac767","#dfa850","#e18745","#de6347","#de425b"],j=[],k=a.length-1;k>=0;k--)j[j.length]=a[k];a=j;var l=0;for(var m in a)"system"==a[m].type&&(l+=a[m].memberCount);var n=e.scaleOrdinal().domain(a).range(i),o=e.scaleBand().domain(e.range(a.length)).range([g-h.bottom,h.top]).padding(.1),p=e.scaleLinear().domain([0,l]).range([h.left,f-h.right]),q=function(b){b.attr("transform","translate("+h.left+",0)").call(e.axisLeft(o).tickFormat(function(b){var e=d.cluster;return c&&(e="system"==a[b].type?d.system:"manual"==a[b].type?d.manual:d.diff),e+" "+a[b].cluster}).tickSizeOuter(0)).selectAll("text").style("font-size","2.5em")},r=function(a){a.attr("transform","translate(0,"+(g-h.bottom)+")").call(e.axisBottom(p)).selectAll("text").style("font-size","2.5em")},s=e.select(b).append("svg").attr("viewBox",[0,0,f,g]).attr("id","graph-svg");s.selectAll(".bar").data(a).enter().append("g").append("rect").attr("class","bar").attr("id",function(a){return a.type+"-"+a.cluster}).attr("fill",function(a,b){return n(b)}).attr("y",function(a,b){return o(b)}).attr("x",function(){return p(0)}).attr("width",function(a){return p(a.memberCount)-p(0)}).attr("height",o.bandwidth()).append("title").text(function(a){return a.percent?a.percent+"% - "+a.members:a.members}).style("display","none").on("mouseover",function(a){e.select("#"+a.type+"-"+a.cluster).style("dislpay","block")}).on("mouseout",function(a){e.select("#"+a.type+"-"+a.cluster).style("dislpay","none")}),s.append("g").call(r),s.append("g").call(q)}var q=0,r={},s={};b(a)}});